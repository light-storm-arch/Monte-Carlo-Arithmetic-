<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Planning Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.5.0/Recharts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body{margin:0;padding:0}
    .font-display{font-family:'Crimson Pro',serif}
    input[type="number"],input[type="text"]{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px 14px;color:white;width:100%;transition:all 0.2s}
    input[type="number"]:focus,input[type="text"]:focus{outline:none;border-color:#e8b059;box-shadow:0 0 0 3px rgba(232,176,89,0.2)}
    select{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px 14px;color:white;width:100%;transition:all 0.2s;cursor:pointer}
    select:focus{outline:none;border-color:#e8b059;box-shadow:0 0 0 3px rgba(232,176,89,0.2)}
    select option{background:#1e293b;color:white}
    input[type="range"]{-webkit-appearance:none;width:100%;height:8px;border-radius:4px;background:rgba(255,255,255,0.1)}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#e8b059;cursor:pointer}
    .checkbox-custom{appearance:none;width:18px;height:18px;border:2px solid rgba(255,255,255,0.3);border-radius:4px;cursor:pointer}
    .checkbox-custom:checked{background:#e8b059;border-color:#e8b059}
    .card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px}
    .card-accent{border-left:4px solid #e8b059}
    .btn-primary{background:linear-gradient(135deg,#e8b059 0%,#d4a04a 100%);color:#1a1a2e;font-weight:600;padding:14px 32px;border-radius:10px;border:none;cursor:pointer}
    .btn-primary:disabled{opacity:0.5;cursor:not-allowed}
    .btn-secondary{background:rgba(255,255,255,0.1);color:white;font-weight:500;padding:14px 32px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);cursor:pointer}
    .result-card{background:linear-gradient(135deg,rgba(232,176,89,0.15) 0%,rgba(232,176,89,0.05) 100%);border:1px solid rgba(232,176,89,0.3)}
    .guardrail-upper{background:linear-gradient(135deg,rgba(76,175,80,0.15) 0%,rgba(76,175,80,0.05) 100%);border:1px solid rgba(76,175,80,0.3)}
    .guardrail-lower{background:linear-gradient(135deg,rgba(255,152,0,0.15) 0%,rgba(255,152,0,0.05) 100%);border:1px solid rgba(255,152,0,0.3)}
    .data-table{width:100%;border-collapse:collapse}
    .data-table th{background:rgba(232,176,89,0.2);padding:12px 10px;text-align:right;font-weight:600;font-size:12px;text-transform:uppercase;color:white}
    .data-table th:first-child{text-align:left}
    .data-table td{padding:10px;text-align:right;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px;color:white}
    .data-table td:first-child{text-align:left}
    .loading-spinner{width:24px;height:24px;border:3px solid rgba(26,26,46,0.3);border-top-color:#1a1a2e;border-radius:50%;animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useCallback, useEffect } = React;

// =============================================================================
// CONSTANTS: Tax Tables
// =============================================================================
// 2026 Tax Brackets (will be inflated each year)
const TAX_BRACKETS_2026 = {
  single: [
    { min: 0, max: 12400, rate: 0.10 },
    { min: 12400, max: 50400, rate: 0.12 },
    { min: 50400, max: 105700, rate: 0.22 },
    { min: 105700, max: 201775, rate: 0.24 },
    { min: 201775, max: 256225, rate: 0.32 },
    { min: 256225, max: 640600, rate: 0.35 },
    { min: 640600, max: Infinity, rate: 0.37 }
  ],
  mfj: [
    { min: 0, max: 24800, rate: 0.10 },
    { min: 24800, max: 100800, rate: 0.12 },
    { min: 100800, max: 211400, rate: 0.22 },
    { min: 211400, max: 403550, rate: 0.24 },
    { min: 403550, max: 512450, rate: 0.32 },
    { min: 512450, max: 768700, rate: 0.35 },
    { min: 768700, max: Infinity, rate: 0.37 }
  ],
  hoh: [
    { min: 0, max: 17700, rate: 0.10 },
    { min: 17700, max: 67450, rate: 0.12 },
    { min: 67450, max: 105700, rate: 0.22 },
    { min: 105700, max: 201775, rate: 0.24 },
    { min: 201775, max: 256200, rate: 0.32 },
    { min: 256200, max: 640600, rate: 0.35 },
    { min: 640600, max: Infinity, rate: 0.37 }
  ]
};

// 2026 Capital Gains Brackets (0%, 15%, 20%)
const CAPITAL_GAINS_BRACKETS_2026 = {
  single: [
    { min: 0, max: 48350, rate: 0.00 },
    { min: 48350, max: 533400, rate: 0.15 },
    { min: 533400, max: Infinity, rate: 0.20 }
  ],
  mfj: [
    { min: 0, max: 96700, rate: 0.00 },
    { min: 96700, max: 600050, rate: 0.15 },
    { min: 600050, max: Infinity, rate: 0.20 }
  ],
  hoh: [
    { min: 0, max: 64750, rate: 0.00 },
    { min: 64750, max: 566700, rate: 0.15 },
    { min: 566700, max: Infinity, rate: 0.20 }
  ]
};

const STANDARD_DEDUCTION_2026 = { single: 16100, mfj: 32200, hoh: 24150 };

// =============================================================================
// CONSTANTS: RMD Tables
// =============================================================================
// IRS Uniform Lifetime Table for RMDs (SECURE 2.0 - starts at age 73)
const UNIFORM_LIFETIME_TABLE = {
  73: 26.5, 74: 25.5, 75: 24.6, 76: 23.7, 77: 22.9, 78: 22.0, 79: 21.1, 80: 20.2,
  81: 19.4, 82: 18.5, 83: 17.7, 84: 16.8, 85: 16.0, 86: 15.2, 87: 14.4, 88: 13.7,
  89: 12.9, 90: 12.2, 91: 11.5, 92: 10.8, 93: 10.1, 94: 9.5, 95: 8.9, 96: 8.4,
  97: 7.8, 98: 7.3, 99: 6.8, 100: 6.4, 101: 6.0, 102: 5.6, 103: 5.2, 104: 4.9,
  105: 4.6, 106: 4.3, 107: 4.1, 108: 3.9, 109: 3.7, 110: 3.5, 111: 3.4, 112: 3.3,
  113: 3.1, 114: 3.0, 115: 2.9, 116: 2.8, 117: 2.7, 118: 2.5, 119: 2.3, 120: 2.0
};

// =============================================================================
// UTILITIES: RMD & Tax Bracket Functions
// =============================================================================
// Calculate RMD for a given age and account balance
// rmdStartAge: 73 for birth years 1951-1959, 75 for birth year 1960+
const calculateRMD = (age, preTaxBalance, rmdStartAge = 73) => {
  if (age < rmdStartAge || preTaxBalance <= 0) return 0;
  const divisor = UNIFORM_LIFETIME_TABLE[Math.min(age, 120)] || 2.0;
  return preTaxBalance / divisor;
};

// Inflate tax brackets for a given year
const getInflatedBrackets = (filingStatus, baseInflation, yearsFromStart) => {
  const brackets = TAX_BRACKETS_2026[filingStatus];
  const factor = Math.pow(1 + baseInflation, yearsFromStart);
  return brackets.map(b => ({
    min: b.min * factor,
    max: b.max === Infinity ? Infinity : b.max * factor,
    rate: b.rate
  }));
};

const getInflatedCapGainsBrackets = (filingStatus, baseInflation, yearsFromStart) => {
  const brackets = CAPITAL_GAINS_BRACKETS_2026[filingStatus];
  const factor = Math.pow(1 + baseInflation, yearsFromStart);
  return brackets.map(b => ({
    min: b.min * factor,
    max: b.max === Infinity ? Infinity : b.max * factor,
    rate: b.rate
  }));
};

const getInflatedStandardDeduction = (filingStatus, baseInflation, yearsFromStart) => {
  return STANDARD_DEDUCTION_2026[filingStatus] * Math.pow(1 + baseInflation, yearsFromStart);
};

// Get top of 12% bracket (inflated)
const getTopOf12PercentBracket = (filingStatus, baseInflation, yearsFromStart) => {
  const brackets = getInflatedBrackets(filingStatus, baseInflation, yearsFromStart);
  const bracket12 = brackets.find(b => b.rate === 0.12);
  return bracket12 ? bracket12.max : 0;
};

// =============================================================================
// TAX CALCULATIONS: Federal, State, Capital Gains, Withdrawals
// =============================================================================
// Calculate federal tax on ordinary income
const calculateFederalTax = (taxableIncome, brackets) => {
  if (taxableIncome <= 0) return 0;
  let tax = 0;
  let remaining = taxableIncome;
  for (const bracket of brackets) {
    const bracketWidth = bracket.max - bracket.min;
    const taxableInBracket = Math.min(remaining, bracketWidth);
    if (taxableInBracket <= 0) break;
    tax += taxableInBracket * bracket.rate;
    remaining -= taxableInBracket;
  }
  return tax;
};

// Calculate capital gains tax based on total taxable income (ordinary + gains)
const calculateCapitalGainsTax = (capitalGains, ordinaryTaxableIncome, capGainsBrackets) => {
  if (capitalGains <= 0) return 0;
  
  // Capital gains are "stacked" on top of ordinary income for bracket purposes
  let tax = 0;
  let gainsRemaining = capitalGains;
  let incomeLevel = ordinaryTaxableIncome;
  
  for (const bracket of capGainsBrackets) {
    if (gainsRemaining <= 0) break;
    
    // How much room is left in this bracket?
    const bracketCeiling = bracket.max;
    const roomInBracket = Math.max(0, bracketCeiling - incomeLevel);
    
    if (roomInBracket > 0) {
      const gainsInBracket = Math.min(gainsRemaining, roomInBracket);
      tax += gainsInBracket * bracket.rate;
      gainsRemaining -= gainsInBracket;
      incomeLevel += gainsInBracket;
    }
  }
  
  return tax;
};

// Unified withdrawal calculation that handles income, withdrawals, and all taxes together
// This solves: grossWithdrawal + taxFreeIncome - totalTax = spendingNeed
// Where totalTax is calculated on: withdrawals + taxableIncome + socialSecurity + dividends + interest
const calculateUnifiedWithdrawal = (spendingNeed, totalIncome, taxParams) => {
  const {
    client1PreTax, client2PreTax, totalPreTax,
    client1Roth, client2Roth, totalRoth,
    totalTaxable, taxableBasis, stockAllocation,
    filingStatus, stateTaxRate, baseInflation, yearsFromStart,
    client1Age, client2Age, client1RmdAge, client2RmdAge,
    otherIncome, socialSecurityIncome, taxFreeIncome,
    cachedBrackets, cachedCapGainsBrackets, cachedDeduction, cachedTopOf12
  } = taxParams;

  const brackets = cachedBrackets || getInflatedBrackets(filingStatus, baseInflation, yearsFromStart);
  const capGainsBrackets = cachedCapGainsBrackets || getInflatedCapGainsBrackets(filingStatus, baseInflation, yearsFromStart);
  const standardDeduction = cachedDeduction || getInflatedStandardDeduction(filingStatus, baseInflation, yearsFromStart);
  const topOf12Bracket = cachedTopOf12 || getTopOf12PercentBracket(filingStatus, baseInflation, yearsFromStart);

  // Calculate RMDs (mandatory regardless of spending need)
  // Always calculate both - deceased spouse will have age=0 and balance=0, so RMD=0
  const client1RMD = calculateRMD(client1Age, client1PreTax, client1RmdAge || 73);
  const client2RMD = calculateRMD(client2Age, client2PreTax, client2RmdAge || 73);
  const totalRMD = client1RMD + client2RMD;
  
  // Calculate taxable account income (dividends and interest) - always generated
  const bondAllocation = 1 - stockAllocation;
  const qualifiedDividends = totalTaxable * stockAllocation * 0.01;
  const interestIncome = totalTaxable * bondAllocation * 0.04;
  
  // Gain ratio for taxable withdrawals
  const taxableGainRatio = totalTaxable > 0 ? Math.max(0, (totalTaxable - taxableBasis) / totalTaxable) : 0;
  
  const ssIncome = socialSecurityIncome || 0;
  const taxableInc = otherIncome || 0;
  const taxFreeInc = taxFreeIncome || 0;
  
  // The equation we need to solve:
  // grossWithdrawal + totalIncome - totalTax(grossWithdrawal, income) = spendingNeed
  // Rearranged: grossWithdrawal - totalTax = spendingNeed - totalIncome
  // But tax-free income doesn't get taxed, so:
  // grossWithdrawal + taxFreeInc + (taxableInc + ssIncome - tax on those) - tax on withdrawal = spendingNeed
  
  // Binary search to find the right gross withdrawal amount
  // We're looking for grossWithdrawal where:
  // grossWithdrawal - taxOnWithdrawals = spendingNeed - (taxFreeInc + taxableInc + ssIncome - taxOnIncome)
  // But since taxes interact, we solve iteratively
  
  let low = 0;
  let high = Math.max(spendingNeed * 3, totalRMD * 2, 1);
  
  let result = null;
  
  for (let iter = 0; iter < 20; iter++) {
    const testGross = (low + high) / 2;
    
    // Calculate everything with this gross withdrawal amount
    const calcResult = calculateWithdrawalAllocation(
      testGross, totalRMD, client1RMD, client2RMD,
      totalPreTax, totalRoth, totalTaxable, taxableBasis, taxableGainRatio,
      qualifiedDividends, interestIncome, taxableInc, ssIncome, filingStatus,
      standardDeduction, topOf12Bracket, brackets, capGainsBrackets, stateTaxRate
    );
    
    // Total cash available = gross withdrawal + tax-free income + taxable income + SS income
    // Total cash needed for taxes and spending = totalTax + spendingNeed
    // Net position = (grossWithdrawal + totalIncome) - totalTax - spendingNeed
    // We want this to be 0 (or slightly positive for excess savings)
    
    const totalCashIn = calcResult.grossWithdrawal + totalIncome;
    const totalCashOut = calcResult.totalTax + spendingNeed;
    const netPosition = totalCashIn - totalCashOut;
    
    // If we have more cash than needed, we're withdrawing too much (or have excess to save)
    // If we have less cash than needed, we need to withdraw more
    
    if (Math.abs(netPosition) < 50) {
      result = calcResult;
      break;
    }
    
    if (netPosition < 0) {
      // Need more cash - increase withdrawal
      low = testGross;
    } else {
      // Have excess cash - decrease withdrawal (unless we hit RMD floor)
      high = testGross;
    }
  }
  
  // Final calculation if not converged
  if (!result) {
    const testGross = (low + high) / 2;
    result = calculateWithdrawalAllocation(
      testGross, totalRMD, client1RMD, client2RMD,
      totalPreTax, totalRoth, totalTaxable, taxableBasis, taxableGainRatio,
      qualifiedDividends, interestIncome, taxableInc, ssIncome, filingStatus,
      standardDeduction, topOf12Bracket, brackets, capGainsBrackets, stateTaxRate
    );
  }
  
  // Calculate net income and excess
  // Net income = totalIncome - taxes attributable to income (approximated)
  // For simplicity, we'll calculate: if totalIncome > spendingNeed after all taxes, there's excess
  const totalCashIn = result.grossWithdrawal + totalIncome;
  const netAfterTax = totalCashIn - result.totalTax;
  // Filter out tiny amounts (<$100) as binary search convergence noise
  const rawExcess = netAfterTax - spendingNeed;
  const excessIncome = rawExcess > 100 ? rawExcess : 0;
  
  // Net income is approximately: income that remains after paying taxes on it
  // Since taxes are unified, we approximate by the portion of income vs total
  const incomeShare = totalIncome > 0 ? totalIncome / (totalIncome + result.grossWithdrawal + 0.01) : 0;
  const taxOnIncome = result.totalTax * incomeShare;
  const netIncome = totalIncome - taxOnIncome;
  
  return {
    ...result,
    client1RMD,
    client2RMD,
    totalRMD,
    qualifiedDividends,
    interestIncome,
    otherIncome: taxableInc,
    netIncome,
    excessIncome
  };
};

// Main withdrawal calculation with RMDs and bracket-filling optimization
const calculateOptimizedWithdrawal = (targetAfterTax, accountBalances, taxParams) => {
  const {
    client1PreTax, client2PreTax, totalPreTax,
    client1Roth, client2Roth, totalRoth,
    totalTaxable, taxableBasis, stockAllocation,
    filingStatus, stateTaxRate, baseInflation, yearsFromStart,
    client1Age, client2Age, client1RmdAge, client2RmdAge,
    otherIncome, socialSecurityIncome,
    // Cached values (optional - for performance)
    cachedBrackets, cachedCapGainsBrackets, cachedDeduction, cachedTopOf12
  } = taxParams;

  // Use cached values if provided, otherwise calculate
  const brackets = cachedBrackets || getInflatedBrackets(filingStatus, baseInflation, yearsFromStart);
  const capGainsBrackets = cachedCapGainsBrackets || getInflatedCapGainsBrackets(filingStatus, baseInflation, yearsFromStart);
  const standardDeduction = cachedDeduction || getInflatedStandardDeduction(filingStatus, baseInflation, yearsFromStart);
  const topOf12Bracket = cachedTopOf12 || getTopOf12PercentBracket(filingStatus, baseInflation, yearsFromStart);

  // Step 1: Calculate RMDs (mandatory pre-tax withdrawals)
  // Always calculate both - deceased spouse will have age=0 and balance=0, so RMD=0
  const client1RMD = calculateRMD(client1Age, client1PreTax, client1RmdAge || 73);
  const client2RMD = calculateRMD(client2Age, client2PreTax, client2RmdAge || 73);
  const totalRMD = client1RMD + client2RMD;
  
  // Step 2: Calculate taxable account income (dividends and interest)
  const bondAllocation = 1 - stockAllocation;
  const qualifiedDividends = totalTaxable * stockAllocation * 0.01; // 1% dividend yield - taxed as cap gains
  const interestIncome = totalTaxable * bondAllocation * 0.04; // 4% interest - taxed as ordinary income
  
  // Step 3: Calculate gain ratio for taxable withdrawals
  const taxableGainRatio = totalTaxable > 0 ? Math.max(0, (totalTaxable - taxableBasis) / totalTaxable) : 0;
  
  // Social Security income (will be used in calculateWithdrawalAllocation)
  const ssIncome = socialSecurityIncome || 0;
  
  // Binary search to find the right withdrawal amounts
  // We need to solve for: grossWithdrawal such that afterTax = targetAfterTax
  
  let low = 0;
  let high = Math.max(targetAfterTax * 3, 1); // Ensure at least some range for tax calculation
  
  let result = null;
  
  // Special case: if targetAfterTax is 0 but we have taxable income, just calculate taxes with no withdrawals
  if (targetAfterTax === 0) {
    result = calculateWithdrawalAllocation(
      0, totalRMD, client1RMD, client2RMD,
      totalPreTax, totalRoth, totalTaxable, taxableBasis, taxableGainRatio,
      qualifiedDividends, interestIncome, otherIncome, ssIncome, filingStatus,
      standardDeduction, topOf12Bracket, brackets, capGainsBrackets, stateTaxRate
    );
  } else {
    for (let iter = 0; iter < 20; iter++) {
      const testGross = (low + high) / 2;
      
      // Calculate withdrawals using bracket-filling strategy
      const withdrawalResult = calculateWithdrawalAllocation(
        testGross, totalRMD, client1RMD, client2RMD,
        totalPreTax, totalRoth, totalTaxable, taxableBasis, taxableGainRatio,
        qualifiedDividends, interestIncome, otherIncome, ssIncome, filingStatus,
        standardDeduction, topOf12Bracket, brackets, capGainsBrackets, stateTaxRate
      );
      
      if (Math.abs(withdrawalResult.afterTax - targetAfterTax) < 50) {
        result = withdrawalResult;
        break;
      }
      
      if (withdrawalResult.afterTax < targetAfterTax) {
        low = testGross;
      } else {
        high = testGross;
      }
    }
    
    // Final calculation if not converged
    if (!result) {
      const testGross = (low + high) / 2;
      result = calculateWithdrawalAllocation(
        testGross, totalRMD, client1RMD, client2RMD,
        totalPreTax, totalRoth, totalTaxable, taxableBasis, taxableGainRatio,
        qualifiedDividends, interestIncome, otherIncome, ssIncome, filingStatus,
        standardDeduction, topOf12Bracket, brackets, capGainsBrackets, stateTaxRate
      );
    }
  }
  
  return {
    ...result,
    client1RMD,
    client2RMD,
    totalRMD,
    qualifiedDividends,
    interestIncome,
    otherIncome
  };
};

// Helper function to calculate withdrawal allocation and taxes
const calculateWithdrawalAllocation = (
  grossWithdrawal, totalRMD, client1RMD, client2RMD,
  totalPreTax, totalRoth, totalTaxable, taxableBasis, taxableGainRatio,
  qualifiedDividends, interestIncome, otherIncome, socialSecurityIncome, filingStatus,
  standardDeduction, topOf12Bracket, brackets, capGainsBrackets, stateTaxRate
) => {
  // Start with mandatory RMDs
  let fromPreTax = Math.min(totalRMD, totalPreTax);
  let fromTaxable = 0;
  let fromRoth = 0;
  let remainingNeed = grossWithdrawal - fromPreTax;
  
  // Available balances after RMDs
  let availablePreTax = totalPreTax - fromPreTax;
  let availableTaxable = totalTaxable;
  let availableRoth = totalRoth;
  
  if (remainingNeed > 0) {
    // Bracket-filling strategy:
    // 1. Calculate ordinary income so far (RMDs + interest + other income)
    const ordinaryIncomeSoFar = fromPreTax + interestIncome + otherIncome;
    
    // 2. How much room left in 12% bracket?
    const roomIn12Bracket = Math.max(0, topOf12Bracket - (ordinaryIncomeSoFar - standardDeduction));
    
    // 3. Fill 12% bracket with additional pre-tax withdrawals
    const additionalPreTaxFor12 = Math.min(roomIn12Bracket, availablePreTax, remainingNeed);
    if (additionalPreTaxFor12 > 0) {
      fromPreTax += additionalPreTaxFor12;
      availablePreTax -= additionalPreTaxFor12;
      remainingNeed -= additionalPreTaxFor12;
    }
    
    // 4. Take from taxable account (capital gains may be at 0% or 15%)
    if (remainingNeed > 0) {
      const fromTaxableNow = Math.min(remainingNeed, availableTaxable);
      fromTaxable += fromTaxableNow;
      availableTaxable -= fromTaxableNow;
      remainingNeed -= fromTaxableNow;
    }
    
    // 5. Additional pre-tax if needed (will be in 22%+ brackets)
    if (remainingNeed > 0) {
      const additionalPreTax = Math.min(remainingNeed, availablePreTax);
      fromPreTax += additionalPreTax;
      availablePreTax -= additionalPreTax;
      remainingNeed -= additionalPreTax;
    }
    
    // 6. Roth last (tax-free, preserve growth)
    if (remainingNeed > 0) {
      fromRoth = Math.min(remainingNeed, availableRoth);
      remainingNeed -= fromRoth;
    }
  }
  
  // Calculate Social Security taxable portion
  // Provisional income = AGI + tax-exempt interest + 50% of SS benefits
  // For simplicity, we use: pre-tax withdrawals + other income + interest + 50% SS
  const ssIncome = socialSecurityIncome || 0;
  let taxableSocialSecurity = 0;
  let provisionalIncome = 0;
  
  // Thresholds depend on filing status
  const ssBaseThreshold = filingStatus === 'mfj' ? 32000 : 25000;
  const ssUpperThreshold = filingStatus === 'mfj' ? 44000 : 34000;
  
  if (ssIncome > 0) {
    provisionalIncome = fromPreTax + otherIncome + interestIncome + qualifiedDividends + (ssIncome * 0.5);
    
    if (provisionalIncome > ssUpperThreshold) {
      // Up to 85% taxable
      taxableSocialSecurity = Math.min(ssIncome * 0.85, 
        0.85 * (provisionalIncome - ssUpperThreshold) + 0.5 * Math.min(provisionalIncome - ssBaseThreshold, ssUpperThreshold - ssBaseThreshold));
    } else if (provisionalIncome > ssBaseThreshold) {
      // Up to 50% taxable
      taxableSocialSecurity = Math.min(ssIncome * 0.5, 0.5 * (provisionalIncome - ssBaseThreshold));
    }
    // Ensure we don't exceed 85% of SS
    taxableSocialSecurity = Math.min(taxableSocialSecurity, ssIncome * 0.85);
  }
  
  // Calculate taxes
  // Ordinary income = pre-tax withdrawals + interest income + other income + taxable SS
  const ordinaryIncome = fromPreTax + interestIncome + otherIncome + taxableSocialSecurity;
  const taxableOrdinaryIncome = Math.max(0, ordinaryIncome - standardDeduction);

  // Capital gains = taxable withdrawal gains + qualified dividends
  const taxableWithdrawalGains = fromTaxable * taxableGainRatio;
  const totalCapitalGains = taxableWithdrawalGains + qualifiedDividends;

  // Federal taxes
  const federalOrdinaryTax = calculateFederalTax(taxableOrdinaryIncome, brackets);
  const federalCapGainsTax = calculateCapitalGainsTax(totalCapitalGains, taxableOrdinaryIncome, capGainsBrackets);

  // NIIT (Net Investment Income Tax) - 3.8% on investment income for high earners
  // Applies to lesser of: net investment income OR (MAGI - threshold)
  // Thresholds: $200k single/HoH, $250k MFJ (not inflation-adjusted)
  const niitThreshold = filingStatus === 'mfj' ? 250000 : 200000;
  const netInvestmentIncome = interestIncome + qualifiedDividends + taxableWithdrawalGains;
  // MAGI for NIIT is approximately AGI (gross income before deductions)
  const magiForNiit = ordinaryIncome + totalCapitalGains;
  const magiOverThreshold = Math.max(0, magiForNiit - niitThreshold);
  const niitTax = 0.038 * Math.min(netInvestmentIncome, magiOverThreshold);

  const federalTax = federalOrdinaryTax + federalCapGainsTax + niitTax;

  // State tax (flat rate on taxable income after standard deduction + capital gains)
  const stateTax = (taxableOrdinaryIncome + totalCapitalGains) * stateTaxRate;

  const totalTax = federalTax + stateTax;
  const actualGrossWithdrawal = fromPreTax + fromTaxable + fromRoth;
  const afterTax = actualGrossWithdrawal - totalTax;
  
  // Calculate excess RMD (if RMD > spending need, excess reinvested to taxable)
  // Filter out tiny amounts (<$100) as rounding noise
  const excessRMD = Math.max(0, totalRMD - grossWithdrawal);
  // Guard against division by zero when actualGrossWithdrawal is 0
  const rawExcessRMDAfterTax = excessRMD > 0 && actualGrossWithdrawal > 0
    ? excessRMD - (excessRMD / actualGrossWithdrawal * totalTax)
    : 0;
  const excessRMDAfterTax = rawExcessRMDAfterTax > 100 ? rawExcessRMDAfterTax : 0;
  
  return {
    grossWithdrawal: actualGrossWithdrawal,
    fromPreTax,
    fromTaxable,
    fromRoth,
    totalTax,
    federalTax,
    federalOrdinaryTax,
    federalCapGainsTax,
    niitTax,
    stateTax,
    afterTax,
    taxableOrdinaryIncome,
    totalCapitalGains,
    excessRMDAfterTax,
    taxableSocialSecurity,
    provisionalIncome,
    ssBaseThreshold,
    ssUpperThreshold,
    otherIncome
  };
};

// Legacy function for compatibility - wraps new optimized function
const calculateGrossWithdrawal = (targetAfterTax, accounts, taxParams) => {
  const { preTax, roth, taxable, taxableBasis, stockAllocation, filingStatus, stateTaxRate, baseInflation, yearsFromStart, otherIncome, client1Age, client2Age, client1PreTax, client2PreTax } = taxParams;
  
  const result = calculateOptimizedWithdrawal(targetAfterTax, null, {
    client1PreTax: client1PreTax || preTax,
    client2PreTax: client2PreTax || 0,
    totalPreTax: preTax,
    client1Roth: roth,
    client2Roth: 0,
    totalRoth: roth,
    totalTaxable: taxable,
    taxableBasis,
    stockAllocation,
    filingStatus,
    stateTaxRate,
    baseInflation,
    yearsFromStart,
    client1Age: client1Age || 65,
    client2Age: client2Age || 65,
    otherIncome
  });
  
  return result;
};

// =============================================================================
// CONSTANTS: Asset Classes & Correlation Matrix
// =============================================================================
const ASSET_CLASSES = [
  'Cash', 'Short-term Bonds', 'Intermediate-term Bonds', 'Long-term Bonds',
  'Large Cap Value Stocks', 'Large Cap Growth Stocks', 'Mid Cap Stocks',
  'Small Cap Stocks', "Int'l Developed Stocks", "Int'l Emerging Stocks",
  'REITs', 'Commodities'
];
const ASSET_RETURNS = [0.0330, 0.0400, 0.0450, 0.0500, 0.0700, 0.0700, 0.0710, 0.0730, 0.0750, 0.0830, 0.0620, 0.0400]; // geometric (compound) returns - median compound return will equal these values
const ASSET_STDDEVS = [0.015, 0.04, 0.06, 0.10, 0.18, 0.19, 0.19, 0.21, 0.20, 0.26, 0.23, 0.22]; // simple return standard deviations (annualized std dev of simple returns)
const ASSET_CORR_MATRIX = [
  [1.00, 0.40, 0.10, 0.00,-0.05,-0.05,-0.10,-0.10, 0.00, 0.00,-0.10, 0.10],
  [0.40, 1.00, 0.40, 0.50, 0.00, 0.00, 0.00,-0.10, 0.20, 0.10, 0.10, 0.20],
  [0.10, 0.40, 1.00, 0.90, 0.35, 0.35, 0.00, 0.20, 0.40, 0.40, 0.30, 0.00],
  [0.00, 0.50, 0.90, 1.00, 0.20, 0.20, 0.20,-0.10, 0.00, 0.20, 0.25, 0.00],
  [-0.05, 0.00, 0.35, 0.20, 1.00, 0.95, 0.95, 0.90, 0.90, 0.80, 0.75, 0.40],
  [-0.05, 0.00, 0.35, 0.20, 0.95, 1.00, 0.95, 0.90, 0.90, 0.80, 0.75, 0.45],
  [-0.10, 0.00, 0.00, 0.20, 0.95, 0.95, 1.00, 0.95, 0.85, 0.80, 0.75, 0.45],
  [-0.10,-0.10, 0.20,-0.10, 0.90, 0.90, 0.95, 1.00, 0.80, 0.70, 0.75, 0.40],
  [0.00, 0.20, 0.40, 0.00, 0.90, 0.90, 0.85, 0.80, 1.00, 0.85, 0.50, 0.55],
  [0.00, 0.10, 0.40, 0.20, 0.80, 0.80, 0.80, 0.70, 0.85, 1.00, 0.60, 0.60],
  [-0.10, 0.10, 0.30, 0.25, 0.75, 0.75, 0.75, 0.75, 0.50, 0.60, 1.00, 0.45],
  [0.10, 0.20, 0.00, 0.00, 0.40, 0.45, 0.45, 0.40, 0.55, 0.60, 0.45, 1.00]
];
const NUM_ASSETS = ASSET_CLASSES.length;

// =============================================================================
// UTILITIES: Matrix Math & Return Generation
// =============================================================================
// Cholesky decomposition: returns lower triangular matrix L such that L*L^T = A
// Returns null if matrix is not positive-definite
const choleskyDecomposition = (matrix) => {
  const n = matrix.length;
  const L = Array.from({length: n}, () => new Array(n).fill(0));
  for (let i = 0; i < n; i++) {
    for (let j = 0; j <= i; j++) {
      let sum = 0;
      for (let k = 0; k < j; k++) sum += L[i][k] * L[j][k];
      if (i === j) {
        const diag = matrix[i][i] - sum;
        if (diag <= 0) return null; // Not positive-definite
        L[i][j] = Math.sqrt(diag);
      } else {
        L[i][j] = (matrix[i][j] - sum) / L[j][j];
      }
    }
  }
  return L;
};

// Ensure correlation matrix is symmetric and positive-definite
// 1) Symmetrize by averaging: S = (M + M^T) / 2
// 2) Spectral fix: clamp negative eigenvalues to small positive value
const ensurePositiveDefinite = (matrix) => {
  const n = matrix.length;
  // Step 1: Symmetrize
  const S = Array.from({length: n}, (_, i) => Array.from({length: n}, (_, j) => (matrix[i][j] + matrix[j][i]) / 2));
  // Try Cholesky on symmetrized matrix first
  const L = choleskyDecomposition(S);
  if (L) return S;
  // Step 2: Jacobi eigenvalue decomposition for symmetric matrix
  // Copy S into A for in-place decomposition
  const A = S.map(row => [...row]);
  const V = Array.from({length: n}, (_, i) => { const r = new Array(n).fill(0); r[i] = 1; return r; });
  for (let iter = 0; iter < 1000; iter++) {
    // Find largest off-diagonal element
    let maxVal = 0, p = 0, q = 1;
    for (let i = 0; i < n; i++) for (let j = i + 1; j < n; j++) {
      if (Math.abs(A[i][j]) > maxVal) { maxVal = Math.abs(A[i][j]); p = i; q = j; }
    }
    if (maxVal < 1e-12) break;
    // Compute rotation
    const denom = 2 * A[p][q];
    const theta = (A[q][q] - A[p][p]) / denom;
    const t = theta === 0 ? 1 : (theta > 0 ? 1 : -1) / (Math.abs(theta) + Math.sqrt(theta * theta + 1));
    const c = 1 / Math.sqrt(t * t + 1), s = t * c;
    // Apply rotation to A
    for (let i = 0; i < n; i++) {
      if (i !== p && i !== q) {
        const aip = A[i][p], aiq = A[i][q];
        A[i][p] = A[p][i] = c * aip - s * aiq;
        A[i][q] = A[q][i] = s * aip + c * aiq;
      }
    }
    const app = A[p][p], aqq = A[q][q], apq = A[p][q];
    A[p][p] = c * c * app - 2 * s * c * apq + s * s * aqq;
    A[q][q] = s * s * app + 2 * s * c * apq + c * c * aqq;
    A[p][q] = A[q][p] = 0;
    // Accumulate eigenvectors
    for (let i = 0; i < n; i++) {
      const vip = V[i][p], viq = V[i][q];
      V[i][p] = c * vip - s * viq;
      V[i][q] = s * vip + c * viq;
    }
  }
  // Eigenvalues are on diagonal of A, eigenvectors in columns of V
  const eigenvalues = A.map((row, i) => row[i]);
  // Clamp negative eigenvalues to small positive value
  const minEig = 1e-6;
  const clampedEigs = eigenvalues.map(e => Math.max(e, minEig));
  // Reconstruct: M_fixed = V * diag(clampedEigs) * V^T
  const result = Array.from({length: n}, () => new Array(n).fill(0));
  for (let i = 0; i < n; i++) for (let j = 0; j <= i; j++) {
    let val = 0;
    for (let k = 0; k < n; k++) val += V[i][k] * clampedEigs[k] * V[j][k];
    result[i][j] = result[j][i] = val;
  }
  // Normalize to correlation matrix (diagonal = 1)
  const diag = result.map((row, i) => Math.sqrt(row[i]));
  for (let i = 0; i < n; i++) for (let j = 0; j < n; j++) result[i][j] /= (diag[i] * diag[j]);
  return result;
};

// Pre-compute: fix correlation matrix then compute Cholesky factor (done once at load)
const ASSET_CORR_FIXED = ensurePositiveDefinite(ASSET_CORR_MATRIX);
const CHOLESKY_L = choleskyDecomposition(ASSET_CORR_FIXED);
if (!CHOLESKY_L) console.error('Failed to compute Cholesky decomposition of asset correlation matrix!');

// Log-normal return generator: ensures median compound return equals geometric mean
// Takes geometric (compound) mean and simple return standard deviation as inputs
// Internally converts simple std dev to log std dev for the lognormal model
// If z is provided, uses it directly; otherwise generates via Box-Muller
const generateReturn = (geometricMean, simpleStdDev, z) => {
  // Generate standard normal random number (Box-Muller) if not provided
  if (z === undefined) {
    // Guard against Math.random() returning exactly 0 (causes log(0) = -Infinity)
    const u1 = Math.random() || 1e-15, u2 = Math.random();
    z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
  }

  // Clamp z to ±5 standard deviations to prevent extreme outliers
  // (probability of |z| > 5 is ~0.00006%, essentially never happens naturally)
  z = Math.max(-5, Math.min(5, z));

  // Convert simple std dev to log std dev: σ_log = sqrt(ln(1 + (σ_simple / (1 + g))²))
  // This ensures the simple return distribution has the correct standard deviation
  const logVolatility = Math.sqrt(Math.log(1 + (simpleStdDev / (1 + geometricMean)) ** 2));

  // Convert geometric mean to log return mean: μ_log = ln(1 + g)
  // This ensures the median of (1 + R) equals (1 + g)
  const logMean = Math.log(1 + geometricMean);

  // Log return: normally distributed with mean μ_log and std dev σ_log
  const logReturn = logMean + logVolatility * z;

  // Convert to simple return: R = exp(log_return) - 1
  // Note: exp() ensures return > -100% (can't lose more than everything)
  return Math.exp(logReturn) - 1;
};

// =============================================================================
// UTILITIES: Formatting & Inflation
// =============================================================================
const formatCurrency = (v) => v == null || isNaN(v) ? '$0' : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);
const formatNumberWithCommas = (v) => v == null || v === '' ? '' : v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
const inflateValue = (base, rate, years) => base * Math.pow(1 + rate, years);

// Spending smile: calculates spending with variable inflation rates by phase
const inflateSpendingSmile = (base, baseInflation, currentYear, calYear, phase2Year, phase2Reduction, phase3Year, phase3Reduction) => {
  let spending = base;
  for (let y = currentYear + 1; y <= calYear; y++) {
    let rate = baseInflation;
    if (y >= phase3Year) {
      rate = baseInflation - phase3Reduction;
    } else if (y >= phase2Year) {
      rate = baseInflation - phase2Reduction;
    }
    spending *= (1 + rate);
  }
  return spending;
};

// =============================================================================
// REACT COMPONENTS: Input Controls
// =============================================================================
const CurrencyInput = ({ value, onChange }) => {
  const [display, setDisplay] = useState(formatNumberWithCommas(value));
  const handleChange = (e) => { const raw = e.target.value.replace(/,/g, ''); if (raw === '' || /^\d+$/.test(raw)) { setDisplay(formatNumberWithCommas(raw)); onChange(parseInt(raw, 10) || 0); } };
  useEffect(() => setDisplay(formatNumberWithCommas(value)), [value]);
  return <input type="text" value={display} onChange={handleChange} onBlur={() => setDisplay(formatNumberWithCommas(value))} />;
};

const PercentageInput = ({ value, onChange }) => {
  const [display, setDisplay] = useState(value.toString());
  const [isFocused, setIsFocused] = useState(false);
  const handleChange = (e) => { const v = e.target.value; if (v === '' || /^-?\d*\.?\d*$/.test(v)) { setDisplay(v); const n = parseFloat(v); if (!isNaN(n)) onChange(n); else if (v === '' || v === '-') onChange(0); } };
  useEffect(() => { if (!isFocused) { const n = parseFloat(display); if (isNaN(n) || n !== value) setDisplay(value.toString()); } }, [value, isFocused]);
  return <input type="text" value={display} onChange={handleChange} onFocus={() => setIsFocused(true)} onBlur={() => { setIsFocused(false); const n = parseFloat(display); setDisplay(isNaN(n) ? value.toString() : n.toString()); }} />;
};

const PercentageInputNullable = ({ value, onChange, placeholder }) => {
  const [display, setDisplay] = useState(value !== null ? (value * 100).toString() : '');
  const handleChange = (e) => { const v = e.target.value; if (v === '' || /^-?\d*\.?\d*$/.test(v)) { setDisplay(v); if (v === '') onChange(null); else { const n = parseFloat(v); if (!isNaN(n)) onChange(n / 100); } } };
  useEffect(() => { if (value === null && display !== '') setDisplay(''); else if (value !== null) { const n = parseFloat(display), exp = value * 100; if (isNaN(n) || Math.abs(n - exp) > 0.0001) setDisplay(exp.toString()); } }, [value]);
  return <input type="text" value={display} onChange={handleChange} onBlur={() => { if (display === '') onChange(null); else { const n = parseFloat(display); setDisplay(isNaN(n) ? (value !== null ? (value * 100).toString() : '') : n.toString()); } }} placeholder={placeholder} />;
};

// =============================================================================
// SIMULATION ENGINE: Monte Carlo & Guardrail Analysis
// =============================================================================
const runSimulation = (params, numSims) => {
  const { preTaxBalance, rothBalance, taxableBalance, taxableBasis, stockAllocation, filingStatus, stateTaxRate, planLength, assetWeights, choleskyL, baseSpending, survivorSpending, baseInflation, goals, incomeSources, currentYear, spendingMode, phase2Year, phase2Reduction, phase3Year, phase3Reduction, clientAge, client1Age, client2Age, client1RmdAge, client2RmdAge, client1PreTax, client2PreTax, client1Roth, client2Roth, client1PlanLength, client2PlanLength } = params;

  // Validate Cholesky decomposition was successful before running simulation
  if (!choleskyL) {
    throw new Error('Simulation failed: Cholesky decomposition of correlation matrix is null. The asset correlation matrix may not be positive-definite.');
  }

  const results = [], allPaths = [];
  const totalPortfolio = preTaxBalance + rothBalance + taxableBalance;
  
  // Determine when each client's plan ends (for MFJ survivor scenarios)
  const client1EndYear = client1PlanLength || planLength;
  const client2EndYear = filingStatus === 'mfj' ? (client2PlanLength || planLength) : planLength;
  
  // Pre-compute tax brackets and deductions for all years (cache for performance)
  // We need both MFJ and Single brackets for survivor scenarios
  const cachedBracketsMFJ = [];
  const cachedCapGainsBracketsMFJ = [];
  const cachedDeductionsMFJ = [];
  const cachedTopOf12BracketMFJ = [];
  const cachedBracketsSingle = [];
  const cachedCapGainsBracketsSingle = [];
  const cachedDeductionsSingle = [];
  const cachedTopOf12BracketSingle = [];
  
  for (let year = 0; year <= planLength; year++) {
    // Cache MFJ brackets (or current filing status if not MFJ)
    cachedBracketsMFJ[year] = getInflatedBrackets(filingStatus, baseInflation, year);
    cachedCapGainsBracketsMFJ[year] = getInflatedCapGainsBrackets(filingStatus, baseInflation, year);
    cachedDeductionsMFJ[year] = getInflatedStandardDeduction(filingStatus, baseInflation, year);
    cachedTopOf12BracketMFJ[year] = getTopOf12PercentBracket(filingStatus, baseInflation, year);
    
    // Cache Single brackets for survivor years (only needed for MFJ)
    if (filingStatus === 'mfj') {
      cachedBracketsSingle[year] = getInflatedBrackets('single', baseInflation, year);
      cachedCapGainsBracketsSingle[year] = getInflatedCapGainsBrackets('single', baseInflation, year);
      cachedDeductionsSingle[year] = getInflatedStandardDeduction('single', baseInflation, year);
      cachedTopOf12BracketSingle[year] = getTopOf12PercentBracket('single', baseInflation, year);
    }
  }
  
  // Use provided client-specific balances or fall back to totals (for single filers)
  const initialClient1PreTax = client1PreTax !== undefined ? client1PreTax : preTaxBalance;
  const initialClient2PreTax = client2PreTax !== undefined ? client2PreTax : 0;
  const initialClient1Roth = client1Roth !== undefined ? client1Roth : rothBalance;
  const initialClient2Roth = client2Roth !== undefined ? client2Roth : 0;
  
  // Pre-compute income and goals for each year (cache for performance)
  // For MFJ, we need different income values depending on survivor status
  const cachedGoals = [];
  const cachedIncomeBothAlive = [];  // { total, taxable, taxFree, socialSecurity }
  const cachedIncomeClient1Only = []; // Client 2 deceased
  const cachedIncomeClient2Only = []; // Client 1 deceased
  
  for (let year = 0; year <= planLength; year++) {
    const calYear = currentYear + year;
    
    // Cache goals for this year
    let yearGoals = 0;
    goals.forEach((g) => { 
      const start = g.startYear, end = g.continueThrough ? currentYear + planLength : g.endYear, inf = g.customInflation !== null ? g.customInflation : baseInflation;
      const type = g.goalType || 'onetime';
      if (type === 'onetime') {
        if (calYear === start) yearGoals += year === 0 ? g.amount : inflateValue(g.amount, inf, year);
      } else if (type === 'annual') {
        if (calYear >= start && calYear <= end) yearGoals += year === 0 ? g.amount : inflateValue(g.amount, inf, year);
      } else if (type === 'every') {
        const freq = g.frequency || 1;
        if (calYear >= start && calYear <= end && (calYear - start) % freq === 0) yearGoals += year === 0 ? g.amount : inflateValue(g.amount, inf, year);
      }
    });
    cachedGoals[year] = yearGoals;
    
    // Cache income for different survival scenarios
    const calculateIncomeForScenario = (client1Alive, client2Alive) => {
      let total = 0, taxable = 0, taxFree = 0, socialSecurity = 0;
      let client1SS = 0, client2SS = 0; // Track SS by owner for survivor benefits
      
      incomeSources.forEach((i) => { 
        const start = i.startYear, end = i.continueThrough ? currentYear + planLength : i.endYear, inf = i.customInflation !== null ? i.customInflation : baseInflation;
        const owner = i.owner || 'joint';
        
        if (calYear >= start && calYear <= end) {
          const amount = year === 0 ? i.amount : inflateValue(i.amount, inf, year);
          
          // Handle Social Security with survivor benefits
          if (i.isSocialSecurity && filingStatus === 'mfj') {
            if (owner === 'client1') client1SS += amount;
            else if (owner === 'client2') client2SS += amount;
            else { // joint SS (split evenly for survivor calc purposes)
              client1SS += amount / 2;
              client2SS += amount / 2;
            }
          } else {
            // Non-SS income: only include if owner is alive
            let ownerAlive = true;
            if (filingStatus === 'mfj') {
              if (owner === 'client1' && !client1Alive) ownerAlive = false;
              if (owner === 'client2' && !client2Alive) ownerAlive = false;
            }
            if (ownerAlive) {
              total += amount;
              if (i.isTaxFree) taxFree += amount;
              else taxable += amount;
            }
          }
        }
      });
      
      // Apply Social Security survivor benefit logic for MFJ
      if (filingStatus === 'mfj') {
        if (client1Alive && client2Alive) {
          // Both alive: each gets their own SS
          socialSecurity = client1SS + client2SS;
        } else if (client1Alive && !client2Alive) {
          // Client 2 deceased: Client 1 gets MAX of their own SS or Client 2's SS
          socialSecurity = Math.max(client1SS, client2SS);
        } else if (!client1Alive && client2Alive) {
          // Client 1 deceased: Client 2 gets MAX of their own SS or Client 1's SS
          socialSecurity = Math.max(client1SS, client2SS);
        }
        // If both deceased, no SS (socialSecurity stays 0)
      } else {
        // Single filer: just add up any SS income
        incomeSources.forEach((i) => {
          const start = i.startYear, end = i.continueThrough ? currentYear + planLength : i.endYear, inf = i.customInflation !== null ? i.customInflation : baseInflation;
          if (i.isSocialSecurity && calYear >= start && calYear <= end) {
            socialSecurity += year === 0 ? i.amount : inflateValue(i.amount, inf, year);
          }
        });
      }
      
      total += socialSecurity;
      return { total, taxable, taxFree, socialSecurity };
    };
    
    cachedIncomeBothAlive[year] = calculateIncomeForScenario(true, true);
    if (filingStatus === 'mfj') {
      cachedIncomeClient1Only[year] = calculateIncomeForScenario(true, false);
      cachedIncomeClient2Only[year] = calculateIncomeForScenario(false, true);
    }
  }
  
  for (let sim = 0; sim < numSims; sim++) {
    // Track accounts by owner for RMD calculations
    let c1PreTax = initialClient1PreTax, c2PreTax = initialClient2PreTax;
    let c1Roth = initialClient1Roth, c2Roth = initialClient2Roth;
    let taxable = taxableBalance, basis = taxableBasis;
    let success = true;
    
    // Track if we're in survivor mode (one spouse has passed)
    let survivorMode = false;
    let survivor = null; // 'client1' or 'client2'
    
    const preTaxTotal = () => c1PreTax + c2PreTax;
    const rothTotal = () => c1Roth + c2Roth;
    const totalBalance = () => preTaxTotal() + rothTotal() + taxable;
    
    const path = [totalBalance()];
    const detailedPath = [];
    
    for (let year = 0; year < planLength; year++) {
      const calYear = currentYear + year;
      const startBalance = totalBalance();

      // Check for survivor transition (MFJ only)
      // Year index is 0-based, so year 30 means we've completed 30 years
      const client1Alive = year < client1EndYear;
      const client2Alive = filingStatus === 'mfj' ? year < client2EndYear : false;

      // Determine current filing status for this year
      // IRS allows widow/widower to file MFJ for the year of death, then single thereafter
      let currentFilingStatus = filingStatus;
      let currentSurvivor = null;

      if (filingStatus === 'mfj') {
        if (!client1Alive && client2Alive) {
          // Client 1 has died, Client 2 is survivor
          // Use MFJ for year of death (first year not alive), single thereafter
          const deathYear = client1EndYear;
          currentFilingStatus = year === deathYear ? 'mfj' : 'single';
          currentSurvivor = 'client2';
          // Transfer Client 1's accounts to Client 2 on first year of survivor mode
          if (!survivorMode || survivor !== 'client2') {
            c2PreTax += c1PreTax;
            c2Roth += c1Roth;
            c1PreTax = 0;
            c1Roth = 0;
            survivorMode = true;
            survivor = 'client2';
          }
        } else if (client1Alive && !client2Alive) {
          // Client 2 has died, Client 1 is survivor
          // Use MFJ for year of death (first year not alive), single thereafter
          const deathYear = client2EndYear;
          currentFilingStatus = year === deathYear ? 'mfj' : 'single';
          currentSurvivor = 'client1';
          // Transfer Client 2's accounts to Client 1 on first year of survivor mode
          if (!survivorMode || survivor !== 'client1') {
            c1PreTax += c2PreTax;
            c1Roth += c2Roth;
            c2PreTax = 0;
            c2Roth = 0;
            survivorMode = true;
            survivor = 'client1';
          }
        }
      }
      
      // Select correct cached tax brackets based on current filing status
      const cachedBrackets = currentFilingStatus === 'single' && filingStatus === 'mfj' ? cachedBracketsSingle : cachedBracketsMFJ;
      const cachedCapGainsBrackets = currentFilingStatus === 'single' && filingStatus === 'mfj' ? cachedCapGainsBracketsSingle : cachedCapGainsBracketsMFJ;
      const cachedDeductions = currentFilingStatus === 'single' && filingStatus === 'mfj' ? cachedDeductionsSingle : cachedDeductionsMFJ;
      const cachedTopOf12Bracket = currentFilingStatus === 'single' && filingStatus === 'mfj' ? cachedTopOf12BracketSingle : cachedTopOf12BracketMFJ;
      
      // Calculate ages for RMD purposes (only for living clients)
      const c1Age = client1Alive ? (client1Age || clientAge) + year : 0;
      const c2Age = (filingStatus === 'mfj' && client2Alive) ? (client2Age || clientAge) + year : 0;
      
      // Calculate after-tax spending need
      // Use survivor spending when in survivor mode and survivorSpending is provided
      const effectiveBaseSpending = (survivorMode && survivorSpending != null) ? survivorSpending : baseSpending;
      let yearSpending;
      if (year === 0) {
        yearSpending = effectiveBaseSpending;
      } else if (spendingMode === 'smile') {
        yearSpending = inflateSpendingSmile(effectiveBaseSpending, baseInflation, currentYear, calYear, phase2Year, phase2Reduction, phase3Year, phase3Reduction);
      } else {
        yearSpending = inflateValue(effectiveBaseSpending, baseInflation, year);
      }
      
      // Use cached goals for this year
      const yearGoals = cachedGoals[year];
      
      // Use cached income based on survival status
      let cachedIncome;
      if (filingStatus === 'mfj') {
        if (client1Alive && client2Alive) cachedIncome = cachedIncomeBothAlive[year];
        else if (client1Alive) cachedIncome = cachedIncomeClient1Only[year];
        else cachedIncome = cachedIncomeClient2Only[year];
      } else {
        cachedIncome = cachedIncomeBothAlive[year];
      }
      const yearIncome = cachedIncome.total;
      const taxableIncome = cachedIncome.taxable;
      const taxFreeIncome = cachedIncome.taxFree;
      const socialSecurityIncome = cachedIncome.socialSecurity;
      
      // Generate 12 correlated asset class returns using Cholesky decomposition
      // Step 1: Generate independent standard normals via Box-Muller (need 12, so 6 pairs)
      const zIndep = new Array(NUM_ASSETS);
      for (let k = 0; k < NUM_ASSETS; k += 2) {
        // Guard against Math.random() returning exactly 0 (causes log(0) = -Infinity)
        const ua = Math.random() || 1e-15, ub = Math.random();
        const r = Math.sqrt(-2 * Math.log(ua));
        zIndep[k] = r * Math.cos(2 * Math.PI * ub);
        if (k + 1 < NUM_ASSETS) zIndep[k + 1] = r * Math.sin(2 * Math.PI * ub);
      }
      // Step 2: Multiply by Cholesky factor to get correlated normals
      const zCorr = new Array(NUM_ASSETS);
      for (let i = 0; i < NUM_ASSETS; i++) {
        let s = 0;
        for (let j = 0; j <= i; j++) s += choleskyL[i][j] * zIndep[j];
        zCorr[i] = s;
      }
      // Step 3: Per-asset rebalancing model
      // Each asset grows independently, then portfolio is rebalanced to target weights
      // This ensures each asset compounds at its geometric mean while capturing rebalancing effects

      // Start with notional $1 portfolio allocated by target weights
      const assetValues = new Array(NUM_ASSETS);
      for (let i = 0; i < NUM_ASSETS; i++) {
        assetValues[i] = assetWeights[i]; // Weight represents fraction of $1
      }

      // Apply individual asset returns (each asset grows/shrinks independently)
      for (let i = 0; i < NUM_ASSETS; i++) {
        if (assetValues[i] > 0) {
          const assetReturn = generateReturn(ASSET_RETURNS[i], ASSET_STDDEVS[i], zCorr[i]);
          assetValues[i] *= (1 + assetReturn);
        }
      }

      // Calculate portfolio return from total value change
      // Started at $1, so yearReturn = totalValue - 1
      const totalValue = assetValues.reduce((sum, v) => sum + v, 0);
      const yearReturn = totalValue - 1;

      // Rebalancing happens implicitly: next iteration starts fresh with target weights
      // This models annual rebalancing back to target allocation

      // =========================================================================
      // BEGINNING OF YEAR: Process all withdrawals and income BEFORE applying returns
      // This is more conservative and simpler than mid-year timing
      // =========================================================================

      // Calculate gross withdrawal needed for target after-tax spending
      // All taxes (on income, withdrawals, dividends, interest) are calculated together
      let grossWithdrawal = 0, fromTaxable = 0, fromPreTax = 0, fromRoth = 0, totalTax = 0, federalTax = 0, stateTax = 0;
      let client1RMD = 0, client2RMD = 0, totalRMD = 0, excessRMDAfterTax = 0;
      let netIncome = 0, excessIncome = 0;

      // Spending need (gross) - income will offset this in the withdrawal calculation
      const spendingNeed = yearSpending + yearGoals;
      
      // Calculate the after-tax spending target
      // If we have income, we need less from withdrawals, but taxes on income reduce its value
      // The unified calculation handles this by: targetAfterTax = spending - (income sources contribute to covering it)
      // We pass income to the withdrawal calc which figures out the net effect
      
      // For the unified approach: we need to withdraw enough so that:
      // grossWithdrawal + yearIncome - totalTax = spendingNeed
      // Rearranged: grossWithdrawal - totalTax = spendingNeed - yearIncome
      // But taxes depend on both income AND withdrawals, so we let the binary search solve it
      
      // The target is: how much after-tax cash do we need from withdrawals?
      // If income (before tax) exceeds spending, we still need to calculate taxes on that income
      // and any excess after-tax goes to savings
      
      const taxParams = {
        client1PreTax: c1PreTax,
        client2PreTax: c2PreTax,
        totalPreTax: preTaxTotal(),
        client1Roth: c1Roth,
        client2Roth: c2Roth,
        totalRoth: rothTotal(),
        totalTaxable: taxable,
        taxableBasis: basis,
        stockAllocation,
        filingStatus: currentFilingStatus,
        stateTaxRate,
        baseInflation,
        yearsFromStart: year,
        client1Age: c1Age,
        client2Age: c2Age,
        client1RmdAge: client1RmdAge || 73,
        client2RmdAge: client2RmdAge || 73,
        otherIncome: taxableIncome,
        socialSecurityIncome: socialSecurityIncome,
        taxFreeIncome: taxFreeIncome,
        // Cached tax values for performance
        cachedBrackets: cachedBrackets[year],
        cachedCapGainsBrackets: cachedCapGainsBrackets[year],
        cachedDeduction: cachedDeductions[year],
        cachedTopOf12: cachedTopOf12Bracket[year]
      };
      
      // Calculate unified withdrawal with all income sources
      // targetAfterTax is the spending we need to cover from withdrawals AFTER accounting for income
      // The function will determine how much income helps and what taxes are owed on everything
      const withdrawal = calculateUnifiedWithdrawal(spendingNeed, yearIncome, taxParams);
      
      grossWithdrawal = withdrawal.grossWithdrawal;
      fromPreTax = Math.min(withdrawal.fromPreTax, preTaxTotal());
      fromTaxable = Math.min(withdrawal.fromTaxable, taxable);
      fromRoth = Math.min(withdrawal.fromRoth, rothTotal());
      totalTax = withdrawal.totalTax;
      federalTax = withdrawal.federalTax;
      stateTax = withdrawal.stateTax;
      client1RMD = withdrawal.client1RMD || 0;
      client2RMD = withdrawal.client2RMD || 0;
      totalRMD = withdrawal.totalRMD || 0;
      excessRMDAfterTax = withdrawal.excessRMDAfterTax || 0;
      netIncome = withdrawal.netIncome || 0;
      excessIncome = withdrawal.excessIncome || 0;
      
      // Capture detailed tax info for verification
      const taxDetails = {
        qualifiedDividends: withdrawal.qualifiedDividends || 0,
        interestIncome: withdrawal.interestIncome || 0,
        taxableOrdinaryIncome: withdrawal.taxableOrdinaryIncome || 0,
        totalCapitalGains: withdrawal.totalCapitalGains || 0,
        federalOrdinaryTax: withdrawal.federalOrdinaryTax || 0,
        federalCapGainsTax: withdrawal.federalCapGainsTax || 0,
        niitTax: withdrawal.niitTax || 0,
        standardDeduction: cachedDeductions[year],
        taxableWithdrawalGains: fromTaxable > 0 && taxable > 0 ? fromTaxable * (1 - basis / taxable) : 0,
        filingStatus: currentFilingStatus,
        survivor: currentSurvivor,
        // Tax brackets for this year
        ordinaryBrackets: cachedBrackets[year],
        capGainsBrackets: cachedCapGainsBrackets[year],
        // Income breakdown
        otherTaxableIncome: taxableIncome,
        taxFreeIncome: taxFreeIncome,
        socialSecurityIncome: socialSecurityIncome,
        taxableSocialSecurity: withdrawal.taxableSocialSecurity || 0,
        // Social Security calculation details
        provisionalIncome: withdrawal.provisionalIncome || 0,
        ssBaseThreshold: withdrawal.ssBaseThreshold || 0,
        ssUpperThreshold: withdrawal.ssUpperThreshold || 0,
        // Net income tracking (income after taxes)
        netIncome: netIncome,
        excessIncome: excessIncome
      };
      
      // Update basis when withdrawing from taxable
      if (fromTaxable > 0 && taxable > 0) {
        const basisRatio = basis / taxable;
        basis -= fromTaxable * basisRatio;
      }
      
      // Withdraw from pre-tax accounts (proportionally from each client's account)
      if (fromPreTax > 0 && preTaxTotal() > 0) {
        const c1Ratio = c1PreTax / preTaxTotal();
        c1PreTax -= fromPreTax * c1Ratio;
        c2PreTax -= fromPreTax * (1 - c1Ratio);
      }
      
      // Withdraw from Roth (proportionally)
      if (fromRoth > 0 && rothTotal() > 0) {
        const c1Ratio = c1Roth / rothTotal();
        c1Roth -= fromRoth * c1Ratio;
        c2Roth -= fromRoth * (1 - c1Ratio);
      }
      
      // Withdraw from taxable
      taxable -= fromTaxable;
      
      // Add excess RMD (after-tax) back to taxable account
      if (excessRMDAfterTax > 0) {
        taxable += excessRMDAfterTax;
        basis += excessRMDAfterTax; // New money has 100% basis
      }
      
      // Add excess income (after taxes) to taxable account
      if (excessIncome > 0) {
        taxable += excessIncome;
        basis += excessIncome; // New money has 100% basis
      }
      
      const afterWithdrawal = totalBalance();
      
      // Check if we ran out of money
      if (afterWithdrawal < 0 || (spendingNeed > 0 && afterWithdrawal < spendingNeed * 0.1)) {
        detailedPath.push({ year, calYear, age: c1Age, age2: c2Age, startBalance, yearReturn, yearSpending, yearGoals, yearIncome, grossWithdrawal, fromTaxable, fromPreTax, fromRoth, totalTax, federalTax, stateTax, client1RMD, client2RMD, totalRMD, taxDetails, afterWithdrawal: 0, endBalance: 0, endPreTax: 0, endRoth: 0, endTaxable: 0 });
        success = false;
        path.push(0);
        for (let r = year + 1; r < planLength; r++) {
          path.push(0);
          const rAge = (client1Age || clientAge) + r;
          const rAge2 = filingStatus === 'mfj' ? (client2Age || clientAge) + r : 0;
          const emptyTaxDetails = { qualifiedDividends: 0, interestIncome: 0, taxableOrdinaryIncome: 0, totalCapitalGains: 0, federalOrdinaryTax: 0, federalCapGainsTax: 0, standardDeduction: 0, taxableWithdrawalGains: 0 };
          detailedPath.push({ year: r, calYear: currentYear + r, age: rAge, age2: rAge2, startBalance: 0, yearReturn: 0, yearSpending: 0, yearGoals: 0, yearIncome: 0, grossWithdrawal: 0, fromTaxable: 0, fromPreTax: 0, fromRoth: 0, totalTax: 0, federalTax: 0, stateTax: 0, client1RMD: 0, client2RMD: 0, totalRMD: 0, taxDetails: emptyTaxDetails, afterWithdrawal: 0, endBalance: 0, endPreTax: 0, endRoth: 0, endTaxable: 0 });
        }
        break;
      }
      
      // =========================================================================
      // END OF YEAR: Apply full year's return AFTER all withdrawals/income processed
      // =========================================================================
      c1PreTax *= (1 + yearReturn);
      c2PreTax *= (1 + yearReturn);
      c1Roth *= (1 + yearReturn);
      c2Roth *= (1 + yearReturn);
      taxable *= (1 + yearReturn);
      // Note: basis does NOT change with market returns - it only changes when buying/selling
      // When basis > taxable (unrealized loss), gain ratio is 0 so no tax on withdrawals

      const endBalance = totalBalance();
      path.push(endBalance);
      detailedPath.push({ year, calYear, age: c1Age, age2: c2Age, startBalance, yearReturn, yearSpending, yearGoals, yearIncome, grossWithdrawal, fromTaxable, fromPreTax, fromRoth, totalTax, federalTax, stateTax, client1RMD, client2RMD, totalRMD, taxDetails, afterWithdrawal, endBalance, endPreTax: preTaxTotal(), endRoth: rothTotal(), endTaxable: taxable });
    }
    
    const endingValue = totalBalance();

    // Calculate return-based CAGR from yearReturn values (pure market returns)
    // Only count years with actual returns (before failure), not zero-padded years after failure
    let compoundReturn = 1;
    let actualYears = 0;
    for (const yearData of detailedPath) {
      // Count year if it had actual market activity (startBalance > 0 or it's the first year)
      if (yearData.startBalance > 0 || actualYears === 0) {
        compoundReturn *= (1 + yearData.yearReturn);
        actualYears++;
      }
    }
    // Use actual years for CAGR calculation, with minimum of 1 to avoid division by zero
    const returnCAGR = actualYears > 0 ? Math.pow(compoundReturn, 1 / actualYears) - 1 : 0;

    results.push({ success, endingValue, path, detailedPath, returnCAGR });
    allPaths.push(path);
  }

  const successRate = results.filter(r => r.success).length / numSims;
  const endingValues = results.map(r => r.endingValue).sort((a, b) => a - b);
  const getPercentile = (arr, p) => arr[Math.min(Math.floor(arr.length * p), arr.length - 1)];
  const sortedResults = [...results].sort((a, b) => a.endingValue - b.endingValue);
  const percentilePaths = {}, percentileDetails = {};
  [0.1, 0.25, 0.5, 0.75, 0.9, 0.99].forEach(p => {
    const idx = Math.min(Math.floor(sortedResults.length * p), sortedResults.length - 1);
    percentilePaths[`p${Math.round(p * 100)}`] = sortedResults[idx].path;
    percentileDetails[`p${Math.round(p * 100)}`] = sortedResults[idx].detailedPath;
  });

  // Calculate return distribution percentiles (sorted by CAGR, not ending value)
  const sortedByReturn = [...results].sort((a, b) => a.returnCAGR - b.returnCAGR);
  const returnPercentiles = {};
  const returnPercentileDetails = {};

  [0.01, 0.10, 0.25, 0.50, 0.75, 0.90, 0.99].forEach(p => {
    const idx = Math.min(Math.floor(sortedByReturn.length * p), sortedByReturn.length - 1);
    const sim = sortedByReturn[idx];
    const key = `p${Math.round(p * 100)}`;

    // Calculate statistics for this simulation
    const returns = sim.detailedPath.map(d => d.yearReturn);
    const arithmeticMean = returns.reduce((sum, r) => sum + r, 0) / returns.length;
    const variance = returns.reduce((sum, r) => sum + Math.pow(r - arithmeticMean, 2), 0) / returns.length;
    const stdDev = Math.sqrt(variance);

    // Build year-by-year data with running CAGR
    let cumulative = 1;
    const yearByYear = sim.detailedPath.map((d, i) => {
      cumulative *= (1 + d.yearReturn);
      const cagrToDate = Math.pow(cumulative, 1 / (i + 1)) - 1;
      return {
        year: d.year,
        calYear: d.calYear,
        annualReturn: d.yearReturn,
        cagrToDate
      };
    });

    returnPercentiles[key] = sim.returnCAGR;
    returnPercentileDetails[key] = {
      cagr: sim.returnCAGR,
      arithmeticMean,
      stdDev,
      yearByYear
    };
  });

  return {
    successRate,
    percentileEnding: { p10: getPercentile(endingValues, 0.1), p25: getPercentile(endingValues, 0.25), p50: getPercentile(endingValues, 0.5), p75: getPercentile(endingValues, 0.75), p90: getPercentile(endingValues, 0.9), p99: getPercentile(endingValues, 0.99) },
    percentilePaths,
    percentileDetails,
    returnPercentiles,
    returnPercentileDetails
  };
};

const findPortfolioForSuccessRate = (params, targetRate, numSims) => {
  const totalPortfolio = params.preTaxBalance + params.rothBalance + params.taxableBalance;
  // Upper limit based on spending (e.g., 50x spending as max reasonable portfolio needed)
  let low = 0, high = Math.max(totalPortfolio * 10, params.baseSpending * 50);
  for (let i = 0; i < 15; i++) { 
    const mid = (low + high) / 2;
    // Scale all three accounts proportionally
    const scale = totalPortfolio > 0 ? mid / totalPortfolio : 1;
    const scaledParams = { 
      ...params, 
      preTaxBalance: params.preTaxBalance * scale,
      rothBalance: params.rothBalance * scale,
      taxableBalance: params.taxableBalance * scale,
      taxableBasis: params.taxableBasis * scale,
      client1PreTax: (params.client1PreTax || 0) * scale,
      client2PreTax: (params.client2PreTax || 0) * scale,
      client1Roth: (params.client1Roth || 0) * scale,
      client2Roth: (params.client2Roth || 0) * scale
    };
    const r = runSimulation(scaledParams, numSims);
    if (Math.abs(r.successRate - targetRate) < 0.005) return mid;
    if (r.successRate < targetRate) low = mid; else high = mid; 
  }
  return (low + high) / 2;
};

const findSpendingForSuccessRate = (params, pv, targetRate, numSims) => {
  const totalPortfolio = params.preTaxBalance + params.rothBalance + params.taxableBalance;
  // Scale accounts to target portfolio value
  const scale = totalPortfolio > 0 ? pv / totalPortfolio : 1;
  const scaledParams = { 
    ...params, 
    preTaxBalance: params.preTaxBalance * scale,
    rothBalance: params.rothBalance * scale,
    taxableBalance: params.taxableBalance * scale,
    taxableBasis: params.taxableBasis * scale,
    client1PreTax: (params.client1PreTax || 0) * scale,
    client2PreTax: (params.client2PreTax || 0) * scale,
    client1Roth: (params.client1Roth || 0) * scale,
    client2Roth: (params.client2Roth || 0) * scale
  };
  // Compute survivor spending ratio so it scales proportionally with base spending
  const survivorRatio = (params.survivorSpending != null && params.baseSpending > 0) ? params.survivorSpending / params.baseSpending : null;
  // Upper limit based on portfolio value (e.g., 20% of portfolio as max reasonable spending)
  let low = 0, high = Math.max(params.baseSpending * 10, pv * 0.2);
  for (let i = 0; i < 15; i++) {
    const mid = (low + high) / 2;
    const scaledSurvivor = survivorRatio != null ? mid * survivorRatio : null;
    const r = runSimulation({ ...scaledParams, baseSpending: mid, survivorSpending: scaledSurvivor }, numSims);
    if (Math.abs(r.successRate - targetRate) < 0.005) return mid;
    if (r.successRate > targetRate) low = mid; else high = mid;
  }
  return (low + high) / 2;
};

// =============================================================================
// EXPORT: PDF/HTML Report Generation
// =============================================================================
const generatePDF = (inputs, results) => {
  const { currentYear, client1Name, client1Age, client1PlanLength, client2Name, client2Age, client2PlanLength, planLength, accounts, preTaxBalance, rothBalance, taxableBalance, taxableBasis, stockAllocation, filingStatus, stateTaxRate, totalPortfolio, expectedReturn, stdDev, assetAllocations, baseInflation, baseSpending, survivorSpending, targetSuccessRate, upperGuardrail, lowerGuardrail, goals, incomeSources, numSimulations, spendingMode, phase2Year, phase2Reduction, phase3Year, phase3Reduction } = inputs;
  const { currentSuccess, upperGuardrailPortfolio, upperGuardrailSpending, lowerGuardrailPortfolio, lowerGuardrailSpending, survivorRatio, percentileEnding } = results;
  
  const filingStatusLabels = { single: 'Single', mfj: 'Married Filing Jointly', hoh: 'Head of Household' };
  const accountTypeLabels = { pretax: 'Pre-Tax (401k/IRA)', roth: 'Roth', taxable: 'Taxable (Brokerage)' };
  const getOwnerName = (owner) => {
    if (owner === 'client1') return client1Name || 'Client 1';
    if (owner === 'client2') return client2Name || 'Client 2';
    return 'Joint';
  };
  
  let html = '<!DOCTYPE html><html><head><title>Financial Plan</title><style>body{font-family:Arial,sans-serif;padding:40px;color:#333;max-width:1100px;margin:0 auto}h1{color:#0f4c5c}h2{color:#0f4c5c;border-bottom:2px solid #e8b059;padding-bottom:8px;margin-top:30px}.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin:20px 0}.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin:20px 0}.card{background:#f5f5f5;padding:20px;border-radius:8px;border-left:4px solid #0f4c5c}.label{font-size:12px;color:#666;text-transform:uppercase}.value{font-size:24px;font-weight:bold;color:#0f4c5c}.small-table{width:100%;border-collapse:collapse;margin:10px 0;font-size:14px}.small-table th{background:#0f4c5c;color:white;padding:8px;text-align:left}.small-table td{padding:8px;border-bottom:1px solid #ddd}.small-table tr:nth-child(even){background:#f9f9f9}table{width:100%;border-collapse:collapse;margin:20px 0}th{background:#0f4c5c;color:white;padding:10px;text-align:right}th:first-child{text-align:left}td{padding:8px;border-bottom:1px solid #ddd;text-align:right}td:first-child{text-align:left}.page-break{page-break-before:always}.assumptions-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}.assumptions-row:last-child{border-bottom:none}.owner-tag{font-size:11px;color:#666;font-weight:normal}</style></head><body>';
  
  html += '<h1>Financial Plan Analysis</h1><p>Generated: ' + new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + '</p>';
  
  // Client Information
  html += '<h2>Client Information</h2>';
  if (filingStatus === 'mfj') {
    html += '<div class="grid-2"><div class="card"><div class="label">Client 1</div><div class="value" style="font-size:20px">' + (client1Name || 'Client 1') + '</div>';
    html += '<div class="assumptions-row"><span>Age</span><strong>' + client1Age + '</strong></div>';
    html += '<div class="assumptions-row"><span>Plan Length</span><strong>' + client1PlanLength + ' years</strong></div></div>';
    html += '<div class="card"><div class="label">Client 2</div><div class="value" style="font-size:20px">' + (client2Name || 'Client 2') + '</div>';
    html += '<div class="assumptions-row"><span>Age</span><strong>' + client2Age + '</strong></div>';
    html += '<div class="assumptions-row"><span>Plan Length</span><strong>' + client2PlanLength + ' years</strong></div></div></div>';
    html += '<div class="card" style="margin-top:20px"><div class="assumptions-row"><span>Filing Status</span><strong>' + filingStatusLabels[filingStatus] + '</strong></div>';
    html += '<div class="assumptions-row"><span>Current Year</span><strong>' + currentYear + '</strong></div>';
    html += '<div class="assumptions-row"><span>Plan Length Used</span><strong>' + planLength + ' years (longer of both)</strong></div></div>';
  } else {
    html += '<div class="grid"><div class="card"><div class="label">Client</div><div class="value" style="font-size:20px">' + (client1Name || 'Client') + '</div>';
    html += '<div class="assumptions-row"><span>Age</span><strong>' + client1Age + '</strong></div>';
    html += '<div class="assumptions-row"><span>Plan Length</span><strong>' + client1PlanLength + ' years</strong></div></div>';
    html += '<div class="card"><div class="label">Filing Status</div><div class="value" style="font-size:16px">' + filingStatusLabels[filingStatus] + '</div></div>';
    html += '<div class="card"><div class="label">Current Year</div><div class="value">' + currentYear + '</div></div></div>';
  }
  
  // Accounts
  html += '<h2>Accounts</h2>';
  if (accounts && accounts.length > 0) {
    html += '<table class="small-table"><tr><th>Account Type</th>' + (filingStatus === 'mfj' ? '<th>Owner</th>' : '') + '<th style="text-align:right">Balance</th>' + '<th style="text-align:right">Cost Basis</th></tr>';
    accounts.forEach(a => {
      html += '<tr><td>' + accountTypeLabels[a.type] + '</td>';
      if (filingStatus === 'mfj') html += '<td>' + getOwnerName(a.owner) + '</td>';
      html += '<td style="text-align:right">' + formatCurrency(a.balance) + '</td>';
      html += '<td style="text-align:right">' + (a.type === 'taxable' ? formatCurrency(a.costBasis) : '-') + '</td></tr>';
    });
    html += '</table>';
  }
  html += '<div class="grid-2"><div class="card"><div class="assumptions-row"><span>Pre-Tax Total</span><strong>' + formatCurrency(preTaxBalance) + '</strong></div>';
  html += '<div class="assumptions-row"><span>Roth Total</span><strong>' + formatCurrency(rothBalance) + '</strong></div>';
  html += '<div class="assumptions-row"><span>Taxable Total</span><strong>' + formatCurrency(taxableBalance) + '</strong></div></div>';
  html += '<div class="card"><div class="assumptions-row"><span>Total Portfolio</span><strong>' + formatCurrency(totalPortfolio) + '</strong></div>';
  html += '<div class="assumptions-row"><span>Taxable Cost Basis</span><strong>' + formatCurrency(taxableBasis) + '</strong></div>';
  html += '<div class="assumptions-row"><span>Unrealized Gains</span><strong>' + formatCurrency(taxableBalance - taxableBasis) + '</strong></div></div></div>';
  html += '<div class="card" style="margin-top:20px"><div class="label">Taxable Account Allocation</div>';
  html += '<div class="assumptions-row"><span>Stocks</span><strong>' + stockAllocation.toFixed(0) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Bonds</span><strong>' + (100 - stockAllocation).toFixed(0) + '%</strong></div>';
  html += '<p style="font-size:11px;color:#666;margin-top:8px">Used to estimate taxable dividends (1% stocks, 4% bonds)</p></div>';
  
  // Tax Settings
  html += '<h2>Tax Settings</h2>';
  html += '<div class="grid-2"><div class="card"><div class="assumptions-row"><span>Filing Status</span><strong>' + filingStatusLabels[filingStatus] + '</strong></div>';
  html += '<div class="assumptions-row"><span>State Tax Rate</span><strong>' + stateTaxRate.toFixed(1) + '%</strong></div></div>';
  html += '<div class="card"><div class="assumptions-row"><span>Federal Brackets</span><strong>2026 (inflation-adjusted)</strong></div>';
  html += '<div class="assumptions-row"><span>Capital Gains Rate</span><strong>0% / 15% / 20%</strong></div></div></div>';
  
  // Financial Assumptions
  html += '<h2>Financial Assumptions</h2>';
  html += '<div class="grid-2"><div class="card"><div class="assumptions-row"><span>Base Annual Spending (After-Tax)</span><strong>' + formatCurrency(baseSpending) + '</strong></div>';
  if (survivorSpending != null) html += '<div class="assumptions-row"><span>Survivor Annual Spending (After-Tax)</span><strong>' + formatCurrency(survivorSpending) + '</strong></div>';
  html += '<div class="assumptions-row"><span>Portfolio Geometric Return</span><strong>' + (expectedReturn * 100).toFixed(2) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Portfolio Std Deviation</span><strong>' + (stdDev * 100).toFixed(2) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Base Inflation Rate</span><strong>' + (baseInflation * 100).toFixed(2) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Target Success Rate</span><strong>' + (targetSuccessRate * 100).toFixed(0) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Upper Guardrail</span><strong>' + (upperGuardrail * 100).toFixed(0) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Lower Guardrail</span><strong>' + (lowerGuardrail * 100).toFixed(0) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Simulations Run</span><strong>' + numSimulations.toLocaleString() + '</strong></div></div>';
  html += '<div class="card"><div class="label" style="margin-bottom:10px">Asset Class Allocation</div>';
  ASSET_CLASSES.forEach((name, idx) => { const pct = parseInt(assetAllocations[idx]) || 0; if (pct > 0) html += '<div class="assumptions-row"><span>' + name + '</span><strong>' + pct + '%</strong></div>'; });
  html += '</div></div>';
  
  // Spending Mode
  html += '<h2>Spending Mode</h2>';
  if (spendingMode === 'linear') {
    html += '<p>Linear spending: Base spending grows at ' + (baseInflation * 100).toFixed(2) + '% inflation throughout the plan.</p>';
  } else {
    html += '<div class="card"><div class="assumptions-row"><span>Mode</span><strong>Spending Smile</strong></div>';
    html += '<div class="assumptions-row"><span>Phase 1 (until ' + phase2Year + ')</span><strong>' + (baseInflation * 100).toFixed(2) + '% inflation</strong></div>';
    html += '<div class="assumptions-row"><span>Phase 2 (' + phase2Year + ' - ' + phase3Year + ')</span><strong>' + ((baseInflation - phase2Reduction / 100) * 100).toFixed(2) + '% inflation (reduced by ' + phase2Reduction + '%)</strong></div>';
    html += '<div class="assumptions-row"><span>Phase 3 (' + phase3Year + '+)</span><strong>' + ((baseInflation - phase3Reduction / 100) * 100).toFixed(2) + '% inflation (reduced by ' + phase3Reduction + '%)</strong></div></div>';
  }
  
  // Spending Goals
  html += '<h2>Spending Goals</h2>';
  if (goals.length === 0) {
    html += '<p>No spending goals defined.</p>';
  } else {
    html += '<table class="small-table"><tr><th>Name</th><th>Amount</th><th>Type</th><th>Start Year</th><th>End Year</th><th>Frequency</th><th>Inflation</th></tr>';
    goals.forEach(g => {
      const typeLabel = g.goalType === 'onetime' ? 'One-time' : g.goalType === 'annual' ? 'Annual' : 'Every ' + (g.frequency || 1) + ' yrs';
      const endYear = g.goalType === 'onetime' ? '-' : (g.continueThrough ? 'End of plan' : g.endYear);
      const freq = g.goalType === 'every' ? (g.frequency || 1) + ' years' : '-';
      const inf = g.customInflation !== null ? (g.customInflation * 100).toFixed(1) + '%' : 'Base (' + (baseInflation * 100).toFixed(1) + '%)';
      html += '<tr><td>' + (g.name || 'Unnamed') + '</td><td>' + formatCurrency(g.amount) + '</td><td>' + typeLabel + '</td><td>' + g.startYear + '</td><td>' + endYear + '</td><td>' + freq + '</td><td>' + inf + '</td></tr>';
    });
    html += '</table>';
  }
  
  // Income Sources
  html += '<h2>Income Sources</h2>';
  if (incomeSources.length === 0) {
    html += '<p>No income sources defined.</p>';
  } else {
    html += '<table class="small-table"><tr><th>Name</th><th>Annual Amount</th><th>Start Year</th><th>End Year</th><th>Inflation</th></tr>';
    incomeSources.forEach(i => {
      const endYear = i.continueThrough ? 'End of plan' : i.endYear;
      const inf = i.customInflation !== null ? (i.customInflation * 100).toFixed(1) + '%' : 'Base (' + (baseInflation * 100).toFixed(1) + '%)';
      html += '<tr><td>' + (i.name || 'Unnamed') + '</td><td>' + formatCurrency(i.amount) + '</td><td>' + i.startYear + '</td><td>' + endYear + '</td><td>' + inf + '</td></tr>';
    });
    html += '</table>';
  }
  
  // Results
  html += '<h2>Analysis Results</h2><div class="grid"><div class="card" style="background:linear-gradient(135deg,#0f4c5c,#1a6b7c);color:white;border-left:4px solid #e8b059"><div class="label" style="color:rgba(255,255,255,0.8)">Success Probability</div><div class="value" style="color:white">' + (currentSuccess * 100).toFixed(1) + '%</div></div><div class="card"><div class="label">Target Rate</div><div class="value">' + (targetSuccessRate * 100).toFixed(0) + '%</div></div><div class="card"><div class="label">Median Ending Value</div><div class="value">' + formatCurrency(percentileEnding.p50) + '</div></div></div>';
  
  // Ending Portfolio Percentiles
  html += '<h2>Ending Portfolio Percentiles</h2>';
  html += '<div class="grid" style="grid-template-columns:repeat(6,1fr)"><div class="card" style="text-align:center"><div class="label">10th</div><div class="value" style="font-size:18px">' + formatCurrency(percentileEnding.p10) + '</div></div>';
  html += '<div class="card" style="text-align:center"><div class="label">25th</div><div class="value" style="font-size:18px">' + formatCurrency(percentileEnding.p25) + '</div></div>';
  html += '<div class="card" style="text-align:center"><div class="label">50th</div><div class="value" style="font-size:18px">' + formatCurrency(percentileEnding.p50) + '</div></div>';
  html += '<div class="card" style="text-align:center"><div class="label">75th</div><div class="value" style="font-size:18px">' + formatCurrency(percentileEnding.p75) + '</div></div>';
  html += '<div class="card" style="text-align:center"><div class="label">90th</div><div class="value" style="font-size:18px">' + formatCurrency(percentileEnding.p90) + '</div></div>';
  html += '<div class="card" style="text-align:center"><div class="label">99th</div><div class="value" style="font-size:18px">' + formatCurrency(percentileEnding.p99) + '</div></div></div>';
  
  // Guardrails
  html += '<h2>Guardrail Analysis</h2><div class="grid-2"><div class="card" style="border-left-color:#4caf50"><div class="label">Upper Guardrail (' + (upperGuardrail * 100).toFixed(0) + '% Success)</div><div class="assumptions-row"><span>Portfolio Value</span><strong>' + formatCurrency(upperGuardrailPortfolio) + '</strong></div><div class="assumptions-row"><span>New Base Spending</span><strong>' + formatCurrency(upperGuardrailSpending) + '</strong></div>' + (survivorRatio != null ? '<div class="assumptions-row"><span>Survivor Spending</span><strong>' + formatCurrency(upperGuardrailSpending * survivorRatio) + '</strong></div>' : '') + '<div class="assumptions-row"><span>Spending Change</span><strong style="color:#4caf50">+' + formatCurrency(upperGuardrailSpending - baseSpending) + '</strong></div></div>';
  html += '<div class="card" style="border-left-color:#ff9800"><div class="label">Lower Guardrail (' + (lowerGuardrail * 100).toFixed(0) + '% Success)</div><div class="assumptions-row"><span>Portfolio Value</span><strong>' + formatCurrency(lowerGuardrailPortfolio) + '</strong></div><div class="assumptions-row"><span>New Base Spending</span><strong>' + formatCurrency(lowerGuardrailSpending) + '</strong></div>' + (survivorRatio != null ? '<div class="assumptions-row"><span>Survivor Spending</span><strong>' + formatCurrency(lowerGuardrailSpending * survivorRatio) + '</strong></div>' : '') + '<div class="assumptions-row"><span>Spending Change</span><strong style="color:#ff9800">' + formatCurrency(lowerGuardrailSpending - baseSpending) + '</strong></div></div></div>';
  
  // Disclaimer
  html += '<div style="margin-top:40px;padding:20px;border:1px solid #ccc;border-radius:8px;background:#f9f9f9"><p style="font-size:11px;color:#666;margin:0;line-height:1.5"><strong>IMPORTANT DISCLOSURE:</strong> The projections and analysis contained in this report are hypothetical in nature, do not reflect actual investment results, and are not guarantees of future results. This analysis is based on assumptions that may not reflect actual market conditions or your personal financial situation. Actual results will vary and may be significantly different from these projections. Monte Carlo simulations show a range of possible outcomes based on historical data and assumptions about future returns, inflation, and taxes. Past performance is not indicative of future results. This report is for informational purposes only and should not be considered investment, tax, or legal advice.</p></div>';
  
  html += '</body></html>';
  
  const blob = new Blob([html], { type: 'text/html' }), url = URL.createObjectURL(blob), link = document.createElement('a');
  link.href = url; link.download = 'Financial_Plan.html'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
};

// =============================================================================
// REACT COMPONENTS: Main Application
// =============================================================================
function App() {
  const [currentYear, setCurrentYear] = useState(2026);
  
  // Client information
  const [client1Name, setClient1Name] = useState('');
  const [client1Age, setClient1Age] = useState(60);
  const [client1PlanLength, setClient1PlanLength] = useState(30);
  const [client1RmdAge, setClient1RmdAge] = useState(73); // 73 for birth years 1951-1959, 75 for 1960+
  const [client2Name, setClient2Name] = useState('');
  const [client2Age, setClient2Age] = useState(58);
  const [client2PlanLength, setClient2PlanLength] = useState(32);
  const [client2RmdAge, setClient2RmdAge] = useState(75); // Default to 75 for younger spouse

  // Filing status (moved from Tax Settings)
  const [filingStatus, setFilingStatus] = useState('mfj');
  
  // Helper function to format age display for MFJ (e.g., "62/60" or "91/-" if spouse passed)
  const formatAge = (age1, age2, isMFJ) => {
    if (!isMFJ) return age1;
    const a1 = age1 > 0 ? age1 : '-';
    const a2 = age2 > 0 ? age2 : '-';
    return `${a1}/${a2}`;
  };
  
  // Dynamic accounts array
  const [accounts, setAccounts] = useState([
    { id: 1, type: 'pretax', balance: 500000, owner: 'client1', costBasis: 0, stockAllocation: 60 },
    { id: 2, type: 'roth', balance: 200000, owner: 'client1', costBasis: 0, stockAllocation: 60 },
    { id: 3, type: 'taxable', balance: 300000, owner: 'joint', costBasis: 200000, stockAllocation: 60 }
  ]);
  
  // Account helper functions
  const addAccount = () => setAccounts([...accounts, { id: Date.now(), type: 'pretax', balance: 0, owner: 'client1', costBasis: 0, stockAllocation: 60 }]);
  const updateAccount = (id, field, value) => {
    // Validate stockAllocation to be between 0 and 100
    const sanitizedValue = field === 'stockAllocation' ? Math.max(0, Math.min(100, value)) : value;
    setAccounts(accounts.map(a => a.id === id ? { ...a, [field]: sanitizedValue } : a));
  };
  const removeAccount = (id) => setAccounts(accounts.filter(a => a.id !== id));
  
  // Computed totals from accounts
  const preTaxBalance = accounts.filter(a => a.type === 'pretax').reduce((sum, a) => sum + a.balance, 0);
  const rothBalance = accounts.filter(a => a.type === 'roth').reduce((sum, a) => sum + a.balance, 0);
  const taxableBalance = accounts.filter(a => a.type === 'taxable').reduce((sum, a) => sum + a.balance, 0);
  const taxableBasis = accounts.filter(a => a.type === 'taxable').reduce((sum, a) => sum + a.costBasis, 0);
  
  // Weighted average stock allocation for taxable accounts (used for dividend/interest calculations)
  const taxableAccounts = accounts.filter(a => a.type === 'taxable');
  const stockAllocation = taxableBalance > 0 
    ? taxableAccounts.reduce((sum, a) => sum + (a.balance * (a.stockAllocation || 60)), 0) / taxableBalance 
    : 60;
  
  // Client-specific totals for RMD calculations
  const client1PreTax = accounts.filter(a => a.type === 'pretax' && a.owner === 'client1').reduce((sum, a) => sum + a.balance, 0);
  const client2PreTax = accounts.filter(a => a.type === 'pretax' && a.owner === 'client2').reduce((sum, a) => sum + a.balance, 0);
  const client1Roth = accounts.filter(a => a.type === 'roth' && a.owner === 'client1').reduce((sum, a) => sum + a.balance, 0);
  const client2Roth = accounts.filter(a => a.type === 'roth' && a.owner === 'client2').reduce((sum, a) => sum + a.balance, 0);
  
  // Tax settings (state tax only now)
  const [stateTaxRate, setStateTaxRate] = useState(5);
  
  // Asset allocation (portfolio-wide weights for return generation) - 12 asset classes, whole numbers
  const [assetAllocations, setAssetAllocations] = useState(new Array(NUM_ASSETS).fill(''));
  const updateAllocation = (idx, value) => {
    const next = [...assetAllocations];
    next[idx] = value;
    setAssetAllocations(next);
  };
  const allocationSum = assetAllocations.reduce((s, v) => s + (parseInt(v) || 0), 0);
  const allocationsValid = allocationSum === 100;

  // Convert allocations to decimal weights for calculations
  const assetWeights = assetAllocations.map(v => (parseInt(v) || 0) / 100);

  // Derived portfolio expected return: sum(w_i * r_i)
  const expectedReturn = assetWeights.reduce((s, w, i) => s + w * ASSET_RETURNS[i], 0) * 100;

  // Derived portfolio standard deviation: sqrt(w^T * Cov * w) where Cov_ij = sigma_i * sigma_j * rho_ij
  const portfolioVariance = (() => {
    let v = 0;
    for (let i = 0; i < NUM_ASSETS; i++) {
      for (let j = 0; j < NUM_ASSETS; j++) {
        v += assetWeights[i] * assetWeights[j] * ASSET_STDDEVS[i] * ASSET_STDDEVS[j] * ASSET_CORR_FIXED[i][j];
      }
    }
    return v;
  })();
  const stdDev = Math.sqrt(portfolioVariance) * 100;

  const [baseInflation, setBaseInflation] = useState(2.5);
  const [baseSpending, setBaseSpending] = useState(40000);
  const [survivorSpending, setSurvivorSpending] = useState(null);
  const [targetSuccessRate, setTargetSuccessRate] = useState(80);
  const [upperGuardrail, setUpperGuardrail] = useState(90);
  const [lowerGuardrail, setLowerGuardrail] = useState(70);
  const [numSimulations, setNumSimulations] = useState(2000);
  const [goals, setGoals] = useState([]);
  const [incomeSources, setIncomeSources] = useState([]);
  const [results, setResults] = useState(null);
  const [isCalculating, setIsCalculating] = useState(false);
  
  // Spending smile state
  const [spendingMode, setSpendingMode] = useState('linear');
  const [phase2Year, setPhase2Year] = useState(2035);
  const [phase2Reduction, setPhase2Reduction] = useState(2);
  const [phase3Year, setPhase3Year] = useState(2050);
  const [phase3Reduction, setPhase3Reduction] = useState(1);
  
  // Computed values
  const totalPortfolio = preTaxBalance + rothBalance + taxableBalance;
  const planLength = filingStatus === 'mfj' ? Math.max(client1PlanLength, client2PlanLength) : client1PlanLength;
  const clientAge = client1Age; // Primary client age for calculations

  const addGoal = () => setGoals([...goals, { id: Date.now(), name: '', amount: 0, startYear: currentYear, goalType: 'onetime', frequency: '', endYear: currentYear + planLength, continueThrough: true, customInflation: null }]);
  const updateGoal = (id, field, value) => {
    // Ensure goal amounts are never negative
    const sanitizedValue = field === 'amount' ? Math.max(0, value) : value;
    setGoals(goals.map(g => g.id === id ? { ...g, [field]: sanitizedValue } : g));
  };
  const removeGoal = (id) => setGoals(goals.filter(g => g.id !== id));
  const addIncomeSource = () => setIncomeSources([...incomeSources, { id: Date.now(), name: '', amount: 0, startYear: currentYear, endYear: currentYear + planLength, continueThrough: true, customInflation: null, isTaxFree: false, isSocialSecurity: false, owner: 'joint' }]);
  const updateIncomeSource = (id, field, value) => setIncomeSources(incomeSources.map(i => i.id === id ? { ...i, [field]: value } : i));
  const removeIncomeSource = (id) => setIncomeSources(incomeSources.filter(i => i.id !== id));

  // Verification section state
  const [verificationOpen, setVerificationOpen] = useState(false);
  const [verificationPercentile, setVerificationPercentile] = useState('p50');
  const [taxVerificationOpen, setTaxVerificationOpen] = useState(false);
  const [taxVerificationYear, setTaxVerificationYear] = useState(0);
  const [accountBalancesOpen, setAccountBalancesOpen] = useState(false);
  const [accountBalancesPercentile, setAccountBalancesPercentile] = useState('p50');
  const [returnDistributionOpen, setReturnDistributionOpen] = useState(false);
  const [returnDistributionPercentile, setReturnDistributionPercentile] = useState('p50');

  const calculate = useCallback(() => {
    setIsCalculating(true);
    setTimeout(() => {
      const params = {
        preTaxBalance, rothBalance, taxableBalance, taxableBasis,
        client1PreTax, client2PreTax, client1Roth, client2Roth,
        stockAllocation: stockAllocation / 100, filingStatus, stateTaxRate: stateTaxRate / 100,
        planLength, assetWeights, choleskyL: CHOLESKY_L,
        baseSpending, survivorSpending: filingStatus === 'mfj' ? (survivorSpending !== null ? survivorSpending : baseSpending) : null,
        baseInflation: baseInflation / 100, goals, incomeSources,
        currentYear, clientAge, client1Age, client2Age: filingStatus === 'mfj' ? client2Age : 0,
        client1RmdAge, client2RmdAge: filingStatus === 'mfj' ? client2RmdAge : client1RmdAge,
        client1PlanLength, client2PlanLength: filingStatus === 'mfj' ? client2PlanLength : client1PlanLength,
        spendingMode,
        phase2Year, phase2Reduction: phase2Reduction / 100,
        phase3Year, phase3Reduction: phase3Reduction / 100
      };
      const mainResult = runSimulation(params, numSimulations);
      const currentSuccessRate = mainResult.successRate;
      
      // Upper Guardrail Logic
      let upperPortfolio, upperSpending;
      if (currentSuccessRate >= upperGuardrail / 100) {
        // Already above upper guardrail - keep portfolio, find higher spending at target rate
        upperPortfolio = totalPortfolio;
        upperSpending = findSpendingForSuccessRate(params, totalPortfolio, targetSuccessRate / 100, numSimulations);
      } else {
        // Below upper guardrail - find portfolio that hits upper guardrail, then spending at target
        upperPortfolio = findPortfolioForSuccessRate(params, upperGuardrail / 100, numSimulations);
        upperSpending = findSpendingForSuccessRate(params, upperPortfolio, targetSuccessRate / 100, numSimulations);
      }
      
      // Lower Guardrail Logic
      let lowerPortfolio, lowerSpending;
      if (currentSuccessRate <= lowerGuardrail / 100) {
        // Already below lower guardrail - keep portfolio, find lower spending at target rate
        lowerPortfolio = totalPortfolio;
        lowerSpending = findSpendingForSuccessRate(params, totalPortfolio, targetSuccessRate / 100, numSimulations);
      } else {
        // Above lower guardrail - find portfolio that hits lower guardrail, then spending at target
        lowerPortfolio = findPortfolioForSuccessRate(params, lowerGuardrail / 100, numSimulations);
        lowerSpending = findSpendingForSuccessRate(params, lowerPortfolio, targetSuccessRate / 100, numSimulations);
      }
      
      const chartData = [];
      for (let y = 0; y <= planLength; y++) {
        chartData.push({ year: currentYear + y, p10: mainResult.percentilePaths.p10[y], p25: mainResult.percentilePaths.p25[y], p50: mainResult.percentilePaths.p50[y], p75: mainResult.percentilePaths.p75[y], p90: mainResult.percentilePaths.p90[y], p99: mainResult.percentilePaths.p99[y] });
      }
      // Compute survivor spending ratio for guardrail display (only if different from base)
      const hasDifferentSurvivorSpending = filingStatus === 'mfj' && survivorSpending !== null && survivorSpending !== baseSpending;
      const survivorRatio = hasDifferentSurvivorSpending && baseSpending > 0 ? survivorSpending / baseSpending : null;
      setResults({ currentSuccess: mainResult.successRate, upperGuardrailPortfolio: upperPortfolio, upperGuardrailSpending: upperSpending, lowerGuardrailPortfolio: lowerPortfolio, lowerGuardrailSpending: lowerSpending, survivorRatio, percentileEnding: mainResult.percentileEnding, chartData, percentileDetails: mainResult.percentileDetails, returnPercentiles: mainResult.returnPercentiles, returnPercentileDetails: mainResult.returnPercentileDetails });
      setIsCalculating(false);
    }, 100);
  }, [preTaxBalance, rothBalance, taxableBalance, taxableBasis, client1PreTax, client2PreTax, client1Roth, client2Roth, stockAllocation, filingStatus, stateTaxRate, totalPortfolio, planLength, assetWeights, baseSpending, survivorSpending, baseInflation, goals, incomeSources, currentYear, clientAge, client1Age, client2Age, client1RmdAge, client2RmdAge, numSimulations, targetSuccessRate, upperGuardrail, lowerGuardrail, spendingMode, phase2Year, phase2Reduction, phase3Year, phase3Reduction, client1PlanLength, client2PlanLength, accounts]);

  const exportPDF = () => { if (results) generatePDF({ currentYear, client1Name, client1Age, client1PlanLength, client2Name, client2Age, client2PlanLength, planLength, accounts, preTaxBalance, rothBalance, taxableBalance, taxableBasis, stockAllocation, filingStatus, stateTaxRate, totalPortfolio, expectedReturn: expectedReturn / 100, stdDev: stdDev / 100, assetAllocations, baseInflation: baseInflation / 100, baseSpending, survivorSpending: filingStatus === 'mfj' && survivorSpending !== null && survivorSpending !== baseSpending ? survivorSpending : null, targetSuccessRate: targetSuccessRate / 100, upperGuardrail: upperGuardrail / 100, lowerGuardrail: lowerGuardrail / 100, goals, incomeSources, numSimulations, spendingMode, phase2Year, phase2Reduction, phase3Year, phase3Reduction }, results); };

  // Export verification details table to PDF
  const exportVerificationPDF = (percentile) => {
    if (!results || !results.percentileDetails || !results.percentileDetails[percentile]) return;
    const data = results.percentileDetails[percentile];
    const percentileLabel = percentile === 'p10' ? '10th' : percentile === 'p25' ? '25th' : percentile === 'p50' ? '50th' : percentile === 'p75' ? '75th' : percentile === 'p90' ? '90th' : '99th';
    
    let html = '<!DOCTYPE html><html><head><title>Verification Details - ' + percentileLabel + ' Percentile</title>';
    html += '<style>body{font-family:Arial,sans-serif;padding:30px;color:#333;font-size:11px}h1{color:#0f4c5c;font-size:18px}h2{color:#0f4c5c;font-size:14px;margin-top:20px}table{width:100%;border-collapse:collapse;margin:15px 0}th{background:#0f4c5c;color:white;padding:6px 4px;text-align:right;font-size:10px}th:first-child{text-align:left}td{padding:5px 4px;border-bottom:1px solid #ddd;text-align:right;font-size:10px}td:first-child{text-align:left}.negative{color:#dc2626}.positive{color:#16a34a}tr:nth-child(even){background:#f9f9f9}.meta{color:#666;font-size:11px;margin-bottom:15px}</style></head><body>';
    
    html += '<h1>Verification Details - ' + percentileLabel + ' Percentile Simulation</h1>';
    html += '<p class="meta">Generated: ' + new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + '</p>';
    html += '<p class="meta">Final Portfolio Value: ' + formatCurrency(results.percentileEnding[percentile]) + '</p>';
    
    html += '<table><tr><th>Year</th><th>Age</th><th>Start</th><th>Return</th><th>Spending</th><th>Goals</th><th>Income</th><th>AT Inc</th><th>AT Need</th><th>RMD</th><th>Gross W/D</th><th>Taxable</th><th>PreTax</th><th>Roth</th><th>Fed Tax</th><th>State Tax</th><th>Total Tax</th><th>Return $</th><th>End</th></tr>';

    data.forEach(r => {
      const afterTaxIncome = r.taxDetails?.netIncome || 0;
      const afterTaxNeed = r.yearSpending + r.yearGoals - afterTaxIncome;
      const ageDisplay = filingStatus === 'mfj' ? (r.age > 0 ? r.age : '-') + '/' + (r.age2 > 0 ? r.age2 : '-') : r.age;
      const returnDollars = (r.endBalance || 0) - (r.afterWithdrawal || 0);
      html += '<tr>';
      html += '<td>' + r.calYear + '</td>';
      html += '<td>' + ageDisplay + '</td>';
      html += '<td>' + formatCurrency(r.startBalance) + '</td>';
      html += '<td class="' + (r.yearReturn >= 0 ? 'positive' : 'negative') + '">' + (r.yearReturn * 100).toFixed(1) + '%</td>';
      html += '<td>' + formatCurrency(r.yearSpending) + '</td>';
      html += '<td>' + formatCurrency(r.yearGoals) + '</td>';
      html += '<td>' + formatCurrency(r.yearIncome) + '</td>';
      html += '<td>' + formatCurrency(afterTaxIncome) + '</td>';
      html += '<td class="' + (afterTaxNeed < 0 ? 'positive' : '') + '">' + formatCurrency(afterTaxNeed) + '</td>';
      html += '<td>' + formatCurrency(r.totalRMD || 0) + '</td>';
      html += '<td>' + formatCurrency(r.grossWithdrawal) + '</td>';
      html += '<td>' + formatCurrency(r.fromTaxable) + '</td>';
      html += '<td>' + formatCurrency(r.fromPreTax) + '</td>';
      html += '<td>' + formatCurrency(r.fromRoth) + '</td>';
      html += '<td class="negative">' + formatCurrency(r.federalTax) + '</td>';
      html += '<td class="negative">' + formatCurrency(r.stateTax) + '</td>';
      html += '<td class="negative">' + formatCurrency(r.totalTax) + '</td>';
      html += '<td class="' + (returnDollars >= 0 ? 'positive' : 'negative') + '">' + formatCurrency(returnDollars) + '</td>';
      html += '<td><strong>' + formatCurrency(r.endBalance) + '</strong></td>';
      html += '</tr>';
    });
    html += '</table>';
    html += '<div style="margin-top:30px;padding:15px;border:1px solid #ccc;border-radius:8px;background:#f9f9f9"><p style="font-size:10px;color:#666;margin:0;line-height:1.5"><strong>IMPORTANT DISCLOSURE:</strong> The projections and analysis contained in this report are hypothetical in nature, do not reflect actual investment results, and are not guarantees of future results. This analysis is based on assumptions that may not reflect actual market conditions or your personal financial situation. Actual results will vary and may be significantly different from these projections. Monte Carlo simulations show a range of possible outcomes based on historical data and assumptions about future returns, inflation, and taxes. Past performance is not indicative of future results. This report is for informational purposes only and should not be considered investment, tax, or legal advice.</p></div>';
    html += '</body></html>';
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
  };

  // Export tax calculation details for a specific year to PDF (with brackets)
  const exportTaxDetailsPDF = (percentile, yearIndex) => {
    if (!results || !results.percentileDetails || !results.percentileDetails[percentile]) return;
    const yearData = results.percentileDetails[percentile][yearIndex];
    if (!yearData) return;
    const td = yearData.taxDetails || {};
    const percentileLabel = percentile === 'p10' ? '10th' : percentile === 'p25' ? '25th' : percentile === 'p50' ? '50th' : percentile === 'p75' ? '75th' : percentile === 'p90' ? '90th' : '99th';
    const filingLabel = td.filingStatus === 'single' ? 'Single' : td.filingStatus === 'mfj' ? 'Married Filing Jointly' : 'Head of Household';
    
    let html = '<!DOCTYPE html><html><head><title>Tax Calculation - Year ' + yearData.calYear + '</title>';
    html += '<style>body{font-family:Arial,sans-serif;padding:30px;color:#333;font-size:12px}h1{color:#0f4c5c;font-size:18px}h2{color:#0f4c5c;font-size:14px;border-bottom:2px solid #e8b059;padding-bottom:5px;margin-top:25px}.section{background:#f5f5f5;padding:15px;border-radius:8px;margin:15px 0;border-left:4px solid #0f4c5c}.row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eee}.row:last-child{border-bottom:none}.row.total{font-weight:bold;border-top:2px solid #0f4c5c;padding-top:10px;margin-top:5px}.label{color:#666}.value{font-weight:500}.negative{color:#dc2626}.positive{color:#16a34a}.meta{color:#666;font-size:11px;margin-bottom:15px}.indent{padding-left:20px;font-size:11px;color:#888}.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}table{width:100%;border-collapse:collapse;margin:10px 0;font-size:11px}th{background:#0f4c5c;color:white;padding:6px;text-align:left}td{padding:5px 6px;border-bottom:1px solid #ddd}.current-bracket{background:#fef3c7;font-weight:bold}.bracket-table td:nth-child(2),.bracket-table td:nth-child(3){text-align:right}.bracket-table th:nth-child(2),.bracket-table th:nth-child(3){text-align:right}</style></head><body>';
    
    html += '<h1>Tax Calculation Details</h1>';
    const taxAgeDisplay = filingStatus === 'mfj' ? (yearData.age > 0 ? yearData.age : '-') + '/' + (yearData.age2 > 0 ? yearData.age2 : '-') : yearData.age;
    html += '<p class="meta">Year: ' + yearData.calYear + ' | Age: ' + taxAgeDisplay + ' | ' + percentileLabel + ' Percentile Simulation</p>';
    html += '<p class="meta">Filing Status: ' + filingLabel + '</p>';
    html += '<p class="meta">Generated: ' + new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + '</p>';
    
    html += '<div class="grid"><div>';
    
    // Ordinary Income Section
    html += '<h2>Ordinary Income</h2><div class="section">';
    html += '<div class="row"><span class="label">Pre-Tax Withdrawals</span><span class="value">' + formatCurrency(yearData.fromPreTax) + '</span></div>';
    html += '<div class="row"><span class="label">Interest Income</span><span class="value">' + formatCurrency(td.interestIncome || 0) + '</span></div>';
    if ((td.otherTaxableIncome || 0) > 0) {
      html += '<div class="row"><span class="label">Other Taxable Income</span><span class="value">' + formatCurrency(td.otherTaxableIncome) + '</span></div>';
    }
    if ((td.socialSecurityIncome || 0) > 0) {
      html += '<div class="row"><span class="label">Social Security Income</span><span class="value">' + formatCurrency(td.socialSecurityIncome) + '</span></div>';
      html += '<div class="row indent"><span class="label">└ Taxable Portion (' + (td.socialSecurityIncome > 0 ? ((td.taxableSocialSecurity / td.socialSecurityIncome) * 100).toFixed(0) : 0) + '%)</span><span class="value">' + formatCurrency(td.taxableSocialSecurity) + '</span></div>';
    }
    const totalOrdinary = yearData.fromPreTax + (td.interestIncome || 0) + (td.otherTaxableIncome || 0) + (td.taxableSocialSecurity || 0);
    html += '<div class="row total"><span class="label">Total Ordinary Income</span><span class="value">' + formatCurrency(totalOrdinary) + '</span></div>';
    html += '<div class="row"><span class="label">Less: Standard Deduction</span><span class="value positive">-' + formatCurrency(td.standardDeduction) + '</span></div>';
    html += '<div class="row total"><span class="label">Taxable Ordinary Income</span><span class="value">' + formatCurrency(td.taxableOrdinaryIncome || 0) + '</span></div>';
    html += '</div>';
    
    // Social Security Calculation (if applicable)
    if ((td.socialSecurityIncome || 0) > 0) {
      html += '<h2>Social Security Calculation</h2><div class="section">';
      html += '<div class="row"><span class="label">Pre-Tax Withdrawals</span><span class="value">' + formatCurrency(yearData.fromPreTax) + '</span></div>';
      html += '<div class="row"><span class="label">+ Other Income</span><span class="value">' + formatCurrency(td.otherTaxableIncome || 0) + '</span></div>';
      html += '<div class="row"><span class="label">+ Interest Income</span><span class="value">' + formatCurrency(td.interestIncome || 0) + '</span></div>';
      html += '<div class="row"><span class="label">+ Qualified Dividends</span><span class="value">' + formatCurrency(td.qualifiedDividends || 0) + '</span></div>';
      html += '<div class="row"><span class="label">+ 50% of SS Benefits</span><span class="value">' + formatCurrency((td.socialSecurityIncome || 0) * 0.5) + '</span></div>';
      html += '<div class="row total"><span class="label">= Provisional Income</span><span class="value">' + formatCurrency(td.provisionalIncome || 0) + '</span></div>';
      html += '<div class="row" style="margin-top:10px"><span class="label">Base Threshold (' + (td.filingStatus === 'mfj' ? 'MFJ' : 'Single') + ')</span><span class="value">' + formatCurrency(td.ssBaseThreshold) + '</span></div>';
      html += '<div class="row"><span class="label">Upper Threshold</span><span class="value">' + formatCurrency(td.ssUpperThreshold) + '</span></div>';
      const ssResult = td.provisionalIncome <= td.ssBaseThreshold ? '0% taxable' : td.provisionalIncome <= td.ssUpperThreshold ? 'Up to 50% taxable' : 'Up to 85% taxable';
      html += '<div class="row total"><span class="label">Result</span><span class="value">' + ssResult + '</span></div>';
      html += '</div>';
    }
    
    html += '</div><div>';
    
    // Capital Gains Section
    html += '<h2>Capital Gains & Dividends</h2><div class="section">';
    html += '<div class="row"><span class="label">Taxable Account Withdrawal</span><span class="value">' + formatCurrency(yearData.fromTaxable) + '</span></div>';
    html += '<div class="row indent"><span class="label">└ Gain Portion (taxable)</span><span class="value">' + formatCurrency(td.taxableWithdrawalGains || 0) + '</span></div>';
    html += '<div class="row"><span class="label">Qualified Dividends</span><span class="value">' + formatCurrency(td.qualifiedDividends || 0) + '</span></div>';
    html += '<div class="row total"><span class="label">Total Capital Gains</span><span class="value">' + formatCurrency(td.totalCapitalGains || 0) + '</span></div>';
    html += '<div class="row" style="margin-top:10px"><span class="label">Roth Withdrawals (tax-free)</span><span class="value positive">' + formatCurrency(yearData.fromRoth) + '</span></div>';
    html += '</div>';
    
    // Federal Tax Calculation
    html += '<h2>Federal Tax Calculation</h2><div class="section">';
    html += '<div class="row"><span class="label">Tax on Ordinary Income</span><span class="value negative">' + formatCurrency(td.federalOrdinaryTax || 0) + '</span></div>';
    html += '<div class="row"><span class="label">Tax on Capital Gains</span><span class="value negative">' + formatCurrency(td.federalCapGainsTax || 0) + '</span></div>';
    if ((td.niitTax || 0) > 0) {
      html += '<div class="row"><span class="label">Net Investment Income Tax (3.8%)</span><span class="value negative">' + formatCurrency(td.niitTax) + '</span></div>';
    }
    html += '<div class="row total"><span class="label">Total Federal Tax</span><span class="value negative">' + formatCurrency(yearData.federalTax) + '</span></div>';
    html += '</div>';
    
    // Tax Summary
    html += '<h2>Tax Summary</h2><div class="section">';
    html += '<div class="row"><span class="label">Gross Withdrawal</span><span class="value">' + formatCurrency(yearData.grossWithdrawal) + '</span></div>';
    html += '<div class="row"><span class="label">+ Gross Income</span><span class="value">' + formatCurrency(yearData.yearIncome || 0) + '</span></div>';
    html += '<div class="row total"><span class="label">Total Cash In</span><span class="value">' + formatCurrency(yearData.grossWithdrawal + (yearData.yearIncome || 0)) + '</span></div>';
    html += '<div class="row"><span class="label">Federal Tax</span><span class="value negative">-' + formatCurrency(yearData.federalTax) + '</span></div>';
    html += '<div class="row"><span class="label">State Tax</span><span class="value negative">-' + formatCurrency(yearData.stateTax) + '</span></div>';
    html += '<div class="row total"><span class="label">Total Tax</span><span class="value negative">-' + formatCurrency(yearData.totalTax) + '</span></div>';
    html += '<div class="row total"><span class="label">Net After-Tax Cash</span><span class="value positive">' + formatCurrency(yearData.grossWithdrawal + (yearData.yearIncome || 0) - yearData.totalTax) + '</span></div>';
    const effectiveRate = (yearData.grossWithdrawal + (yearData.yearIncome || 0)) > 0 ? ((yearData.totalTax / (yearData.grossWithdrawal + (yearData.yearIncome || 0))) * 100).toFixed(1) : 0;
    html += '<div class="row"><span class="label">Effective Tax Rate</span><span class="value">' + effectiveRate + '%</span></div>';
    html += '</div>';
    
    html += '</div></div>';
    
    // Tax Brackets Section (full width)
    html += '<h2>Tax Brackets (' + yearData.calYear + ')</h2>';
    html += '<div class="grid">';
    
    // Ordinary Income Brackets
    html += '<div class="section"><h3 style="font-size:12px;margin:0 0 10px 0;color:#0f4c5c">Ordinary Income Brackets</h3>';
    html += '<table class="bracket-table"><tr><th>Rate</th><th>From</th><th>To</th><th>Status</th></tr>';
    if (td.ordinaryBrackets) {
      const taxableIncome = td.taxableOrdinaryIncome || 0;
      td.ordinaryBrackets.forEach((bracket, i) => {
        const isCurrentBracket = taxableIncome > bracket.min && (i === td.ordinaryBrackets.length - 1 || taxableIncome <= bracket.max);
        const isAbove = taxableIncome > bracket.max;
        html += '<tr' + (isCurrentBracket ? ' class="current-bracket"' : '') + '>';
        html += '<td>' + (bracket.rate * 100).toFixed(0) + '%</td>';
        html += '<td>' + formatCurrency(bracket.min) + '</td>';
        html += '<td>' + (bracket.max === Infinity ? '∞' : formatCurrency(bracket.max)) + '</td>';
        html += '<td>' + (isCurrentBracket ? '◄ Current' : (isAbove ? '✓' : '')) + '</td>';
        html += '</tr>';
      });
    }
    html += '</table>';
    html += '<p style="font-size:10px;color:#666;margin-top:8px">Taxable Income: ' + formatCurrency(td.taxableOrdinaryIncome || 0) + '</p>';
    html += '</div>';
    
    // Capital Gains Brackets
    html += '<div class="section"><h3 style="font-size:12px;margin:0 0 10px 0;color:#0f4c5c">Capital Gains Brackets</h3>';
    html += '<table class="bracket-table"><tr><th>Rate</th><th>From</th><th>To</th><th>Status</th></tr>';
    if (td.capGainsBrackets) {
      const totalIncome = (td.taxableOrdinaryIncome || 0) + (td.totalCapitalGains || 0);
      td.capGainsBrackets.forEach((bracket, i) => {
        const isCurrentBracket = totalIncome > bracket.min && (i === td.capGainsBrackets.length - 1 || totalIncome <= bracket.max);
        const isAbove = totalIncome > bracket.max;
        html += '<tr' + (isCurrentBracket ? ' class="current-bracket"' : '') + '>';
        html += '<td>' + (bracket.rate * 100).toFixed(0) + '%</td>';
        html += '<td>' + formatCurrency(bracket.min) + '</td>';
        html += '<td>' + (bracket.max === Infinity ? '∞' : formatCurrency(bracket.max)) + '</td>';
        html += '<td>' + (isCurrentBracket ? '◄ Current' : (isAbove ? '✓' : '')) + '</td>';
        html += '</tr>';
      });
    }
    html += '</table>';
    html += '<p style="font-size:10px;color:#666;margin-top:8px">Total Income (for CG brackets): ' + formatCurrency((td.taxableOrdinaryIncome || 0) + (td.totalCapitalGains || 0)) + '</p>';
    html += '</div>';
    
    html += '</div>';
    html += '<div style="margin-top:30px;padding:15px;border:1px solid #ccc;border-radius:8px;background:#f9f9f9"><p style="font-size:10px;color:#666;margin:0;line-height:1.5"><strong>IMPORTANT DISCLOSURE:</strong> The projections and analysis contained in this report are hypothetical in nature, do not reflect actual investment results, and are not guarantees of future results. This analysis is based on assumptions that may not reflect actual market conditions or your personal financial situation. Actual results will vary and may be significantly different from these projections. Monte Carlo simulations show a range of possible outcomes based on historical data and assumptions about future returns, inflation, and taxes. Past performance is not indicative of future results. This report is for informational purposes only and should not be considered investment, tax, or legal advice.</p></div>';
    html += '</body></html>';
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
  };

  // Export year-by-year tax summary table to PDF
  const exportTaxTablePDF = (percentile) => {
    if (!results || !results.percentileDetails || !results.percentileDetails[percentile]) return;
    const data = results.percentileDetails[percentile];
    const percentileLabel = percentile === 'p10' ? '10th' : percentile === 'p25' ? '25th' : percentile === 'p50' ? '50th' : percentile === 'p75' ? '75th' : percentile === 'p90' ? '90th' : '99th';
    
    let html = '<!DOCTYPE html><html><head><title>Tax Summary - ' + percentileLabel + ' Percentile</title>';
    html += '<style>body{font-family:Arial,sans-serif;padding:30px;color:#333;font-size:10px}h1{color:#0f4c5c;font-size:18px}table{width:100%;border-collapse:collapse;margin:15px 0}th{background:#0f4c5c;color:white;padding:6px 4px;text-align:right;font-size:9px}th:first-child,th:nth-child(2){text-align:left}td{padding:4px;border-bottom:1px solid #ddd;text-align:right;font-size:9px}td:first-child,td:nth-child(2){text-align:left}.negative{color:#dc2626}tr:nth-child(even){background:#f9f9f9}.meta{color:#666;font-size:11px;margin-bottom:15px}</style></head><body>';
    
    html += '<h1>Year-by-Year Tax Summary - ' + percentileLabel + ' Percentile</h1>';
    html += '<p class="meta">Generated: ' + new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + '</p>';
    
    html += '<table><tr><th>Year</th><th>Age</th><th>Gross Income</th><th>SS Income</th><th>Taxable SS</th><th>Pre-Tax W/D</th><th>Taxable W/D</th><th>Cap Gains</th><th>Std Deduction</th><th>Taxable Inc</th><th>Fed Tax</th><th>State Tax</th><th>Total Tax</th><th>Eff Rate</th></tr>';
    
    data.forEach(r => {
      const td = r.taxDetails || {};
      const totalCashIn = r.grossWithdrawal + (r.yearIncome || 0);
      const effRate = totalCashIn > 0 ? ((r.totalTax / totalCashIn) * 100).toFixed(1) : '0.0';
      const ageDisplay = filingStatus === 'mfj' ? (r.age > 0 ? r.age : '-') + '/' + (r.age2 > 0 ? r.age2 : '-') : r.age;
      html += '<tr>';
      html += '<td>' + r.calYear + '</td>';
      html += '<td>' + ageDisplay + '</td>';
      html += '<td>' + formatCurrency(r.yearIncome || 0) + '</td>';
      html += '<td>' + formatCurrency(td.socialSecurityIncome || 0) + '</td>';
      html += '<td>' + formatCurrency(td.taxableSocialSecurity || 0) + '</td>';
      html += '<td>' + formatCurrency(r.fromPreTax) + '</td>';
      html += '<td>' + formatCurrency(r.fromTaxable) + '</td>';
      html += '<td>' + formatCurrency(td.totalCapitalGains || 0) + '</td>';
      html += '<td>' + formatCurrency(td.standardDeduction || 0) + '</td>';
      html += '<td>' + formatCurrency(td.taxableOrdinaryIncome || 0) + '</td>';
      html += '<td class="negative">' + formatCurrency(r.federalTax) + '</td>';
      html += '<td class="negative">' + formatCurrency(r.stateTax) + '</td>';
      html += '<td class="negative">' + formatCurrency(r.totalTax) + '</td>';
      html += '<td>' + effRate + '%</td>';
      html += '</tr>';
    });
    html += '</table>';
    html += '<div style="margin-top:30px;padding:15px;border:1px solid #ccc;border-radius:8px;background:#f9f9f9"><p style="font-size:10px;color:#666;margin:0;line-height:1.5"><strong>IMPORTANT DISCLOSURE:</strong> The projections and analysis contained in this report are hypothetical in nature, do not reflect actual investment results, and are not guarantees of future results. This analysis is based on assumptions that may not reflect actual market conditions or your personal financial situation. Actual results will vary and may be significantly different from these projections. Monte Carlo simulations show a range of possible outcomes based on historical data and assumptions about future returns, inflation, and taxes. Past performance is not indicative of future results. This report is for informational purposes only and should not be considered investment, tax, or legal advice.</p></div>';
    html += '</body></html>';
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
  };

  // Export account balances over time to PDF (with chart representation)
  const exportAccountBalancesPDF = (percentile) => {
    if (!results || !results.percentileDetails || !results.percentileDetails[percentile]) return;
    const data = results.percentileDetails[percentile];
    const percentileLabel = percentile === 'p10' ? '10th' : percentile === 'p25' ? '25th' : percentile === 'p50' ? '50th' : percentile === 'p75' ? '75th' : percentile === 'p90' ? '90th' : '99th';
    
    let html = '<!DOCTYPE html><html><head><title>Account Balances - ' + percentileLabel + ' Percentile</title>';
    html += '<style>';
    html += '@media print { body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } }';
    html += 'body{font-family:Arial,sans-serif;padding:30px;color:#333;font-size:11px}';
    html += 'h1{color:#0f4c5c;font-size:18px}';
    html += 'h2{color:#0f4c5c;font-size:14px;margin-top:25px}';
    html += 'table{width:100%;border-collapse:collapse;margin:15px 0}';
    html += 'th{background:#0f4c5c !important;color:white;padding:8px;text-align:right;font-size:11px;-webkit-print-color-adjust:exact;print-color-adjust:exact}';
    html += 'th:first-child,th:nth-child(2){text-align:left}';
    html += 'td{padding:6px 8px;border-bottom:1px solid #ddd;text-align:right;font-size:11px}';
    html += 'td:first-child,td:nth-child(2){text-align:left}';
    html += 'tr:nth-child(even){background:#f9f9f9}';
    html += '.meta{color:#666;font-size:11px;margin-bottom:15px}';
    html += '.summary{display:table;width:100%;margin:20px 0}';
    html += '.summary-row{display:table-row}';
    html += '.summary-box{display:table-cell;background:#f5f5f5 !important;padding:15px 25px;text-align:center;border-left:4px solid;-webkit-print-color-adjust:exact;print-color-adjust:exact}';
    html += '.summary-box.pretax{border-color:#f97316 !important}';
    html += '.summary-box.roth{border-color:#22c55e !important}';
    html += '.summary-box.taxable{border-color:#3b82f6 !important}';
    html += '.summary-label{font-size:10px;color:#666;text-transform:uppercase}';
    html += '.summary-value{font-size:18px;font-weight:bold;margin-top:5px}';
    html += '.pretax .summary-value{color:#f97316}';
    html += '.roth .summary-value{color:#22c55e}';
    html += '.taxable .summary-value{color:#3b82f6}';
    html += '.chart-row{display:table;width:100%;margin:4px 0}';
    html += '.chart-cell{display:table-cell;vertical-align:middle}';
    html += '.chart-label{width:60px;font-size:10px}';
    html += '.chart-bars{width:500px}';
    html += '.chart-total{width:90px;font-size:10px;text-align:right}';
    html += '.bar-container{height:22px;background:#f0f0f0;position:relative}';
    html += '.bar{height:22px;display:inline-block;vertical-align:top;-webkit-print-color-adjust:exact;print-color-adjust:exact}';
    html += '.bar-pretax{background-color:#f97316 !important}';
    html += '.bar-roth{background-color:#22c55e !important}';
    html += '.bar-taxable{background-color:#3b82f6 !important}';
    html += '.legend{margin-top:15px;font-size:10px}';
    html += '.legend-box{display:inline-block;width:14px;height:14px;margin-right:5px;vertical-align:middle;-webkit-print-color-adjust:exact;print-color-adjust:exact}';
    html += '</style></head><body>';
    
    html += '<h1>Account Balances Over Time - ' + percentileLabel + ' Percentile</h1>';
    html += '<p class="meta">Generated: ' + new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + '</p>';
    html += '<p class="meta">Final Portfolio Value: ' + formatCurrency(results.percentileEnding[percentile]) + '</p>';
    
    // Starting balances summary
    html += '<h2>Starting Balances</h2>';
    html += '<div class="summary"><div class="summary-row">';
    html += '<div class="summary-box pretax"><div class="summary-label">Pre-Tax</div><div class="summary-value">' + formatCurrency(preTaxBalance) + '</div></div>';
    html += '<div class="summary-box roth"><div class="summary-label">Roth</div><div class="summary-value">' + formatCurrency(rothBalance) + '</div></div>';
    html += '<div class="summary-box taxable"><div class="summary-label">Taxable</div><div class="summary-value">' + formatCurrency(taxableBalance) + '</div></div>';
    html += '</div></div>';
    
    // Visual bar chart representation
    html += '<h2>Balance Composition Over Time</h2>';
    const maxBalance = Math.max(...data.map(d => d.endBalance || 0), preTaxBalance + rothBalance + taxableBalance);
    const barMaxWidth = 500; // pixels
    
    // Helper function to calculate bar widths
    const getBarWidth = (value) => Math.max(0, Math.round((value / maxBalance) * barMaxWidth));
    
    // Initial year
    const initialTotal = preTaxBalance + rothBalance + taxableBalance;
    html += '<div class="chart-row">';
    html += '<div class="chart-cell chart-label"><strong>' + currentYear + '</strong></div>';
    html += '<div class="chart-cell chart-bars"><div class="bar-container">';
    html += '<span class="bar bar-pretax" style="width:' + getBarWidth(preTaxBalance) + 'px"></span>';
    html += '<span class="bar bar-roth" style="width:' + getBarWidth(rothBalance) + 'px"></span>';
    html += '<span class="bar bar-taxable" style="width:' + getBarWidth(taxableBalance) + 'px"></span>';
    html += '</div></div>';
    html += '<div class="chart-cell chart-total">' + formatCurrency(initialTotal) + '</div>';
    html += '</div>';
    
    // Each year
    data.forEach((d, idx) => {
      if (idx % 2 === 0 || idx === data.length - 1) { // Show every 2nd year plus last
        const total = d.endBalance || 0;
        html += '<div class="chart-row">';
        html += '<div class="chart-cell chart-label">' + d.calYear + '</div>';
        html += '<div class="chart-cell chart-bars"><div class="bar-container">';
        html += '<span class="bar bar-pretax" style="width:' + getBarWidth(d.endPreTax || 0) + 'px"></span>';
        html += '<span class="bar bar-roth" style="width:' + getBarWidth(d.endRoth || 0) + 'px"></span>';
        html += '<span class="bar bar-taxable" style="width:' + getBarWidth(d.endTaxable || 0) + 'px"></span>';
        html += '</div></div>';
        html += '<div class="chart-cell chart-total">' + formatCurrency(total) + '</div>';
        html += '</div>';
      }
    });
    
    // Legend
    html += '<div class="legend">';
    html += '<span class="legend-box" style="background-color:#f97316 !important"></span>Pre-Tax &nbsp;&nbsp;&nbsp;';
    html += '<span class="legend-box" style="background-color:#22c55e !important"></span>Roth &nbsp;&nbsp;&nbsp;';
    html += '<span class="legend-box" style="background-color:#3b82f6 !important"></span>Taxable';
    html += '</div>';
    
    // Detailed table
    html += '<h2>Detailed Year-by-Year Balances</h2>';
    html += '<table><tr><th>Year</th><th>Age</th><th>Pre-Tax</th><th>Roth</th><th>Taxable</th><th>Total</th><th>Pre-Tax %</th><th>Roth %</th><th>Taxable %</th></tr>';
    
    // Initial row
    const initPct = initialTotal > 0;
    html += '<tr style="background:#e0e7ff !important;-webkit-print-color-adjust:exact;print-color-adjust:exact">';
    html += '<td>' + currentYear + '</td>';
    const initialAgeDisplay = filingStatus === 'mfj' ? client1Age + '/' + client2Age : client1Age;
    html += '<td>' + initialAgeDisplay + '</td>';
    html += '<td style="color:#ea580c">' + formatCurrency(preTaxBalance) + '</td>';
    html += '<td style="color:#16a34a">' + formatCurrency(rothBalance) + '</td>';
    html += '<td style="color:#2563eb">' + formatCurrency(taxableBalance) + '</td>';
    html += '<td><strong>' + formatCurrency(initialTotal) + '</strong></td>';
    html += '<td>' + (initPct ? ((preTaxBalance / initialTotal) * 100).toFixed(1) : '0.0') + '%</td>';
    html += '<td>' + (initPct ? ((rothBalance / initialTotal) * 100).toFixed(1) : '0.0') + '%</td>';
    html += '<td>' + (initPct ? ((taxableBalance / initialTotal) * 100).toFixed(1) : '0.0') + '%</td>';
    html += '</tr>';
    
    data.forEach(d => {
      const total = d.endBalance || 0;
      const ageDisplay = filingStatus === 'mfj' ? (d.age > 0 ? d.age : '-') + '/' + (d.age2 > 0 ? d.age2 : '-') : d.age;
      html += '<tr>';
      html += '<td>' + d.calYear + '</td>';
      html += '<td>' + ageDisplay + '</td>';
      html += '<td style="color:#ea580c">' + formatCurrency(d.endPreTax || 0) + '</td>';
      html += '<td style="color:#16a34a">' + formatCurrency(d.endRoth || 0) + '</td>';
      html += '<td style="color:#2563eb">' + formatCurrency(d.endTaxable || 0) + '</td>';
      html += '<td><strong>' + formatCurrency(total) + '</strong></td>';
      html += '<td>' + (total > 0 ? ((d.endPreTax || 0) / total * 100).toFixed(1) : '0.0') + '%</td>';
      html += '<td>' + (total > 0 ? ((d.endRoth || 0) / total * 100).toFixed(1) : '0.0') + '%</td>';
      html += '<td>' + (total > 0 ? ((d.endTaxable || 0) / total * 100).toFixed(1) : '0.0') + '%</td>';
      html += '</tr>';
    });
    html += '</table>';
    html += '<div style="margin-top:30px;padding:15px;border:1px solid #ccc;border-radius:8px;background:#f9f9f9"><p style="font-size:10px;color:#666;margin:0;line-height:1.5"><strong>IMPORTANT DISCLOSURE:</strong> The projections and analysis contained in this report are hypothetical in nature, do not reflect actual investment results, and are not guarantees of future results. This analysis is based on assumptions that may not reflect actual market conditions or your personal financial situation. Actual results will vary and may be significantly different from these projections. Monte Carlo simulations show a range of possible outcomes based on historical data and assumptions about future returns, inflation, and taxes. Past performance is not indicative of future results. This report is for informational purposes only and should not be considered investment, tax, or legal advice.</p></div>';
    html += '</body></html>';
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-6">
      <div className="max-w-7xl mx-auto">
        <div className="text-center mb-10">
          <h1 className="font-display text-5xl font-semibold mb-3 bg-gradient-to-r from-amber-200 via-yellow-300 to-amber-200 bg-clip-text text-transparent">Financial Planning Calculator</h1>
          <p className="text-slate-400 text-lg">Monte Carlo simulation with dynamic guardrail analysis</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div className="card card-accent p-6">
            <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Basic Information</h2>
            <div className="space-y-4">
              <div><label className="block text-sm text-slate-400 mb-2">Client 1 Name</label><input type="text" value={client1Name} onChange={e => setClient1Name(e.target.value)} placeholder="Enter name" /></div>
              <div><label className="block text-sm text-slate-400 mb-2">Client 1 Age</label><input type="text" value={client1Age} onChange={e => { const v = e.target.value; if (v === '' || /^\d+$/.test(v)) setClient1Age(v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') setClient1Age(60); }} /></div>
              <div><label className="block text-sm text-slate-400 mb-2">Client 1 Plan Length (years)</label><input type="text" value={client1PlanLength} onChange={e => { const v = e.target.value; if (v === '' || /^\d+$/.test(v)) setClient1PlanLength(v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') setClient1PlanLength(30); }} /></div>
              <div>
                <label className="block text-sm text-slate-400 mb-2">Client 1 RMD Start Age</label>
                <div className="flex gap-4">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="client1RmdAge" checked={client1RmdAge === 73} onChange={() => setClient1RmdAge(73)} className="accent-amber-500" />
                    <span className="text-sm">73 (born 1951-1959)</span>
                  </label>
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="client1RmdAge" checked={client1RmdAge === 75} onChange={() => setClient1RmdAge(75)} className="accent-amber-500" />
                    <span className="text-sm">75 (born 1960+)</span>
                  </label>
                </div>
              </div>
              <div><label className="block text-sm text-slate-400 mb-2">Current Year</label><input type="text" value={currentYear} onChange={e => { const v = e.target.value; if (v === '' || /^\d+$/.test(v)) setCurrentYear(v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') setCurrentYear(2026); }} /></div>
              <div>
                <label className="block text-sm text-slate-400 mb-2">Filing Status</label>
                <div className="flex flex-col gap-2">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="filingStatus" checked={filingStatus === 'single'} onChange={() => setFilingStatus('single')} className="accent-amber-500" />
                    <span className="text-sm">Single</span>
                  </label>
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="filingStatus" checked={filingStatus === 'mfj'} onChange={() => setFilingStatus('mfj')} className="accent-amber-500" />
                    <span className="text-sm">Married Filing Jointly</span>
                  </label>
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="filingStatus" checked={filingStatus === 'hoh'} onChange={() => setFilingStatus('hoh')} className="accent-amber-500" />
                    <span className="text-sm">Head of Household</span>
                  </label>
                </div>
              </div>
              {filingStatus === 'mfj' && (
                <div className="pt-3 border-t border-slate-700 space-y-4">
                  <div><label className="block text-sm text-slate-400 mb-2">Client 2 Name</label><input type="text" value={client2Name} onChange={e => setClient2Name(e.target.value)} placeholder="Enter name" /></div>
                  <div><label className="block text-sm text-slate-400 mb-2">Client 2 Age</label><input type="text" value={client2Age} onChange={e => { const v = e.target.value; if (v === '' || /^\d+$/.test(v)) setClient2Age(v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') setClient2Age(58); }} /></div>
                  <div><label className="block text-sm text-slate-400 mb-2">Client 2 Plan Length (years)</label><input type="text" value={client2PlanLength} onChange={e => { const v = e.target.value; if (v === '' || /^\d+$/.test(v)) setClient2PlanLength(v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') setClient2PlanLength(32); }} /></div>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Client 2 RMD Start Age</label>
                    <div className="flex gap-4">
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="client2RmdAge" checked={client2RmdAge === 73} onChange={() => setClient2RmdAge(73)} className="accent-amber-500" />
                        <span className="text-sm">73 (born 1951-1959)</span>
                      </label>
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="client2RmdAge" checked={client2RmdAge === 75} onChange={() => setClient2RmdAge(75)} className="accent-amber-500" />
                        <span className="text-sm">75 (born 1960+)</span>
                      </label>
                    </div>
                  </div>
                </div>
              )}
              {filingStatus === 'mfj' && (
                <div className="pt-2 border-t border-slate-700">
                  <div className="flex justify-between text-sm"><span className="text-slate-400">Plan Length Used:</span><span className="text-amber-200 font-semibold">{planLength} years</span></div>
                </div>
              )}
            </div>
          </div>
          <div className="card card-accent p-6">
            <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Spending & Guardrails</h2>
            <div className="space-y-4">
              <div><label className="block text-sm text-slate-400 mb-2">Base Annual Spending (After-Tax)</label><CurrencyInput value={baseSpending} onChange={setBaseSpending} /></div>
              {filingStatus === 'mfj' && <div><label className="block text-sm text-slate-400 mb-2">Survivor Annual Spending (After-Tax)</label><CurrencyInput value={survivorSpending !== null ? survivorSpending : baseSpending} onChange={(v) => setSurvivorSpending(v)} /><p className="text-xs text-slate-500 mt-1">Spending after one spouse passes. Defaults to base spending if unchanged.</p></div>}
              <div><label className="block text-sm text-slate-400 mb-2">Target Success Rate (%)</label><PercentageInput value={targetSuccessRate} onChange={setTargetSuccessRate} /></div>
              <div><label className="block text-sm text-slate-400 mb-2">Upper Guardrail (%)</label><PercentageInput value={upperGuardrail} onChange={setUpperGuardrail} /></div>
              <div><label className="block text-sm text-slate-400 mb-2">Lower Guardrail (%)</label><PercentageInput value={lowerGuardrail} onChange={setLowerGuardrail} /></div>
            </div>
          </div>
          <div className="card card-accent p-6">
            <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Market Assumptions</h2>
            <div className="space-y-4">
              <div><label className="block text-sm text-slate-400 mb-2">Base Inflation (%)</label><PercentageInput value={baseInflation} onChange={setBaseInflation} /></div>
            </div>
          </div>
        </div>

        <div className="card card-accent p-6 mb-8">
          <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Asset Class Allocation</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {ASSET_CLASSES.map((name, idx) => (
              <div key={idx} className="bg-slate-800/50 rounded-lg p-3">
                <div className="flex items-center justify-between gap-2">
                  <div className="flex-1 min-w-0">
                    <div className="text-sm text-slate-300 truncate">{name}</div>
                    <div className="text-xs text-slate-500">Geo. Return: {(ASSET_RETURNS[idx] * 100).toFixed(2)}% | StdDev: {(ASSET_STDDEVS[idx] * 100).toFixed(1)}%</div>
                  </div>
                  <div className="flex items-center gap-1 shrink-0">
                    <input type="text" value={assetAllocations[idx]} placeholder="0" onChange={e => { const v = e.target.value; if (v === '' || /^\d+$/.test(v)) { const n = parseInt(v); if (v === '' || (!isNaN(n) && n >= 0 && n <= 100)) updateAllocation(idx, v); } }} className="w-16 text-right" style={{padding: '4px 8px'}} />
                    <span className="text-slate-500 text-sm">%</span>
                  </div>
                </div>
              </div>
            ))}
          </div>
          <div className="mt-4 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <span className="text-sm text-slate-400">Total:</span>
              <span className={`text-lg font-semibold ${allocationsValid ? 'text-green-400' : allocationSum > 100 ? 'text-red-400' : 'text-amber-400'}`}>{allocationSum}%</span>
              {!allocationsValid && <span className="text-xs text-red-400">{allocationSum > 100 ? 'Exceeds 100%' : `${100 - allocationSum}% remaining`}</span>}
            </div>
            <div className="bg-slate-800/50 rounded-lg px-4 py-2 text-xs text-slate-500 space-y-1">
              <div className="flex justify-between gap-6"><span>Portfolio Geometric Return:</span><span className={`font-semibold ${allocationsValid ? 'text-green-300' : 'text-slate-500'}`}>{allocationsValid ? expectedReturn.toFixed(2) + '%' : '-'}</span></div>
              <div className="flex justify-between gap-6"><span>Portfolio Std Deviation:</span><span className={`font-semibold ${allocationsValid ? 'text-green-300' : 'text-slate-500'}`}>{allocationsValid ? stdDev.toFixed(2) + '%' : '-'}</span></div>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <div className="card card-accent p-6">
            <div className="flex justify-between items-center mb-5">
              <h2 className="font-display text-xl font-semibold text-amber-200">Accounts</h2>
              <button onClick={addAccount} className="text-sm bg-amber-500/20 hover:bg-amber-500/30 text-amber-200 px-3 py-1 rounded-lg transition-colors">+ Add Account</button>
            </div>
            <div className="space-y-3">
              {accounts.map((account) => (
                <div key={account.id} className="bg-slate-800/50 rounded-lg p-3">
                  <div className="flex gap-2 mb-2">
                    <select value={account.type} onChange={e => updateAccount(account.id, 'type', e.target.value)} className="flex-grow text-sm">
                      <option value="pretax">Pre-Tax (401k/IRA)</option>
                      <option value="roth">Roth</option>
                      <option value="taxable">Taxable (Brokerage)</option>
                    </select>
                    {filingStatus === 'mfj' && (
                      <select value={account.owner} onChange={e => updateAccount(account.id, 'owner', e.target.value)} className="w-28 text-sm">
                        {account.type === 'taxable' && <option value="joint">Joint</option>}
                        <option value="client1">{client1Name || 'Client 1'}</option>
                        <option value="client2">{client2Name || 'Client 2'}</option>
                      </select>
                    )}
                    <button onClick={() => removeAccount(account.id)} className="text-red-400 hover:text-red-300 px-2" title="Remove">×</button>
                  </div>
                  <div className="flex gap-2">
                    <div className="flex-grow">
                      <label className="block text-xs text-slate-500 mb-1">Balance</label>
                      <CurrencyInput value={account.balance} onChange={v => updateAccount(account.id, 'balance', v)} />
                    </div>
                    {account.type === 'taxable' && (
                      <div className="w-28">
                        <label className="block text-xs text-slate-500 mb-1">Cost Basis</label>
                        <CurrencyInput value={account.costBasis} onChange={v => updateAccount(account.id, 'costBasis', v)} />
                      </div>
                    )}
                    {account.type === 'taxable' && (
                      <div className="w-24">
                        <label className="block text-xs text-slate-500 mb-1">% Stocks</label>
                        <PercentageInput value={account.stockAllocation || 60} onChange={v => updateAccount(account.id, 'stockAllocation', v)} />
                      </div>
                    )}
                  </div>
                </div>
              ))}
              {accounts.length === 0 && (
                <p className="text-slate-500 text-sm text-center py-4">No accounts added. Click "+ Add Account" to get started.</p>
              )}
            </div>
            {accounts.some(a => a.type === 'taxable') && (
              <div className="mt-3 bg-slate-800/30 rounded-lg p-2">
                <p className="text-xs text-slate-500">Weighted avg stock allocation for taxable accounts: <span className="text-amber-200">{stockAllocation.toFixed(1)}%</span> (used for dividend/interest estimates)</p>
              </div>
            )}
            <div className="pt-3 mt-3 border-t border-slate-700 space-y-1">
              <div className="flex justify-between text-sm"><span className="text-slate-400">Pre-Tax Total:</span><span className="text-white">{formatCurrency(preTaxBalance)}</span></div>
              <div className="flex justify-between text-sm"><span className="text-slate-400">Roth Total:</span><span className="text-white">{formatCurrency(rothBalance)}</span></div>
              <div className="flex justify-between text-sm"><span className="text-slate-400">Taxable Total:</span><span className="text-white">{formatCurrency(taxableBalance)}</span></div>
              <div className="flex justify-between text-sm pt-2 border-t border-slate-700"><span className="text-slate-400">Total Portfolio:</span><span className="text-amber-200 font-semibold">{formatCurrency(totalPortfolio)}</span></div>
              <div className="flex justify-between text-sm"><span className="text-slate-400">Unrealized Gains:</span><span className="text-green-300">{formatCurrency(taxableBalance - taxableBasis)}</span></div>
            </div>
          </div>
          <div className="card card-accent p-6">
            <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Tax Settings</h2>
            <div className="space-y-4">
              <div><label className="block text-sm text-slate-400 mb-2">State Tax Rate (%)</label><PercentageInput value={stateTaxRate} onChange={setStateTaxRate} /></div>
              <div className="bg-slate-800/50 rounded-lg p-3 mt-4">
                <p className="text-xs text-slate-400 mb-2">Tax Assumptions:</p>
                <ul className="text-xs text-slate-500 space-y-1">
                  <li>• Filing Status: {filingStatus === 'single' ? 'Single' : filingStatus === 'mfj' ? 'Married Filing Jointly' : 'Head of Household'}</li>
                  <li>• 2026 federal brackets (inflation-adjusted)</li>
                  <li>• Standard deduction: {formatCurrency(STANDARD_DEDUCTION_2026[filingStatus])}</li>
                  <li>• RMDs required at age 73+ (SECURE 2.0)</li>
                  <li>• Qualified dividends (1%): 0%/15%/20% cap gains rates</li>
                  <li>• Bond interest (4%): ordinary income rates</li>
                  <li>• Capital gains: 0%/15%/20% based on income</li>
                  <li>• Bracket-filling: RMDs → Fill 12% bracket → Taxable → Pre-Tax → Roth</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div className="card card-accent p-6 mb-6">
          <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Spending Mode</h2>
          <div className="flex gap-6 mb-4">
            <label className="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="spendingMode" checked={spendingMode === 'linear'} onChange={() => setSpendingMode('linear')} className="accent-amber-500" />
              <span className="text-slate-300">Linear (constant inflation)</span>
            </label>
            <label className="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="spendingMode" checked={spendingMode === 'smile'} onChange={() => setSpendingMode('smile')} className="accent-amber-500" />
              <span className="text-slate-300">Spending Smile</span>
            </label>
          </div>
          {spendingMode === 'smile' && (
            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
              <p className="text-sm text-slate-400 mb-4">Base spending grows at reduced inflation rates during mid-retirement, then partially recovers in late retirement.</p>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label className="block text-xs text-slate-400 mb-1">Phase 2 Start Year</label>
                  <input type="number" value={phase2Year} onChange={e => setPhase2Year(parseInt(e.target.value) || 2035)} />
                </div>
                <div>
                  <label className="block text-xs text-slate-400 mb-1">Phase 2 Reduction (%)</label>
                  <PercentageInput value={phase2Reduction} onChange={setPhase2Reduction} />
                </div>
                <div>
                  <label className="block text-xs text-slate-400 mb-1">Phase 3 Start Year</label>
                  <input type="number" value={phase3Year} onChange={e => setPhase3Year(parseInt(e.target.value) || 2050)} />
                </div>
                <div>
                  <label className="block text-xs text-slate-400 mb-1">Phase 3 Reduction (%)</label>
                  <PercentageInput value={phase3Reduction} onChange={setPhase3Reduction} />
                </div>
              </div>
              <p className="text-xs text-slate-500 mt-3">
                Phase 1 (until {phase2Year}): {baseInflation}% inflation | 
                Phase 2 ({phase2Year}-{phase3Year}): {(baseInflation - phase2Reduction).toFixed(1)}% inflation | 
                Phase 3 ({phase3Year}+): {(baseInflation - phase3Reduction).toFixed(1)}% inflation
              </p>
            </div>
          )}
        </div>

        <div className="card card-accent p-6 mb-6">
          <div className="flex justify-between items-center mb-5">
            <h2 className="font-display text-xl font-semibold text-amber-200">Spending Goals</h2>
            <button onClick={addGoal} className="px-4 py-2 bg-amber-500/20 hover:bg-amber-500/30 rounded-lg text-amber-200 text-sm font-medium">+ Add Goal</button>
          </div>
          {goals.length === 0 ? <p className="text-slate-500 text-center py-6">No goals added yet.</p> : goals.map(goal => (
            <div key={goal.id} className="bg-slate-800/50 rounded-xl p-4 mb-4 border border-slate-700/50">
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-9 gap-4 items-end">
                <div className="col-span-2"><label className="block text-xs text-slate-400 mb-1">Name</label><input type="text" value={goal.name} onChange={e => updateGoal(goal.id, 'name', e.target.value)} /></div>
                <div><label className="block text-xs text-slate-400 mb-1">Amount</label><CurrencyInput value={goal.amount} onChange={val => updateGoal(goal.id, 'amount', val)} /></div>
                <div className="col-span-2">
                  <label className="block text-xs text-slate-400 mb-2">Type</label>
                  <div className="flex gap-3 text-xs">
                    <label className="flex items-center gap-1 cursor-pointer"><input type="radio" name={`goalType-${goal.id}`} checked={goal.goalType === 'onetime'} onChange={() => updateGoal(goal.id, 'goalType', 'onetime')} className="accent-amber-500" /><span className="text-slate-300">One-time</span></label>
                    <label className="flex items-center gap-1 cursor-pointer"><input type="radio" name={`goalType-${goal.id}`} checked={goal.goalType === 'annual'} onChange={() => updateGoal(goal.id, 'goalType', 'annual')} className="accent-amber-500" /><span className="text-slate-300">Annual</span></label>
                    <label className="flex items-center gap-1 cursor-pointer"><input type="radio" name={`goalType-${goal.id}`} checked={goal.goalType === 'every'} onChange={() => updateGoal(goal.id, 'goalType', 'every')} className="accent-amber-500" /><span className="text-slate-300">Every X yrs</span></label>
                  </div>
                </div>
                <div><label className="block text-xs text-slate-400 mb-1">Start Year</label><input type="number" value={goal.startYear} onChange={e => { const v = e.target.value; updateGoal(goal.id, 'startYear', v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') updateGoal(goal.id, 'startYear', currentYear); }} /></div>
                <div><label className="block text-xs text-slate-400 mb-1">Every X Yrs</label><input type="number" value={goal.frequency} onChange={e => { const v = e.target.value; updateGoal(goal.id, 'frequency', v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') updateGoal(goal.id, 'frequency', 5); }} min="1" disabled={goal.goalType !== 'every'} style={{opacity: goal.goalType === 'every' ? 1 : 0.4}} /></div>
                <div><label className="block text-xs text-slate-400 mb-1">End Year</label><input type="number" value={goal.endYear} onChange={e => { const v = e.target.value; updateGoal(goal.id, 'endYear', v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') updateGoal(goal.id, 'endYear', currentYear + planLength); }} disabled={goal.continueThrough || goal.goalType === 'onetime'} style={{opacity: goal.goalType === 'onetime' ? 0.4 : 1}} /></div>
                <div className="flex items-center gap-2"><input type="checkbox" className="checkbox-custom" checked={goal.continueThrough} onChange={e => updateGoal(goal.id, 'continueThrough', e.target.checked)} disabled={goal.goalType === 'onetime'} style={{opacity: goal.goalType === 'onetime' ? 0.4 : 1}} /><span className="text-xs text-slate-400" style={{opacity: goal.goalType === 'onetime' ? 0.4 : 1}}>To end</span></div>
              </div>
              <div className="flex gap-4 mt-3 items-end justify-between">
                <div className="w-24"><label className="block text-xs text-slate-400 mb-1">Inflation %</label><PercentageInputNullable value={goal.customInflation} onChange={val => updateGoal(goal.id, 'customInflation', val)} placeholder={baseInflation.toString()} /></div>
                <button onClick={() => removeGoal(goal.id)} className="px-3 py-2 bg-red-500/20 rounded-lg text-red-300 text-sm">Remove</button>
              </div>
            </div>
          ))}
        </div>

        <div className="card card-accent p-6 mb-6">
          <div className="flex justify-between items-center mb-5">
            <h2 className="font-display text-xl font-semibold text-amber-200">Income Sources</h2>
            <button onClick={addIncomeSource} className="px-4 py-2 bg-amber-500/20 hover:bg-amber-500/30 rounded-lg text-amber-200 text-sm font-medium">+ Add Income</button>
          </div>
          {incomeSources.length === 0 ? <p className="text-slate-500 text-center py-6">No income sources added yet.</p> : incomeSources.map(income => (
            <div key={income.id} className="bg-slate-800/50 rounded-xl p-4 mb-4 border border-slate-700/50">
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 items-end">
                <div className="col-span-2"><label className="block text-xs text-slate-400 mb-1">Name</label><input type="text" value={income.name} onChange={e => updateIncomeSource(income.id, 'name', e.target.value)} /></div>
                <div><label className="block text-xs text-slate-400 mb-1">Amount</label><CurrencyInput value={income.amount} onChange={val => updateIncomeSource(income.id, 'amount', val)} /></div>
                {filingStatus === 'mfj' && (
                  <div>
                    <label className="block text-xs text-slate-400 mb-1">Owner</label>
                    <select value={income.owner || 'joint'} onChange={e => updateIncomeSource(income.id, 'owner', e.target.value)} className="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                      <option value="joint">Joint</option>
                      <option value="client1">{client1Name || 'Client 1'}</option>
                      <option value="client2">{client2Name || 'Client 2'}</option>
                    </select>
                  </div>
                )}
                <div><label className="block text-xs text-slate-400 mb-1">Start Year</label><input type="number" value={income.startYear} onChange={e => { const v = e.target.value; updateIncomeSource(income.id, 'startYear', v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') updateIncomeSource(income.id, 'startYear', currentYear); }} /></div>
                <div><label className="block text-xs text-slate-400 mb-1">End Year</label><input type="number" value={income.endYear} onChange={e => { const v = e.target.value; updateIncomeSource(income.id, 'endYear', v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') updateIncomeSource(income.id, 'endYear', currentYear + planLength); }} disabled={income.continueThrough} /></div>
                <div className="flex items-center gap-2"><input type="checkbox" className="checkbox-custom" checked={income.continueThrough} onChange={e => updateIncomeSource(income.id, 'continueThrough', e.target.checked)} /><span className="text-xs text-slate-400">To end</span></div>
              </div>
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 items-end mt-3">
                <div className="flex items-center gap-2">
                  <input type="checkbox" className="checkbox-custom" checked={income.isTaxFree || false} onChange={e => updateIncomeSource(income.id, 'isTaxFree', e.target.checked)} />
                  <span className="text-xs text-slate-400">Tax-Free</span>
                </div>
                <div className="flex items-center gap-2">
                  <input type="checkbox" className="checkbox-custom" checked={income.isSocialSecurity || false} onChange={e => updateIncomeSource(income.id, 'isSocialSecurity', e.target.checked)} disabled={income.isTaxFree} />
                  <span className="text-xs text-slate-400">Social Security</span>
                </div>
                <div><label className="block text-xs text-slate-400 mb-1">Inflation</label><PercentageInputNullable value={income.customInflation} onChange={val => updateIncomeSource(income.id, 'customInflation', val)} placeholder={baseInflation.toString()} /></div>
                <div className="lg:col-start-6 flex justify-end"><button onClick={() => removeIncomeSource(income.id)} className="px-3 py-2 bg-red-500/20 rounded-lg text-red-300">✕</button></div>
              </div>
            </div>
          ))}
          <p className="text-xs text-slate-500 mt-2">
            <strong>Tax Treatment:</strong> Regular income is taxed as ordinary income. Tax-Free income is not taxed. Social Security is taxed at up to 85% (based on provisional income).
            {filingStatus === 'mfj' && <> <strong>Owner:</strong> Income assigned to a specific spouse stops when their plan ends. <strong>SS Survivor Benefit:</strong> When a spouse passes, the survivor receives the higher of their own SS or the deceased's SS.</>}
          </p>
        </div>

        <div className="card card-accent p-6 mb-8">
          <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Simulation Settings</h2>
          <div className="flex items-center gap-6">
            <span className="text-sm text-slate-400">Simulations:</span>
            <input type="range" min="1000" max="5000" step="500" value={numSimulations} onChange={e => setNumSimulations(parseInt(e.target.value))} className="flex-1" />
            <span className="text-amber-200 font-semibold">{numSimulations.toLocaleString()}</span>
          </div>
        </div>

        <div className="flex flex-col items-center gap-3 mb-10">
          {!allocationsValid && (
            <div className="text-sm text-red-400 bg-red-400/10 border border-red-400/30 rounded-lg px-4 py-2">
              Asset class allocations must sum to 100% (currently {allocationSum}%)
            </div>
          )}
          <div className="flex gap-4">
            <button onClick={calculate} disabled={isCalculating || !allocationsValid} className="btn-primary flex items-center gap-3" style={!allocationsValid ? {opacity: 0.5, cursor: 'not-allowed'} : {}}>
              {isCalculating ? <><div className="loading-spinner"></div>Calculating...</> : '🎲 Calculate'}
            </button>
            {results && <button onClick={exportPDF} className="btn-secondary">📄 Export PDF</button>}
          </div>
        </div>

        {results && (
          <div className="space-y-8">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="card result-card p-6">
                <div className="text-sm text-amber-200/70 uppercase mb-2">Success Probability</div>
                <div className="text-4xl font-display font-semibold text-amber-100">{(results.currentSuccess * 100).toFixed(1)}%</div>
                <div className="text-sm text-slate-400 mt-2">Based on {numSimulations.toLocaleString()} simulations</div>
              </div>
              <div className="card guardrail-upper p-6">
                <div className="text-sm text-green-300/70 uppercase mb-2">Upper Guardrail ({upperGuardrail}%)</div>
                <div className="space-y-2">
                  <div className="flex justify-between"><span className="text-slate-300">Portfolio:</span><span className="font-semibold text-green-200">{formatCurrency(results.upperGuardrailPortfolio)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-300">New Spending:</span><span className="font-semibold text-green-200">{formatCurrency(results.upperGuardrailSpending)}</span></div>
                  {results.survivorRatio != null && <div className="flex justify-between"><span className="text-slate-300">Survivor Spending:</span><span className="font-semibold text-green-200">{formatCurrency(results.upperGuardrailSpending * results.survivorRatio)}</span></div>}
                  <div className="flex justify-between pt-2 border-t border-green-500/20"><span className="text-slate-400 text-sm">Change:</span><span className="font-semibold text-green-300">+{formatCurrency(results.upperGuardrailSpending - baseSpending)}</span></div>
                </div>
              </div>
              <div className="card guardrail-lower p-6">
                <div className="text-sm text-orange-300/70 uppercase mb-2">Lower Guardrail ({lowerGuardrail}%)</div>
                <div className="space-y-2">
                  <div className="flex justify-between"><span className="text-slate-300">Portfolio:</span><span className="font-semibold text-orange-200">{formatCurrency(results.lowerGuardrailPortfolio)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-300">New Spending:</span><span className="font-semibold text-orange-200">{formatCurrency(results.lowerGuardrailSpending)}</span></div>
                  {results.survivorRatio != null && <div className="flex justify-between"><span className="text-slate-300">Survivor Spending:</span><span className="font-semibold text-orange-200">{formatCurrency(results.lowerGuardrailSpending * results.survivorRatio)}</span></div>}
                  <div className="flex justify-between pt-2 border-t border-orange-500/20"><span className="text-slate-400 text-sm">Change:</span><span className="font-semibold text-orange-300">{formatCurrency(results.lowerGuardrailSpending - baseSpending)}</span></div>
                </div>
              </div>
            </div>

            <div className="card card-accent p-6">
              <h3 className="font-display text-xl font-semibold mb-5 text-amber-200">Portfolio Assumptions</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                {ASSET_CLASSES.map((name, idx) => {
                  const pct = parseInt(assetAllocations[idx]) || 0;
                  if (pct === 0) return null;
                  return (
                    <div key={idx} className="text-center bg-slate-800/50 rounded-xl p-3">
                      <div className="text-xs text-slate-400 mb-1">{name}</div>
                      <div className="text-lg font-semibold text-amber-300">{pct}%</div>
                    </div>
                  );
                })}
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="text-center bg-slate-800/50 rounded-xl p-4">
                  <div className="text-sm text-slate-400 mb-1">Geometric Return</div>
                  <div className="text-xl font-semibold text-green-300">{expectedReturn.toFixed(2)}%</div>
                </div>
                <div className="text-center bg-slate-800/50 rounded-xl p-4">
                  <div className="text-sm text-slate-400 mb-1">Std Deviation</div>
                  <div className="text-xl font-semibold text-green-300">{stdDev.toFixed(2)}%</div>
                </div>
              </div>
            </div>

            <div className="card card-accent p-6">
              <h3 className="font-display text-xl font-semibold mb-5 text-amber-200">Ending Portfolio Percentiles</h3>
              <div className="grid grid-cols-6 gap-4">
                {[{l:'10th',v:results.percentileEnding.p10,c:'text-red-300'},{l:'25th',v:results.percentileEnding.p25,c:'text-orange-300'},{l:'50th',v:results.percentileEnding.p50,c:'text-amber-300'},{l:'75th',v:results.percentileEnding.p75,c:'text-green-300'},{l:'90th',v:results.percentileEnding.p90,c:'text-emerald-300'},{l:'99th',v:results.percentileEnding.p99,c:'text-cyan-300'}].map(p=>(
                  <div key={p.l} className="text-center bg-slate-800/50 rounded-xl p-4">
                    <div className="text-sm text-slate-400 mb-1">{p.l}</div>
                    <div className={`text-xl font-semibold ${p.c}`}>{formatCurrency(p.v)}</div>
                  </div>
                ))}
              </div>
            </div>

            {typeof Recharts !== 'undefined' && (
            <div className="card card-accent p-6">
              <h3 className="font-display text-xl font-semibold mb-5 text-amber-200">Portfolio Paths by Percentile</h3>
              <Recharts.ResponsiveContainer width="100%" height={350}>
                <Recharts.LineChart data={results.chartData}>
                  <Recharts.CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                  <Recharts.XAxis dataKey="year" stroke="#94a3b8" fontSize={12} />
                  <Recharts.YAxis stroke="#94a3b8" fontSize={12} tickFormatter={v => `$${(v/1000000).toFixed(1)}M`} />
                  <Recharts.Tooltip contentStyle={{background:'#1e293b',border:'1px solid #334155',borderRadius:'8px'}} formatter={v=>formatCurrency(v)} labelFormatter={l=>`Year ${l}`} />
                  <Recharts.Legend />
                  <Recharts.Line type="monotone" dataKey="p10" name="10th" stroke="#ef4444" strokeWidth={2} dot={false} />
                  <Recharts.Line type="monotone" dataKey="p25" name="25th" stroke="#f97316" strokeWidth={2} dot={false} />
                  <Recharts.Line type="monotone" dataKey="p50" name="50th (Median)" stroke="#22c55e" strokeWidth={3} dot={false} />
                  <Recharts.Line type="monotone" dataKey="p75" name="75th" stroke="#3b82f6" strokeWidth={2} dot={false} />
                  <Recharts.Line type="monotone" dataKey="p90" name="90th" stroke="#8b5cf6" strokeWidth={2} dot={false} />
                  <Recharts.Line type="monotone" dataKey="p99" name="99th" stroke="#06b6d4" strokeWidth={2} dot={false} />
                </Recharts.LineChart>
              </Recharts.ResponsiveContainer>
            </div>
            )}

            <div className="card card-accent p-6">
              <button 
                onClick={() => setVerificationOpen(!verificationOpen)} 
                className="w-full flex justify-between items-center text-left"
              >
                <h3 className="font-display text-xl font-semibold text-amber-200">🔍 Verification Details</h3>
                <span className="text-amber-200 text-2xl">{verificationOpen ? '−' : '+'}</span>
              </button>
              
              {verificationOpen && results.percentileDetails && (
                <div className="mt-5">
                  <p className="text-sm text-slate-400 mb-4">
                    This table shows the actual simulation data for a specific percentile outcome. Use this to verify the calculation logic step-by-step.
                  </p>
                  
                  <div className="flex gap-2 mb-4">
                    {[{key:'p10',label:'10th'},{key:'p25',label:'25th'},{key:'p50',label:'50th'},{key:'p75',label:'75th'},{key:'p90',label:'90th'},{key:'p99',label:'99th'}].map(p => (
                      <button 
                        key={p.key}
                        onClick={() => setVerificationPercentile(p.key)}
                        className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${verificationPercentile === p.key ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                      >
                        {p.label}
                      </button>
                    ))}
                  </div>
                  
                  <div className="flex flex-wrap gap-2 mb-4">
                    <button 
                      onClick={() => exportVerificationPDF(verificationPercentile)}
                      className="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600 transition-all"
                    >
                      📄 Export Verification Table (PDF)
                    </button>
                  </div>
                  
                  <div className="bg-slate-800/70 rounded-lg p-4 mb-4">
                    <h4 className="text-sm font-semibold text-amber-200 mb-2">Calculation Steps (each year):</h4>
                    <ol className="text-xs text-slate-400 space-y-1 list-decimal list-inside">
                      <li><strong>Start Balance</strong> = Previous year's End Balance (or initial portfolio)</li>
                      <li><strong>Calculate RMDs</strong> = Required distributions for each client age 73+</li>
                      <li><strong>After-Tax Income</strong> = Gross Income - Taxes on Income</li>
                      <li><strong>After-Tax Need</strong> = Spending + Goals - After-Tax Income (negative means excess to save)</li>
                      <li><strong>Bracket-Filling Withdrawal</strong>: RMDs first → Fill 12% bracket with Pre-Tax → Taxable → More Pre-Tax → Roth last</li>
                      <li><strong>Excess RMD/Income</strong> = If RMD or income exceeds need, after-tax excess reinvested to taxable</li>
                      <li><strong>Apply Full Year Return</strong> = All accounts grow by annual return after withdrawals</li>
                    </ol>
                  </div>
                  
                  <div className="overflow-x-auto" style={{maxHeight:'400px',overflowY:'auto'}}>
                    <table className="data-table text-xs">
                      <thead style={{position:'sticky',top:0}}>
                        <tr>
                          <th>Year</th>
                          <th>Age</th>
                          <th>Start</th>
                          <th>Return %</th>
                          <th>Spending</th>
                          <th>Goals</th>
                          <th>Income</th>
                          <th>After-Tax Income</th>
                          <th>After-Tax Need</th>
                          <th>RMD</th>
                          <th>Gross W/D</th>
                          <th>From Taxable</th>
                          <th>From PreTax</th>
                          <th>From Roth</th>
                          <th>Fed Tax</th>
                          <th>State Tax</th>
                          <th>Total Tax</th>
                          <th>Return $</th>
                          <th>End</th>
                        </tr>
                      </thead>
                      <tbody>
                        {results.percentileDetails[verificationPercentile]?.map((r, idx) => {
                          const returnDollars = (r.endBalance || 0) - (r.afterWithdrawal || 0);
                          return (
                          <tr key={idx}>
                            <td>{r.calYear}</td>
                            <td>{formatAge(r.age, r.age2, filingStatus === 'mfj')}</td>
                            <td>{formatCurrency(r.startBalance)}</td>
                            <td style={{color: r.yearReturn >= 0 ? '#4ade80' : '#f87171'}}>{(r.yearReturn * 100).toFixed(2)}%</td>
                            <td>{formatCurrency(r.yearSpending)}</td>
                            <td>{formatCurrency(r.yearGoals)}</td>
                            <td style={{color:'#4ade80'}}>{formatCurrency(r.yearIncome)}</td>
                            <td style={{color:'#4ade80'}}>{formatCurrency(r.taxDetails?.netIncome || 0)}</td>
                            <td>{formatCurrency(r.yearSpending + r.yearGoals - (r.taxDetails?.netIncome || 0))}</td>
                            <td style={{color: r.totalRMD > 0 ? '#a78bfa' : 'inherit'}}>{formatCurrency(r.totalRMD || 0)}</td>
                            <td style={{color:'#fb923c'}}>{formatCurrency(r.grossWithdrawal)}</td>
                            <td>{formatCurrency(r.fromTaxable)}</td>
                            <td>{formatCurrency(r.fromPreTax)}</td>
                            <td>{formatCurrency(r.fromRoth)}</td>
                            <td style={{color:'#f87171'}}>{formatCurrency(r.federalTax)}</td>
                            <td style={{color:'#f87171'}}>{formatCurrency(r.stateTax)}</td>
                            <td style={{color:'#f87171'}}>{formatCurrency(r.totalTax)}</td>
                            <td style={{color: returnDollars >= 0 ? '#4ade80' : '#f87171'}}>{formatCurrency(returnDollars)}</td>
                            <td style={{fontWeight:'bold'}}>{formatCurrency(r.endBalance)}</td>
                          </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                  
                  <p className="text-xs text-slate-500 mt-3">
                    Note: This is actual simulation data with random returns. The {verificationPercentile === 'p50' ? '50th' : verificationPercentile === 'p10' ? '10th' : verificationPercentile === 'p25' ? '25th' : verificationPercentile === 'p75' ? '75th' : verificationPercentile === 'p90' ? '90th' : '99th'} percentile simulation ended with {formatCurrency(results.percentileEnding[verificationPercentile])}.
                  </p>
                </div>
              )}
            </div>

            <div className="card card-accent p-6">
              <button 
                onClick={() => setTaxVerificationOpen(!taxVerificationOpen)} 
                className="w-full flex justify-between items-center text-left"
              >
                <h3 className="font-display text-xl font-semibold text-amber-200">💰 Tax Calculation Details</h3>
                <span className="text-amber-200 text-2xl">{taxVerificationOpen ? '−' : '+'}</span>
              </button>
              
              {taxVerificationOpen && results.percentileDetails && (
                <div className="mt-5">
                  <p className="text-sm text-slate-400 mb-4">
                    Detailed breakdown of tax calculations for each year. Select a year to see the full income and tax computation.
                  </p>
                  
                  <div className="flex items-center gap-4 mb-4">
                    <span className="text-sm text-slate-400">Percentile:</span>
                    <div className="flex gap-2">
                      {[{key:'p10',label:'10th'},{key:'p25',label:'25th'},{key:'p50',label:'50th'},{key:'p75',label:'75th'},{key:'p90',label:'90th'},{key:'p99',label:'99th'}].map(p => (
                        <button 
                          key={p.key}
                          onClick={() => setVerificationPercentile(p.key)}
                          className={`px-3 py-1 rounded-lg text-xs font-medium transition-all ${verificationPercentile === p.key ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                        >
                          {p.label}
                        </button>
                      ))}
                    </div>
                  </div>
                  
                  <div className="flex items-center gap-4 mb-4">
                    <span className="text-sm text-slate-400">Year:</span>
                    <select 
                      value={taxVerificationYear} 
                      onChange={e => setTaxVerificationYear(parseInt(e.target.value))}
                      className="bg-slate-700 text-white rounded-lg px-3 py-2 text-sm"
                    >
                      {results.percentileDetails[verificationPercentile]?.map((r, idx) => (
                        <option key={idx} value={idx}>{r.calYear} (Age {formatAge(r.age, r.age2, filingStatus === 'mfj')})</option>
                      ))}
                    </select>
                    <button 
                      onClick={() => exportTaxDetailsPDF(verificationPercentile, taxVerificationYear)}
                      className="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600 transition-all"
                    >
                      📄 Export This Year's Tax Details (PDF)
                    </button>
                    <button 
                      onClick={() => exportTaxTablePDF(verificationPercentile)}
                      className="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600 transition-all"
                    >
                      📄 Export Year-by-Year Tax Table (PDF)
                    </button>
                  </div>
                  
                  {(() => {
                    const yearData = results.percentileDetails[verificationPercentile]?.[taxVerificationYear];
                    if (!yearData) return null;
                    const td = yearData.taxDetails || {};
                    const filingLabel = td.filingStatus === 'single' ? 'Single' : td.filingStatus === 'mfj' ? 'Married Filing Jointly' : td.filingStatus === 'hoh' ? 'Head of Household' : filingStatus === 'mfj' ? 'Married Filing Jointly' : filingStatus === 'hoh' ? 'Head of Household' : 'Single';
                    const isSurvivor = td.filingStatus === 'single' && td.survivor;
                    
                    return (
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {isSurvivor && (
                          <div className="md:col-span-2 bg-amber-500/20 border border-amber-500/50 rounded-lg p-3">
                            <p className="text-sm text-amber-200">
                              <strong>⚠️ Survivor Year:</strong> Filing status changed to Single. {td.survivor === 'client1' ? 'Client 1' : 'Client 2'} is the surviving spouse. Deceased spouse's accounts have been inherited.
                            </p>
                          </div>
                        )}
                        
                        <div className="bg-slate-800/70 rounded-lg p-4">
                          <h4 className="text-sm font-semibold text-amber-200 mb-3 border-b border-slate-600 pb-2">📥 Income Sources <span className="text-xs font-normal text-slate-400">({filingLabel})</span></h4>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between"><span className="text-slate-400">Pre-Tax Withdrawals:</span><span className="text-white">{formatCurrency(yearData.fromPreTax)}</span></div>
                            <div className="flex justify-between pl-4 text-xs"><span className="text-slate-500">└ RMD Amount:</span><span className="text-purple-300">{formatCurrency(yearData.totalRMD)}</span></div>
                            <div className="flex justify-between"><span className="text-slate-400">Bond Interest (4% of bonds):</span><span className="text-white">{formatCurrency(td.interestIncome)}</span></div>
                            {(td.otherTaxableIncome || 0) > 0 && (
                              <div className="flex justify-between"><span className="text-slate-400">Other Taxable Income:</span><span className="text-white">{formatCurrency(td.otherTaxableIncome)}</span></div>
                            )}
                            {(td.socialSecurityIncome || 0) > 0 && (
                              <>
                                <div className="flex justify-between"><span className="text-slate-400">Social Security Income:</span><span className="text-white">{formatCurrency(td.socialSecurityIncome)}</span></div>
                                <div className="flex justify-between pl-4 text-xs"><span className="text-slate-500">└ Taxable Portion:</span><span className="text-yellow-300">{formatCurrency(td.taxableSocialSecurity)} ({td.socialSecurityIncome > 0 ? ((td.taxableSocialSecurity / td.socialSecurityIncome) * 100).toFixed(0) : 0}%)</span></div>
                                
                                {/* Social Security Calculation Details */}
                                <div className="mt-2 ml-4 p-2 bg-slate-900/50 rounded text-xs">
                                  <div className="text-slate-500 font-medium mb-1">SS Taxable Calculation:</div>
                                  <div className="flex justify-between"><span className="text-slate-500">Pre-Tax Withdrawals:</span><span className="text-slate-400">{formatCurrency(yearData.fromPreTax)}</span></div>
                                  <div className="flex justify-between"><span className="text-slate-500">+ Other Income:</span><span className="text-slate-400">{formatCurrency(td.otherTaxableIncome || 0)}</span></div>
                                  <div className="flex justify-between"><span className="text-slate-500">+ Interest Income:</span><span className="text-slate-400">{formatCurrency(td.interestIncome || 0)}</span></div>
                                  <div className="flex justify-between"><span className="text-slate-500">+ Qualified Dividends:</span><span className="text-slate-400">{formatCurrency(td.qualifiedDividends || 0)}</span></div>
                                  <div className="flex justify-between"><span className="text-slate-500">+ 50% of SS Benefits:</span><span className="text-slate-400">{formatCurrency(td.socialSecurityIncome * 0.5)}</span></div>
                                  <div className="flex justify-between border-t border-slate-700 mt-1 pt-1"><span className="text-slate-400 font-medium">= Provisional Income:</span><span className="text-amber-300">{formatCurrency(td.provisionalIncome || 0)}</span></div>
                                  <div className="mt-2 text-slate-500">
                                    <div>Thresholds ({td.filingStatus === 'mfj' ? 'MFJ' : 'Single'}):</div>
                                    <div className="flex justify-between pl-2"><span>Base (50% taxable above):</span><span>{formatCurrency(td.ssBaseThreshold)}</span></div>
                                    <div className="flex justify-between pl-2"><span>Upper (85% taxable above):</span><span>{formatCurrency(td.ssUpperThreshold)}</span></div>
                                  </div>
                                  <div className="mt-2 flex justify-between border-t border-slate-700 pt-1">
                                    <span className="text-slate-400">Result:</span>
                                    <span className="text-yellow-300">
                                      {td.provisionalIncome <= td.ssBaseThreshold ? '0% taxable (below base threshold)' :
                                       td.provisionalIncome <= td.ssUpperThreshold ? `Up to 50% taxable` :
                                       `Up to 85% taxable`}
                                    </span>
                                  </div>
                                </div>
                              </>
                            )}
                            {(td.taxFreeIncome || 0) > 0 && (
                              <div className="flex justify-between"><span className="text-slate-400">Tax-Free Income:</span><span className="text-green-300">{formatCurrency(td.taxFreeIncome)}</span></div>
                            )}
                            <div className="flex justify-between border-t border-slate-600 pt-2 mt-2"><span className="text-slate-300 font-medium">Total Ordinary Income:</span><span className="text-amber-200 font-medium">{formatCurrency(yearData.fromPreTax + (td.interestIncome || 0) + (td.otherTaxableIncome || 0) + (td.taxableSocialSecurity || 0))}</span></div>
                            <div className="flex justify-between"><span className="text-slate-400">Less: Standard Deduction:</span><span className="text-green-300">-{formatCurrency(td.standardDeduction)}</span></div>
                            <div className="flex justify-between border-t border-slate-600 pt-2"><span className="text-slate-300 font-medium">Taxable Ordinary Income:</span><span className="text-amber-200 font-medium">{formatCurrency(td.taxableOrdinaryIncome)}</span></div>
                          </div>
                        </div>
                        
                        <div className="bg-slate-800/70 rounded-lg p-4">
                          <h4 className="text-sm font-semibold text-amber-200 mb-3 border-b border-slate-600 pb-2">📈 Capital Gains & Dividends</h4>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between"><span className="text-slate-400">Taxable Account Withdrawal:</span><span className="text-white">{formatCurrency(yearData.fromTaxable)}</span></div>
                            <div className="flex justify-between pl-4 text-xs"><span className="text-slate-500">└ Gain Portion (taxable):</span><span className="text-yellow-300">{formatCurrency(td.taxableWithdrawalGains)}</span></div>
                            <div className="flex justify-between"><span className="text-slate-400">Qualified Dividends (1% of stocks):</span><span className="text-white">{formatCurrency(td.qualifiedDividends)}</span></div>
                            <div className="flex justify-between border-t border-slate-600 pt-2 mt-2"><span className="text-slate-300 font-medium">Total Capital Gains:</span><span className="text-amber-200 font-medium">{formatCurrency(td.totalCapitalGains)}</span></div>
                            <div className="flex justify-between mt-4"><span className="text-slate-400">Roth Withdrawals (tax-free):</span><span className="text-green-300">{formatCurrency(yearData.fromRoth)}</span></div>
                          </div>
                        </div>
                        
                        <div className="bg-slate-800/70 rounded-lg p-4">
                          <h4 className="text-sm font-semibold text-amber-200 mb-3 border-b border-slate-600 pb-2">🏛️ Federal Tax Calculation</h4>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between"><span className="text-slate-400">Tax on Ordinary Income:</span><span className="text-red-300">{formatCurrency(td.federalOrdinaryTax)}</span></div>
                            <div className="flex justify-between"><span className="text-slate-400">Tax on Capital Gains:</span><span className="text-red-300">{formatCurrency(td.federalCapGainsTax)}</span></div>
                            {(td.niitTax || 0) > 0 && (
                              <div className="flex justify-between"><span className="text-slate-400">Net Investment Income Tax (3.8%):</span><span className="text-red-300">{formatCurrency(td.niitTax)}</span></div>
                            )}
                            <div className="flex justify-between border-t border-slate-600 pt-2 mt-2"><span className="text-slate-300 font-medium">Total Federal Tax:</span><span className="text-red-400 font-medium">{formatCurrency(yearData.federalTax)}</span></div>
                          </div>
                        </div>
                        
                        <div className="bg-slate-800/70 rounded-lg p-4">
                          <h4 className="text-sm font-semibold text-amber-200 mb-3 border-b border-slate-600 pb-2">📊 Tax Summary</h4>
                          <div className="space-y-2 text-sm">
                            {(yearData.yearIncome || 0) > 0 && (
                              <>
                                <div className="flex justify-between"><span className="text-slate-400">Gross Income:</span><span className="text-green-300">{formatCurrency(yearData.yearIncome)}</span></div>
                                <div className="flex justify-between"><span className="text-slate-300 font-medium">Net After-Tax Income:</span><span className="text-green-400 font-medium">{formatCurrency(td.netIncome || 0)}</span></div>
                                {(td.excessIncome || 0) > 0 && (
                                  <div className="flex justify-between pl-4 text-xs"><span className="text-slate-500">└ Excess Saved to Taxable:</span><span className="text-blue-300">{formatCurrency(td.excessIncome)}</span></div>
                                )}
                                <div className="border-t border-slate-600 pt-2 mt-2"></div>
                              </>
                            )}
                            <div className="flex justify-between"><span className="text-slate-400">Gross Withdrawal:</span><span className="text-orange-300">{formatCurrency(yearData.grossWithdrawal)}</span></div>
                            <div className="flex justify-between"><span className="text-slate-400">+ Gross Income:</span><span className="text-green-300">{formatCurrency(yearData.yearIncome || 0)}</span></div>
                            <div className="flex justify-between border-t border-slate-600 pt-1"><span className="text-slate-300">Total Cash In:</span><span className="text-white">{formatCurrency(yearData.grossWithdrawal + (yearData.yearIncome || 0))}</span></div>
                            <div className="flex justify-between mt-2"><span className="text-slate-400">Federal Tax:</span><span className="text-red-300">-{formatCurrency(yearData.federalTax)}</span></div>
                            <div className="flex justify-between"><span className="text-slate-400">State Tax:</span><span className="text-red-300">-{formatCurrency(yearData.stateTax)}</span></div>
                            <div className="flex justify-between border-t border-slate-600 pt-1"><span className="text-slate-300 font-medium">Total Tax:</span><span className="text-red-400 font-medium">-{formatCurrency(yearData.totalTax)}</span></div>
                            <div className="flex justify-between border-t border-slate-600 pt-2 mt-2"><span className="text-slate-300 font-medium">Net After-Tax Cash:</span><span className="text-green-400 font-medium">{formatCurrency(yearData.grossWithdrawal + (yearData.yearIncome || 0) - yearData.totalTax)}</span></div>
                            <div className="flex justify-between mt-2"><span className="text-slate-500 text-xs">Effective Tax Rate:</span><span className="text-slate-400 text-xs">{(yearData.grossWithdrawal + (yearData.yearIncome || 0)) > 0 ? ((yearData.totalTax / (yearData.grossWithdrawal + (yearData.yearIncome || 0))) * 100).toFixed(1) : 0}%</span></div>
                          </div>
                        </div>
                        
                        <div className="md:col-span-2 bg-slate-800/70 rounded-lg p-4">
                          <h4 className="text-sm font-semibold text-amber-200 mb-3 border-b border-slate-600 pb-2">📋 Tax Brackets ({yearData.calYear})</h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <h5 className="text-xs font-semibold text-slate-300 mb-2">Ordinary Income Brackets</h5>
                              <table className="w-full text-xs">
                                <thead>
                                  <tr className="text-slate-400">
                                    <th className="text-left py-1">Rate</th>
                                    <th className="text-right py-1">From</th>
                                    <th className="text-right py-1">To</th>
                                    <th className="text-center py-1">Status</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {td.ordinaryBrackets?.map((bracket, i) => {
                                    const taxableIncome = td.taxableOrdinaryIncome || 0;
                                    const isCurrentBracket = taxableIncome > bracket.min && (i === td.ordinaryBrackets.length - 1 || taxableIncome <= bracket.max);
                                    const isBelow = taxableIncome <= bracket.min;
                                    const isAbove = taxableIncome > bracket.max;
                                    return (
                                      <tr key={i} className={isCurrentBracket ? 'bg-amber-500/20' : ''}>
                                        <td className="py-1" style={{color: isCurrentBracket ? '#fbbf24' : '#94a3b8'}}>{(bracket.rate * 100).toFixed(0)}%</td>
                                        <td className="text-right py-1">{formatCurrency(bracket.min)}</td>
                                        <td className="text-right py-1">{bracket.max === Infinity ? '∞' : formatCurrency(bracket.max)}</td>
                                        <td className="text-center py-1">
                                          {isCurrentBracket && <span className="text-amber-400">◄ Current</span>}
                                          {isAbove && <span className="text-green-400">✓</span>}
                                        </td>
                                      </tr>
                                    );
                                  })}
                                </tbody>
                              </table>
                              <p className="text-xs text-slate-500 mt-2">Taxable Income: <span className="text-amber-300">{formatCurrency(td.taxableOrdinaryIncome || 0)}</span></p>
                            </div>
                            
                            <div>
                              <h5 className="text-xs font-semibold text-slate-300 mb-2">Capital Gains Brackets</h5>
                              <table className="w-full text-xs">
                                <thead>
                                  <tr className="text-slate-400">
                                    <th className="text-left py-1">Rate</th>
                                    <th className="text-right py-1">From</th>
                                    <th className="text-right py-1">To</th>
                                    <th className="text-center py-1">Status</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {td.capGainsBrackets?.map((bracket, i) => {
                                    const totalIncome = (td.taxableOrdinaryIncome || 0) + (td.totalCapitalGains || 0);
                                    const isCurrentBracket = totalIncome > bracket.min && (i === td.capGainsBrackets.length - 1 || totalIncome <= bracket.max);
                                    const isBelow = totalIncome <= bracket.min;
                                    const isAbove = totalIncome > bracket.max;
                                    return (
                                      <tr key={i} className={isCurrentBracket ? 'bg-amber-500/20' : ''}>
                                        <td className="py-1" style={{color: isCurrentBracket ? '#fbbf24' : '#94a3b8'}}>{(bracket.rate * 100).toFixed(0)}%</td>
                                        <td className="text-right py-1">{formatCurrency(bracket.min)}</td>
                                        <td className="text-right py-1">{bracket.max === Infinity ? '∞' : formatCurrency(bracket.max)}</td>
                                        <td className="text-center py-1">
                                          {isCurrentBracket && <span className="text-amber-400">◄ Current</span>}
                                          {isAbove && <span className="text-green-400">✓</span>}
                                        </td>
                                      </tr>
                                    );
                                  })}
                                </tbody>
                              </table>
                              <p className="text-xs text-slate-500 mt-2">Total Income (for CG brackets): <span className="text-amber-300">{formatCurrency((td.taxableOrdinaryIncome || 0) + (td.totalCapitalGains || 0))}</span></p>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                  
                  <div className="mt-6">
                    <h4 className="text-sm font-semibold text-amber-200 mb-3">Year-by-Year Tax Summary Table</h4>
                    <div className="overflow-x-auto" style={{maxHeight:'400px',overflowY:'auto'}}>
                      <table className="data-table text-xs">
                        <thead style={{position:'sticky',top:0}}>
                          <tr>
                            <th>Year</th>
                            <th>Age</th>
                            <th>Filing</th>
                            <th>Bracket</th>
                            <th>Income</th>
                            <th>Other Inc</th>
                            <th>SS Inc</th>
                            <th>Tax SS</th>
                            <th>RMD</th>
                            <th>From PreTax</th>
                            <th>From Taxable</th>
                            <th>From Roth</th>
                            <th>Interest</th>
                            <th>Dividends</th>
                            <th>Cap Gains</th>
                            <th>Std Ded</th>
                            <th>Taxable Inc</th>
                            <th>Fed Ord Tax</th>
                            <th>Fed CG Tax</th>
                            <th>State Tax</th>
                            <th>Total Tax</th>
                            <th>Eff Rate</th>
                          </tr>
                        </thead>
                        <tbody>
                          {results.percentileDetails[verificationPercentile]?.map((r, idx) => {
                            const td = r.taxDetails || {};
                            const totalCashIn = r.grossWithdrawal + (r.yearIncome || 0);
                            const effRate = totalCashIn > 0 ? ((r.totalTax / totalCashIn) * 100).toFixed(1) : '0.0';
                            const filingLabel = td.filingStatus === 'single' ? (td.survivor ? 'Single*' : 'Single') : td.filingStatus === 'mfj' ? 'MFJ' : td.filingStatus === 'hoh' ? 'HoH' : filingStatus === 'mfj' ? 'MFJ' : filingStatus === 'hoh' ? 'HoH' : 'Single';
                            const isSurvivor = td.filingStatus === 'single' && td.survivor;
                            // Determine current tax bracket
                            const taxableIncome = td.taxableOrdinaryIncome || 0;
                            let currentBracket = '0%';
                            if (td.ordinaryBrackets) {
                              for (let i = td.ordinaryBrackets.length - 1; i >= 0; i--) {
                                if (taxableIncome > td.ordinaryBrackets[i].min) {
                                  currentBracket = (td.ordinaryBrackets[i].rate * 100).toFixed(0) + '%';
                                  break;
                                }
                              }
                            }
                            return (
                              <tr key={idx} onClick={() => setTaxVerificationYear(idx)} style={{cursor:'pointer'}} className={taxVerificationYear === idx ? 'bg-amber-500/20' : ''}>
                                <td>{r.calYear}</td>
                                <td>{formatAge(r.age, r.age2, filingStatus === 'mfj')}</td>
                                <td style={{color: isSurvivor ? '#f59e0b' : 'inherit'}}>{filingLabel}</td>
                                <td style={{color:'#fbbf24',fontWeight:'bold'}}>{currentBracket}</td>
                                <td style={{color:'#4ade80'}}>{formatCurrency(r.yearIncome || 0)}</td>
                                <td>{formatCurrency(td.otherTaxableIncome || 0)}</td>
                                <td style={{color:'#60a5fa'}}>{formatCurrency(td.socialSecurityIncome || 0)}</td>
                                <td style={{color:'#f59e0b'}}>{formatCurrency(td.taxableSocialSecurity || 0)}</td>
                                <td style={{color: r.totalRMD > 0 ? '#a78bfa' : 'inherit'}}>{formatCurrency(r.totalRMD || 0)}</td>
                                <td>{formatCurrency(r.fromPreTax)}</td>
                                <td>{formatCurrency(r.fromTaxable)}</td>
                                <td style={{color:'#4ade80'}}>{formatCurrency(r.fromRoth)}</td>
                                <td>{formatCurrency(td.interestIncome || 0)}</td>
                                <td>{formatCurrency(td.qualifiedDividends || 0)}</td>
                                <td style={{color:'#fbbf24'}}>{formatCurrency(td.totalCapitalGains || 0)}</td>
                                <td style={{color:'#4ade80'}}>{formatCurrency(td.standardDeduction || 0)}</td>
                                <td>{formatCurrency(td.taxableOrdinaryIncome || 0)}</td>
                                <td style={{color:'#f87171'}}>{formatCurrency(td.federalOrdinaryTax || 0)}</td>
                                <td style={{color:'#f87171'}}>{formatCurrency(td.federalCapGainsTax || 0)}</td>
                                <td style={{color:'#f87171'}}>{formatCurrency(r.stateTax)}</td>
                                <td style={{color:'#f87171',fontWeight:'bold'}}>{formatCurrency(r.totalTax)}</td>
                                <td style={{color:'#fb923c'}}>{effRate}%</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                    <p className="text-xs text-slate-500 mt-2">Click any row to see detailed breakdown above.</p>
                  </div>
                  
                  <div className="bg-slate-800/50 rounded-lg p-3 mt-4">
                    <p className="text-xs text-slate-500">
                      <strong>Tax Logic:</strong> RMDs are taken first (required at age 73+). Then the 12% bracket is filled with additional pre-tax withdrawals. 
                      Taxable account withdrawals follow (capital gains may be at 0% if income is low). More pre-tax if needed. Roth is withdrawn last to preserve tax-free growth.
                      Qualified dividends and capital gains are taxed at 0%/15%/20% based on total taxable income.
                    </p>
                    <p className="text-xs text-slate-500 mt-2">
                      <strong>Survivor Years (MFJ):</strong> When one spouse's plan ends, filing status switches to Single with reduced brackets and standard deduction. 
                      The deceased spouse's accounts are inherited by the survivor. Years marked "Single*" in the table indicate survivor years.
                    </p>
                  </div>
                </div>
              )}
            </div>

            <div className="card card-accent p-6">
              <button 
                onClick={() => setAccountBalancesOpen(!accountBalancesOpen)} 
                className="w-full flex justify-between items-center text-left"
              >
                <h3 className="font-display text-xl font-semibold text-amber-200">📊 Account Balances Over Time</h3>
                <span className="text-amber-200 text-2xl">{accountBalancesOpen ? '−' : '+'}</span>
              </button>
              
              {accountBalancesOpen && results.percentileDetails && (
                <div className="mt-5">
                  <p className="text-sm text-slate-400 mb-4">
                    Track how each account type (Pre-Tax, Roth, Taxable) changes over time. Select a percentile to see the account breakdown for that simulation outcome.
                    <br/><em>Note: These percentiles are based on ending portfolio value (affected by withdrawals and sequence of returns).</em>
                  </p>
                  
                  <div className="flex items-center gap-4 mb-4">
                    <span className="text-sm text-slate-400">Percentile:</span>
                    <div className="flex gap-2">
                      {[{key:'p10',label:'10th'},{key:'p25',label:'25th'},{key:'p50',label:'50th'},{key:'p75',label:'75th'},{key:'p90',label:'90th'},{key:'p99',label:'99th'}].map(p => (
                        <button 
                          key={p.key}
                          onClick={() => setAccountBalancesPercentile(p.key)}
                          className={`px-3 py-1 rounded-lg text-xs font-medium transition-all ${accountBalancesPercentile === p.key ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                        >
                          {p.label}
                        </button>
                      ))}
                    </div>
                    <button 
                      onClick={() => exportAccountBalancesPDF(accountBalancesPercentile)}
                      className="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600 transition-all ml-auto"
                    >
                      📄 Export Account Balances (PDF)
                    </button>
                  </div>
                  
                  {(() => {
                    const details = results.percentileDetails[accountBalancesPercentile];
                    if (!details || details.length === 0) return null;
                    
                    // Build chart data from detailed path
                    const chartData = details.map((d, idx) => ({
                      year: d.calYear,
                      preTax: d.endPreTax || 0,
                      roth: d.endRoth || 0,
                      taxable: d.endTaxable || 0,
                      total: d.endBalance || 0
                    }));
                    
                    // Add initial balances at year 0
                    const initialData = {
                      year: currentYear,
                      preTax: preTaxBalance,
                      roth: rothBalance,
                      taxable: taxableBalance,
                      total: preTaxBalance + rothBalance + taxableBalance
                    };
                    const fullChartData = [initialData, ...chartData];
                    
                    return (
                      <div>
                        <div className="bg-slate-800/50 rounded-lg p-4 mb-4" style={{height:'350px'}}>
                          <Recharts.ResponsiveContainer width="100%" height="100%">
                            <Recharts.AreaChart data={fullChartData} margin={{top:10,right:30,left:20,bottom:5}}>
                              <Recharts.CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                              <Recharts.XAxis dataKey="year" stroke="#94a3b8" fontSize={12} />
                              <Recharts.YAxis stroke="#94a3b8" fontSize={12} tickFormatter={v => `$${(v/1000000).toFixed(1)}M`} />
                              <Recharts.Tooltip 
                                contentStyle={{background:'#1e293b',border:'1px solid #334155',borderRadius:'8px'}} 
                                formatter={(v, name) => [formatCurrency(v), name]}
                                labelFormatter={l => `Year ${l}`}
                              />
                              <Recharts.Legend />
                              <Recharts.Area type="monotone" dataKey="preTax" name="Pre-Tax" stackId="1" stroke="#f97316" fill="#f97316" fillOpacity={0.6} />
                              <Recharts.Area type="monotone" dataKey="roth" name="Roth" stackId="1" stroke="#22c55e" fill="#22c55e" fillOpacity={0.6} />
                              <Recharts.Area type="monotone" dataKey="taxable" name="Taxable" stackId="1" stroke="#3b82f6" fill="#3b82f6" fillOpacity={0.6} />
                            </Recharts.AreaChart>
                          </Recharts.ResponsiveContainer>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-4 mb-4">
                          <div className="bg-slate-800/70 rounded-lg p-3 text-center">
                            <div className="text-xs text-slate-400 mb-1">Starting Pre-Tax</div>
                            <div className="text-lg font-semibold text-orange-400">{formatCurrency(preTaxBalance)}</div>
                          </div>
                          <div className="bg-slate-800/70 rounded-lg p-3 text-center">
                            <div className="text-xs text-slate-400 mb-1">Starting Roth</div>
                            <div className="text-lg font-semibold text-green-400">{formatCurrency(rothBalance)}</div>
                          </div>
                          <div className="bg-slate-800/70 rounded-lg p-3 text-center">
                            <div className="text-xs text-slate-400 mb-1">Starting Taxable</div>
                            <div className="text-lg font-semibold text-blue-400">{formatCurrency(taxableBalance)}</div>
                          </div>
                        </div>
                        
                        <div className="overflow-x-auto" style={{maxHeight:'350px',overflowY:'auto'}}>
                          <table className="data-table text-xs">
                            <thead style={{position:'sticky',top:0}}>
                              <tr>
                                <th>Year</th>
                                <th>Age</th>
                                <th>Pre-Tax</th>
                                <th>Roth</th>
                                <th>Taxable</th>
                                <th>Total</th>
                                <th>Pre-Tax %</th>
                                <th>Roth %</th>
                                <th>Taxable %</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr className="bg-slate-700/30">
                                <td>{currentYear}</td>
                                <td>{formatAge(client1Age, filingStatus === 'mfj' ? client2Age : 0, filingStatus === 'mfj')}</td>
                                <td style={{color:'#f97316'}}>{formatCurrency(preTaxBalance)}</td>
                                <td style={{color:'#22c55e'}}>{formatCurrency(rothBalance)}</td>
                                <td style={{color:'#3b82f6'}}>{formatCurrency(taxableBalance)}</td>
                                <td style={{fontWeight:'bold'}}>{formatCurrency(preTaxBalance + rothBalance + taxableBalance)}</td>
                                <td>{((preTaxBalance / (preTaxBalance + rothBalance + taxableBalance)) * 100).toFixed(1)}%</td>
                                <td>{((rothBalance / (preTaxBalance + rothBalance + taxableBalance)) * 100).toFixed(1)}%</td>
                                <td>{((taxableBalance / (preTaxBalance + rothBalance + taxableBalance)) * 100).toFixed(1)}%</td>
                              </tr>
                              {details.map((d, idx) => {
                                const total = d.endBalance || 0;
                                const preTaxPct = total > 0 ? ((d.endPreTax || 0) / total * 100).toFixed(1) : '0.0';
                                const rothPct = total > 0 ? ((d.endRoth || 0) / total * 100).toFixed(1) : '0.0';
                                const taxablePct = total > 0 ? ((d.endTaxable || 0) / total * 100).toFixed(1) : '0.0';
                                return (
                                  <tr key={idx}>
                                    <td>{d.calYear}</td>
                                    <td>{formatAge(d.age, d.age2, filingStatus === 'mfj')}</td>
                                    <td style={{color:'#f97316'}}>{formatCurrency(d.endPreTax || 0)}</td>
                                    <td style={{color:'#22c55e'}}>{formatCurrency(d.endRoth || 0)}</td>
                                    <td style={{color:'#3b82f6'}}>{formatCurrency(d.endTaxable || 0)}</td>
                                    <td style={{fontWeight:'bold'}}>{formatCurrency(total)}</td>
                                    <td>{preTaxPct}%</td>
                                    <td>{rothPct}%</td>
                                    <td>{taxablePct}%</td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                        
                        <div className="bg-slate-800/50 rounded-lg p-3 mt-4">
                          <p className="text-xs text-slate-500">
                            <strong>Withdrawal Order:</strong> The bracket-filling strategy prioritizes: 1) RMDs (required), 2) Fill 12% bracket with Pre-Tax,
                            3) Taxable (capital gains may be 0%), 4) Additional Pre-Tax if needed, 5) Roth last (preserves tax-free growth).
                            This explains why Pre-Tax typically depletes faster than Roth.
                          </p>
                        </div>
                      </div>
                    );
                  })()}
                </div>
              )}
            </div>

            {/* Return Distribution Section */}
            <div className="card card-accent p-6">
              <button
                onClick={() => setReturnDistributionOpen(!returnDistributionOpen)}
                className="w-full flex justify-between items-center text-left"
              >
                <h3 className="font-display text-xl font-semibold text-amber-200">📈 Return Distribution (Pure Market Returns)</h3>
                <span className="text-amber-200 text-2xl">{returnDistributionOpen ? '−' : '+'}</span>
              </button>

              {returnDistributionOpen && results.returnPercentileDetails && (
                <div className="mt-5">
                  <p className="text-sm text-slate-400 mb-4">
                    These percentiles are based on compound annual growth rate (CAGR) of pure market returns, independent of withdrawals or sequence of returns.
                    Use this to validate that simulated returns match expected distributions.
                  </p>

                  {/* Summary of all percentiles */}
                  <div className="grid grid-cols-7 gap-2 mb-6">
                    {[{key:'p1',label:'1st'},{key:'p10',label:'10th'},{key:'p25',label:'25th'},{key:'p50',label:'50th'},{key:'p75',label:'75th'},{key:'p90',label:'90th'},{key:'p99',label:'99th'}].map(p => (
                      <div key={p.key} className={`bg-slate-800/70 rounded-lg p-3 text-center cursor-pointer transition-all ${returnDistributionPercentile === p.key ? 'ring-2 ring-amber-500' : 'hover:bg-slate-700/70'}`} onClick={() => setReturnDistributionPercentile(p.key)}>
                        <div className="text-xs text-slate-400 mb-1">{p.label}</div>
                        <div className={`text-lg font-semibold ${results.returnPercentiles[p.key] >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                          {(results.returnPercentiles[p.key] * 100).toFixed(2)}%
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* Detailed view for selected percentile */}
                  {(() => {
                    const detail = results.returnPercentileDetails[returnDistributionPercentile];
                    if (!detail) return null;

                    const percentileLabel = returnDistributionPercentile === 'p1' ? '1st' : returnDistributionPercentile === 'p10' ? '10th' : returnDistributionPercentile === 'p25' ? '25th' : returnDistributionPercentile === 'p50' ? '50th' : returnDistributionPercentile === 'p75' ? '75th' : returnDistributionPercentile === 'p90' ? '90th' : '99th';

                    return (
                      <div>
                        <h4 className="text-lg font-semibold text-amber-200 mb-3">{percentileLabel} Percentile Simulation Details</h4>

                        {/* Statistics */}
                        <div className="grid grid-cols-3 gap-4 mb-4">
                          <div className="bg-slate-800/70 rounded-lg p-3 text-center">
                            <div className="text-xs text-slate-400 mb-1">CAGR</div>
                            <div className={`text-xl font-semibold ${detail.cagr >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                              {(detail.cagr * 100).toFixed(2)}%
                            </div>
                          </div>
                          <div className="bg-slate-800/70 rounded-lg p-3 text-center">
                            <div className="text-xs text-slate-400 mb-1">Arithmetic Mean</div>
                            <div className={`text-xl font-semibold ${detail.arithmeticMean >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                              {(detail.arithmeticMean * 100).toFixed(2)}%
                            </div>
                          </div>
                          <div className="bg-slate-800/70 rounded-lg p-3 text-center">
                            <div className="text-xs text-slate-400 mb-1">Std Deviation</div>
                            <div className="text-xl font-semibold text-blue-400">
                              {(detail.stdDev * 100).toFixed(2)}%
                            </div>
                          </div>
                        </div>

                        {/* Year-by-year table */}
                        <div className="overflow-x-auto" style={{maxHeight:'400px',overflowY:'auto'}}>
                          <table className="data-table text-xs">
                            <thead style={{position:'sticky',top:0}}>
                              <tr>
                                <th>Year</th>
                                <th>Calendar Year</th>
                                <th>Annual Return</th>
                                <th>CAGR to Date</th>
                              </tr>
                            </thead>
                            <tbody>
                              {detail.yearByYear.map((d, idx) => (
                                <tr key={idx}>
                                  <td>{d.year + 1}</td>
                                  <td>{d.calYear}</td>
                                  <td className={d.annualReturn >= 0 ? 'text-green-400' : 'text-red-400'}>
                                    {(d.annualReturn * 100).toFixed(2)}%
                                  </td>
                                  <td className={d.cagrToDate >= 0 ? 'text-green-400' : 'text-red-400'}>
                                    {(d.cagrToDate * 100).toFixed(2)}%
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>

                        <div className="bg-slate-800/50 rounded-lg p-3 mt-4">
                          <p className="text-xs text-slate-500">
                            <strong>Note:</strong> These are pure market returns from the simulation, calculated as CAGR = [(1+r₁)(1+r₂)...(1+rₙ)]^(1/n) - 1.
                            The percentiles are sorted by CAGR, not by ending portfolio value. This allows you to verify that return distributions match your expected geometric means and volatilities.
                          </p>
                        </div>
                      </div>
                    );
                  })()}
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
